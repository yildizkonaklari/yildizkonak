<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Ayvalık Yıldız Konakları - Aidat Takip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f4f8; color: #333; }
    .container { max-width: 900px; margin: auto; background: #fff8f0; padding: 20px; margin-top: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1, h2, h3, h4 { text-align: center; color: #014f86; }
    input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; }
    button { background-color: #468faf; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #014f86; }
    button:disabled { background-color: #ccc; cursor: not-allowed; } /* Devre dışı buton stili */
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #dbe9f4; }
    .totals { margin-top: 20px; font-weight: bold; color: #014f86; }
    .delete-btn { background-color: #dc3545; }
    .delete-btn:hover { background-color: #c82333; }
    .edit-btn { background-color: #ffc107; color: #333; }
    .edit-btn:hover { background-color: #e0a800; }
    .download-btn, .backup-btn { background-color: #28a745; }
    .download-btn:hover, .backup-btn:hover { background-color: #218838; }
    .upload-btn { background-color: #17a2b8; }
    .upload-btn:hover { background-color: #138496; }
    .message { text-align: center; color: green; margin-top: 10px; }
    .error-message { text-align: center; color: red; margin-top: 10px; }
    .bank-info { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px dashed #ccc; font-size: 0.9em; color: #555; }
    .section-divider { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; }
    .unpaid-debt { color: #dc3545; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ayvalık Yıldız Konakları</h1>
    <h2>Aidat Takip Sistemi</h2>

    <div id="login">
      <h3>Giriş Yap</h3>
      <input type="text" id="username" placeholder="Kullanıcı Adı (örn: A1)">
      <input type="password" id="password" placeholder="Şifre (örn: 1234)">
      <button id="loginButton" onclick="login()" disabled>Giriş</button>
      <div id="loginMessage" class="message hidden"></div>
    </div>

    <div id="userPanel" class="hidden">
      <h3>Hoş Geldiniz, <span id="userNameDisplay"></span></h3>
      <h4>Borçlarınız</h4>
      <table id="userTable">
        <tr><th>Ay</th><th>Tip</th><th>Tutar</th><th>Durum</th></tr>
      </table>
      <div class="totals" id="userDebtTotals"></div>
      <div class="bank-info">
        <p><strong>Yıldız Konakları Site Yönetimi</strong></p>
        <p><strong>IBAN:</strong> TR510001000110981102095001</p>
      </div>
      <button onclick="logout()">Çıkış Yap</button>
    </div>

    <div id="adminPanel" class="hidden">
      <h3>Yönetici Paneli</h3>
      <input type="number" id="aidatTutariInput" placeholder="Yeni Aidat Tutarı (₺)">
      <button onclick="updateAidatTutari()">Aidat Tutarını Güncelle ve Tüm Dairelere Ekle</button>
      <div id="aidatMessage" class="message hidden"></div>

      <div class="section-divider"></div>
      <h4>Tüm Dairelere Avans Ekle</h4>
      <input type="number" id="avansTutariInput" placeholder="Avans Tutarı (₺)">
      <button onclick="addAdvanceToAll()">Tüm Dairelere Avans Ekle</button>
      <div id="avansMessage" class="message hidden"></div>


      <div class="section-divider"></div>
      <h4>Yeni Borç Ekle</h4>
      <select id="borcTipi">
        <option value="aidat">Aidat</option>
        <option value="avans">Avans</option>
      </select>
      <input type="text" id="borcAy" placeholder="Ay (örn: Temmuz 2025)">
      <input type="number" id="borcTutar" placeholder="Tutar (₺)">
      <select id="borcKime"></select>
      <button onclick="ekleBorc()">Borç Ekle</button>
      <div id="addDebtMessage" class="message hidden"></div>


      <div class="section-divider"></div>
      <h4>Daire ve Yönetici Şifre Ayarla</h4>
      <h5>Daire Şifresi Ayarla</h5>
      <select id="sifreDaire"></select>
      <input type="password" id="yeniSifre" placeholder="Yeni Daire Şifresi">
      <button onclick="sifreAyarla()">Daire Şifresini Kaydet</button>
      <div id="passwordMessage" class="message hidden"></div>

      <h5 style="margin-top: 20px;">Yönetici Şifresi Ayarla</h5>
      <input type="password" id="adminYeniSifre" placeholder="Yeni Yönetici Şifresi">
      <button onclick="setAdminPassword()">Yönetici Şifresini Kaydet</button>
      <div id="adminPasswordMessage" class="message hidden"></div>


      <div class="section-divider"></div>
      <h4>Daire Borç Listesi</h4>
      <select id="flatSelect" onchange="loadAdminTable()"></select>
      <table id="adminTable">
        <tr><th>Ay</th><th>Tip</th><th>Tutar</th><th>Durum</th><th>İşlem</th></tr>
      </table>
      <div class="totals" id="borcToplam"></div>
      <div id="adminTableMessage" class="message hidden"></div>
      <button class="download-btn" onclick="downloadAllDebtsCsv()">Tüm Borçları Excel Olarak İndir</button>
      
      <div class="section-divider"></div>
      <h4>Yedekleme ve Geri Yükleme</h4>
      <button class="backup-btn" onclick="backupData()">Verileri Yedekle (Bilgisayara İndir)</button>
      <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="restoreData(event)">
      <button class="upload-btn" onclick="document.getElementById('backupFileInput').click()">Yedekten Yükle (Dosya Seç)</button>
      <div id="backupRestoreMessage" class="message hidden"></div>

      <div class="section-divider"></div>
      <button class="delete-btn" onclick="deleteAllDebts()">Tüm Dairelerin Tüm Borçlarını Sil</button>
      <button onclick="logout()">Çıkış Yap</button>
    </div>
  </div>

  <script type="module">
    // --- Firebase SDK Importları ve Başlangıç ---
    // !!! BURADAKİ SÜRÜMÜ KENDİ FIREBASE KONSOLUNUZDAKİ GÜNCEL SÜRÜMLE DEĞİŞTİRİNİZ !!!
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"; 
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      doc, 
      setDoc, 
      addDoc, 
      deleteDoc, 
      updateDoc, 
      getDoc, 
      query, 
      where,
      writeBatch 
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js"; 
    // import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"; // STORAGE KALDIRILDI

    // !!! BURADAKİ firebaseConfig OBJESİNİ KENDİ FIREBASE KONSOLUNUZDAN ALDIĞINIZ BİLGİLERLE DEĞİŞTİRİNİZ !!!
 const firebaseConfig = {
    apiKey: "AIzaSyC7hS2P3m2xVfHrl0ONsMrVYv6uY-R-xNU",
    authDomain: "yildizkonaklariaidat.firebaseapp.com",
    projectId: "yildizkonaklariaidat",
    storageBucket: "yildizkonaklariaidat.firebasestorage.app",
    messagingSenderId: "51493869354",
    appId: "1:51493869354:web:556e64fc918fcc813c3053",
    measurementId: "G-4110SM95RV"
  };

    // Firebase'i başlat
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // const storage = getStorage(app); // STORAGE KALDIRILDI

    // Global olarak erişilebilir yapmak için
    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
    window.doc = doc;
    window.setDoc = setDoc;
    window.addDoc = addDoc;
    window.deleteDoc = deleteDoc;
    window.updateDoc = updateDoc;
    window.getDoc = getDoc;
    window.query = query;
    window.where = where;
    window.writeBatch = writeBatch;

    // STORAGE ile ilgili window atamaları kaldırıldı
    // window.ref = ref;
    // window.uploadBytes = uploadBytes;
    // window.getDownloadURL = getDownloadURL;
    // window.deleteObject = deleteObject;

    // Uygulama genelinde kullanılacak değişkenler (başlangıç değerleri)
    const defaultAidat = 2000;
    let aidatTutari = defaultAidat; 
    
    let adminCredentials = { username: "admin", password: "admin123" }; 
    let passwords = {}; 
    let allApartmentDebts = {}; 

    const daireler = [];
    ["A", "B", "C", "D", "E", "F", "G"].forEach(blok => {
      for (let i = 1; i <= 8; i++) daireler.push(`${blok}${i}`);
    });

    // --- Yardımcı Fonksiyonlar (Arayüz Geri Bildirimi) ---
    function showMessage(elementId, message, isError = false) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.classList.remove('hidden');
        if (isError) {
            element.classList.remove('message');
            element.classList.add('error-message');
        } else {
            element.classList.remove('error-message');
            element.classList.add('message');
        }
        setTimeout(() => {
            element.classList.add('hidden');
        }, 3000);
    }

    // --- Firebase Veri Yükleme ve Başlangıç Ayarları ---
    async function loadAuthDataFromFirebase() {
        const loginButton = document.getElementById("loginButton");
        loginButton.disabled = true;

        try {
            const adminDocRef = doc(db, 'admin', 'credentials');
            const adminDocSnap = await getDoc(adminDocRef);
            if (adminDocSnap.exists()) {
                adminCredentials = adminDocSnap.data();
            } else {
                await setDoc(adminDocRef, adminCredentials); 
            }

            const settingsDocRef = doc(db, 'settings', 'aidat');
            const settingsDocSnap = await getDoc(settingsDocRef);
            if (settingsDocSnap.exists()) {
                aidatTutari = settingsDocSnap.data().amount || defaultAidat;
            } else {
                await setDoc(settingsDocRef, { amount: defaultAidat }); 
            }

            for (const daire of daireler) {
                const flatDocRef = doc(db, 'apartments', daire);
                const flatDocSnap = await getDoc(flatDocRef);

                if (!flatDocSnap.exists()) {
                    await setDoc(flatDocRef, { password: "1234" }); 
                    passwords[daire] = "1234"; 
                } else {
                    passwords[daire] = flatDocSnap.data().password || "1234"; 
                }
            }
            
            console.log("Kimlik doğrulama verileri Firebase'den başarıyla yüklendi.");
            loginButton.disabled = false; 
            showMessage("loginMessage", "Sistem hazır. Giriş yapabilirsiniz.", false);
            
        } catch (error) {
            console.error("Firebase'den veri yüklenirken hata oluştu:", error);
            showMessage("loginMessage", "Giriş verileri yüklenirken bir sorun oluştu. Lütfen konsolu kontrol edin.", true);
        }
    }

    // --- Giriş/Çıkış İşlevselliği ---
    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const loginMessage = document.getElementById("loginMessage");

      if (username === adminCredentials.username && password === adminCredentials.password) {
        document.getElementById("login").classList.add("hidden");
        document.getElementById("adminPanel").classList.remove("hidden");
        fillFlatSelects();
        await loadAllApartmentDebtsForBackup(); 
        loadAdminTable(); 
        loginMessage.classList.add("hidden");
        return;
      }

      const flatDocRef = doc(db, 'apartments', username);
      const flatDocSnap = await getDoc(flatDocRef);

      if (!flatDocSnap.exists()) {
        showMessage("loginMessage", "Kullanıcı bulunamadı.", true);
        return;
      }

      const flatData = flatDocSnap.data();
      if (flatData.password !== password) {
        showMessage("loginMessage", "Şifre yanlış.", true);
        return;
      }

      document.getElementById("login").classList.add("hidden");
      document.getElementById("userPanel").classList.remove("hidden");
      document.getElementById("userNameDisplay").textContent = username;
      loadUserTable(username); 
      loginMessage.classList.add("hidden");
    }

    function logout() {
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      location.reload(); 
    }

    // --- Kullanıcı Paneli Fonksiyonları ---
    async function loadUserTable(username) {
      const table = document.getElementById("userTable");
      table.innerHTML = '<tr><th>Ay</th><th>Tip</th><th>Tutar</th><th>Durum</th></tr>';
      let totalPaid = 0;
      let totalUnpaid = 0;

      try {
        const debtsCollectionRef = collection(db, 'apartments', username, 'debts');
        const debtSnapshot = await getDocs(debtsCollectionRef);

        if (debtSnapshot.empty) {
            table.innerHTML += '<tr><td colspan="4">Borcunuz bulunmamaktadır.</td></tr>';
            document.getElementById("userDebtTotals").textContent = `Ödenen Toplam: 0 TL | Ödenmeyen Toplam: 0 TL`;
            return;
        }

        debtSnapshot.forEach(doc => {
          const entry = doc.data();
          const statusText = entry.odendi ? "Ödendi" : "Bekliyor";
          const rowClass = entry.odendi ? "" : "unpaid-debt";
          table.innerHTML += `<tr class="${rowClass}"><td>${entry.ay}</td><td>${entry.tip}</td><td>${entry.tutar} TL</td><td>${statusText}</td></tr>`;

          if (entry.odendi) {
              totalPaid += Number(entry.tutar);
          } else {
              totalUnpaid += Number(entry.tutar);
          }
        });
        document.getElementById("userDebtTotals").textContent = `Ödenen Toplam: ${totalPaid} TL | Ödenmeyen Toplam: ${totalUnpaid} TL`;
      } catch (error) {
        console.error("Kullanıcı borçları yüklenirken hata:", error);
        showMessage("loginMessage", "Borçlar yüklenirken bir sorun oluştu.", true);
      }
    }

    // --- Yönetici Paneli Fonksiyonları ---
    function fillFlatSelects() {
      const selects = ["flatSelect", "borcKime", "sifreDaire"];
      selects.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = "";
        daireler.forEach(daire => {
          const option = document.createElement("option");
          option.value = daire;
          option.textContent = daire;
          select.appendChild(option);
        });
      });
    }

    async function loadAdminTable() {
      const daire = document.getElementById("flatSelect").value;
      const table = document.getElementById("adminTable");
      table.innerHTML = '<tr><th>Ay</th><th>Tip</th><th>Tutar</th><th>Durum</th><th>İşlem</th></tr>';
      let toplam = 0, odenen = 0;

      try {
        const debtsCollectionRef = collection(db, 'apartments', daire, 'debts');
        const debtSnapshot = await getDocs(debtsCollectionRef);

        if (debtSnapshot.empty) {
            table.innerHTML += '<tr><td colspan="5">Bu daire için borç bulunmamaktadır.</td></tr>';
            document.getElementById("borcToplam").textContent = `Toplam: 0 TL | Ödenen: 0 TL | Kalan: 0 TL`;
            return;
        }

        debtSnapshot.forEach(doc => {
          const entry = doc.data();
          const debtId = doc.id; 
          toplam += Number(entry.tutar);
          if (entry.odendi) odenen += Number(entry.tutar);
          table.innerHTML += `<tr>
            <td>${entry.ay}</td>
            <td>${entry.tip}</td>
            <td>${entry.tutar} TL</td>
            <td>${entry.odendi ? "Ödendi" : "Bekliyor"}</td>
            <td>
              ${entry.odendi ? "-" : `<button onclick="markPaid('${daire}', '${debtId}')">Ödendi</button>`}
              <button class="edit-btn" onclick="editDebt('${daire}', '${debtId}')">Düzenle</button>
              <button class="delete-btn" onclick="silBorc('${daire}', '${debtId}')">Sil</button>
            </td>
          </tr>`;
        });
        document.getElementById("borcToplam").textContent = `Toplam: ${toplam} TL | Ödenen: ${odenen} TL | Kalan: ${toplam - odenen} TL`;
      } catch (error) {
        console.error("Yönetici borçları yüklenirken hata:", error);
        showMessage("adminTableMessage", "Borçlar yüklenirken bir sorun oluştu.", true);
      }
    }

    async function markPaid(daire, debtId) {
      const debtDocRef = doc(db, 'apartments', daire, 'debts', debtId);
      const debtDocSnap = await getDoc(debtDocRef);

      if (!debtDocSnap.exists()) {
        showMessage("adminTableMessage", "Borç bulunamadı.", true);
        return;
      }
      const currentDebt = debtDocSnap.data();

      if (confirm(`${currentDebt.ay} ayına ait ${currentDebt.tutar} TL'lik borcu ödendi olarak işaretlemek istediğinizden emin misiniz?`)) {
          try {
              await updateDoc(debtDocRef, { odendi: true });
              showMessage("adminTableMessage", "Borç ödendi olarak işaretlendi.");
              const daireBorclari = allApartmentDebts[daire];
              if (daireBorclari) {
                  const borcIndex = daireBorclari.findIndex(b => b.id === debtId);
                  if (borcIndex !== -1) {
                      daireBorclari[borcIndex].odendi = true;
                  }
              }
              loadAdminTable(); 
          } catch (error) {
              console.error("Borç ödendi olarak işaretlenirken hata:", error);
              showMessage("adminTableMessage", "Borç güncellenirken bir sorun oluştu.", true);
          }
      }
    }

    async function ekleBorc() {
      const daire = document.getElementById("borcKime").value;
      const ay = document.getElementById("borcAy").value.trim();
      const tutar = Number(document.getElementById("borcTutar").value);
      const tip = document.getElementById("borcTipi").value;

      if (!ay || isNaN(tutar) || tutar <= 0) {
        showMessage("addDebtMessage", "Lütfen ay ve geçerli bir tutar giriniz.", true);
        return;
      }

      try {
        const debtsCollectionRef = collection(db, 'apartments', daire, 'debts');
        const q = query(debtsCollectionRef, where("ay", "==", ay), where("tip", "==", tip), where("odendi", "==", false));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            showMessage("addDebtMessage", `${daire} dairesi için ${ay} ayında ${tip} borcu zaten mevcut ve ödenmemiş.`, true);
            return;
        }
        
        const newDebtRef = await addDoc(debtsCollectionRef, { ay, tutar, tip, odendi: false });
        if (!allApartmentDebts[daire]) {
            allApartmentDebts[daire] = [];
        }
        allApartmentDebts[daire].push({ ay, tutar, tip, odendi: false, id: newDebtRef.id });

        loadAdminTable();
        showMessage("addDebtMessage", "Yeni borç başarıyla eklendi.");
        document.getElementById("borcAy").value = "";
        document.getElementById("borcTutar").value = "";
      } catch (error) {
        console.error("Borç eklenirken hata:", error);
        showMessage("addDebtMessage", "Borç eklenirken bir sorun oluştu.", true);
      }
    }

    async function silBorc(daire, debtId) {
        const debtDocRef = doc(db, 'apartments', daire, 'debts', debtId);
        const debtDocSnap = await getDoc(debtDocRef);

        if (!debtDocSnap.exists()) {
          showMessage("adminTableMessage", "Borç bulunamadı.", true);
          return;
        }
        const currentDebt = debtDocSnap.data();

        if (confirm(`Bu borcu silmek istediğinizden emin misiniz? (Ay: ${currentDebt.ay}, Tutar: ${currentDebt.tutar} TL)`)) {
            try {
                await deleteDoc(debtDocRef);
                showMessage("adminTableMessage", "Borç başarıyla silindi.");
                const daireBorclari = allApartmentDebts[daire];
                if (daireBorclari) {
                    allApartmentDebts[daire] = daireBorclari.filter(b => b.id !== debtId);
                }
                loadAdminTable();
            } catch (error) {
                console.error("Borç silinirken hata:", error);
                showMessage("adminTableMessage", "Borç silinirken bir sorun oluştu.", true);
            }
        }
    }

    async function editDebt(daire, debtId) {
        const debtDocRef = doc(db, 'apartments', daire, 'debts', debtId);
        const debtDocSnap = await getDoc(debtDocRef);

        if (!debtDocSnap.exists()) {
          showMessage("adminTableMessage", "Borç bulunamadı.", true);
          return;
        }
        const currentDebt = debtDocSnap.data();

        const newAy = prompt(`"${currentDebt.ay}" ayını düzenle (örn: Ağustos 2025):`, currentDebt.ay);
        if (newAy === null) return;

        let newTutar;
        do {
            newTutar = prompt(`"${currentDebt.tutar}" TL tutarını düzenle:`, currentDebt.tutar);
            if (newTutar === null) return;
            newTutar = Number(newTutar);
        } while (isNaN(newTutar) || newTutar <= 0);

        const newTip = prompt(`"${currentDebt.tip}" tipini düzenle (aidat/avans):`, currentDebt.tip);
        if (newTip === null || (newTip !== 'aidat' && newTip !== 'avans')) {
            showMessage("adminTableMessage", "Geçersiz borç tipi. 'aidat' veya 'avans' olmalı.", true);
            return;
        }

        try {
            const debtsCollectionRef = collection(db, 'apartments', daire, 'debts');
            const q = query(debtsCollectionRef, 
                where("ay", "==", newAy), 
                where("tip", "==", newTip), 
                where("odendi", "==", false)
            );
            const querySnapshot = await getDocs(q);

            const isDuplicateAfterEdit = !querySnapshot.empty && querySnapshot.docs.some(doc => doc.id !== debtId);

            if (isDuplicateAfterEdit) {
                showMessage("adminTableMessage", `${daire} dairesi için ${newAy} ayında ${newTip} borcu zaten mevcut ve ödenmemiş. Düzenleme yapılamadı.`, true);
                return;
            }

            await updateDoc(debtDocRef, { 
                ay: newAy.trim(),
                tutar: newTutar,
                tip: newTip.trim()
            });

            showMessage("adminTableMessage", "Borç başarıyla düzenlendi.");
            const daireBorclari = allApartmentDebts[daire];
            if (daireBorclari) {
                const borcIndex = daireBorclari.findIndex(b => b.id === debtId);
                if (borcIndex !== -1) {
                    daireBorclari[borcIndex].ay = newAy.trim();
                    daireBorclari[borcIndex].tutar = newTutar;
                    daireBorclari[borcIndex].tip = newTip.trim();
                }
            }
            loadAdminTable();
        } catch (error) {
            console.error("Borç düzenlenirken hata:", error);
            showMessage("adminTableMessage", "Borç düzenlenirken bir sorun oluştu.", true);
        }
    }

    async function updateAidatTutari() {
      const yeni = Number(document.getElementById("aidatTutariInput").value);
      if (isNaN(yeni) || yeni <= 0) {
        showMessage("aidatMessage", "Lütfen geçerli bir aidat tutarı giriniz.", true);
        return;
      }

      const currentDate = new Date();
      const currentMonth = currentDate.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });

      try {
        const settingsDocRef = doc(db, 'settings', 'aidat');
        await setDoc(settingsDocRef, { amount: yeni });
        aidatTutari = yeni; 

        let addedCount = 0;
        for (const daire of daireler) {
            const debtsCollectionRef = collection(db, 'apartments', daire, 'debts');
            const q = query(debtsCollectionRef, where("ay", "==", currentMonth), where("tip", "==", "aidat"), where("odendi", "==", false));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                const newDebtRef = await addDoc(debtsCollectionRef, { ay: currentMonth, tutar: yeni, tip: 'aidat', odendi: false });
                addedCount++;
                if (!allApartmentDebts[daire]) {
                    allApartmentDebts[daire] = [];
                }
                allApartmentDebts[daire].push({ ay: currentMonth, tutar: yeni, tip: 'aidat', odendi: false, id: newDebtRef.id });
            }
        }
        
        if (addedCount > 0) {
            showMessage("aidatMessage", `Aidat tutarı ${aidatTutari} TL olarak güncellendi ve ${addedCount} daireye ${currentMonth} ayı için aidat borcu eklendi.`, false);
        } else {
            showMessage("aidatMessage", `Aidat tutarı ${aidatTutari} TL olarak güncellendi. Tüm dairelerde ${currentMonth} ayı aidat borcu zaten mevcut veya ödenmiş.`, false);
        }
        document.getElementById("aidatTutariInput").value = "";
        loadAdminTable();
      } catch (error) {
        console.error("Aidat tutarı güncellenirken hata:", error);
        showMessage("aidatMessage", "Aidat tutarı güncellenirken bir sorun oluştu.", true);
      }
    }

    async function addAdvanceToAll() {
        const avans = Number(document.getElementById("avansTutariInput").value);
        if (isNaN(avans) || avans <= 0) {
            showMessage("avansMessage", "Lütfen geçerli bir avans tutarı giriniz.", true);
            return;
        }

        const currentDate = new Date();
        const currentMonth = currentDate.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });

        try {
            let addedCount = 0;
            for (const daire of daireler) {
                const debtsCollectionRef = collection(db, 'apartments', daire, 'debts');
                const q = query(debtsCollectionRef, where("ay", "==", currentMonth), where("tip", "==", "avans"), where("odendi", "==", false));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    const newDebtRef = await addDoc(debtsCollectionRef, { ay: currentMonth, tutar: avans, tip: 'avans', odendi: false });
                    addedCount++;
                    if (!allApartmentDebts[daire]) {
                        allApartmentDebts[daire] = [];
                    }
                    allApartmentDebts[daire].push({ ay: currentMonth, tutar: avans, tip: 'avans', odendi: false, id: newDebtRef.id });
                }
            }
            
            if (addedCount > 0) {
                showMessage("avansMessage", `${addedCount} daireye ${currentMonth} ayı için ${avans} TL avans borcu eklendi.`, false);
            } else {
                showMessage("avansMessage", `Tüm dairelerde ${currentMonth} ayı için zaten avans borcu mevcut veya ödenmiş.`, false);
            }
            document.getElementById("avansTutariInput").value = "";
            loadAdminTable();
        } catch (error) {
            console.error("Avans eklenirken hata:", error);
            showMessage("avansMessage", "Avans eklenirken bir sorun oluştu.", true);
        }
    }

    async function sifreAyarla() {
      const daire = document.getElementById("sifreDaire").value;
      const yeniSifre = document.getElementById("yeniSifre").value;
      if (yeniSifre.length < 3) {
        showMessage("passwordMessage", "Şifre en az 3 karakter olmalıdır.", true);
        return;
      }
      try {
        const flatDocRef = doc(db, 'apartments', daire);
        await setDoc(flatDocRef, { password: yeniSifre }, { merge: true }); 
        passwords[daire] = yeniSifre; 
        showMessage("passwordMessage", `${daire} için şifre başarıyla güncellendi.`);
        document.getElementById("yeniSifre").value = "";
      } catch (error) {
        console.error("Daire şifresi güncellenirken hata:", error);
        showMessage("passwordMessage", "Şifre güncellenirken bir sorun oluştu.", true);
      }
    }

    async function setAdminPassword() {
        const newAdminPass = document.getElementById("adminYeniSifre").value;
        if (newAdminPass.length < 5) {
            showMessage("adminPasswordMessage", "Yönetici şifresi en az 5 karakter olmalıdır.", true);
            return;
        }
        try {
            const adminDocRef = doc(db, 'admin', 'credentials');
            await setDoc(adminDocRef, { username: "admin", password: newAdminPass });
            adminCredentials.password = newAdminPass; 
            showMessage("adminPasswordMessage", "Yönetici şifresi başarıyla güncellendi. Lütfen bir sonraki girişinizde yeni şifrenizi kullanın.", false);
            document.getElementById("adminYeniSifre").value = "";
        } catch (error) {
            console.error("Yönetici şifresi güncellenirken hata:", error);
            showMessage("adminPasswordMessage", "Yönetici şifresi güncellenirken bir sorun oluştu.", true);
        }
    }

    async function loadAllApartmentDebtsForBackup() {
        try {
            allApartmentDebts = {}; 
            for (const daire of daireler) {
                const debtsCollectionRef = collection(db, 'apartments', daire, 'debts');
                const debtSnapshot = await getDocs(debtsCollectionRef);
                allApartmentDebts[daire] = [];
                debtSnapshot.forEach(debtDoc => {
                    allApartmentDebts[daire].push({ ...debtDoc.data(), id: debtDoc.id });
                });
            }
            console.log("Tüm daire borçları yedekleme için yüklendi.");
        } catch (error) {
            console.error("Tüm daire borçları yüklenirken hata:", error);
            showMessage("adminTableMessage", "Borçlar yüklenirken bir sorun oluştu (yedekleme için).", true);
        }
    }

    async function deleteAllDebts() {
        if (confirm("Tüm dairelere ait tüm borçları silmek istediğinizden emin misiniz? Bu işlem geri alınamaz ve tüm borç kayıtlarını sıfırlayacaktır!")) {
            try {
                for (const daire of daireler) {
                    const debtsCollectionRef = collection(db, 'apartments', daire, 'debts');
                    const debtSnapshot = await getDocs(debtsCollectionRef);
                    
                    const batch = writeBatch(db); 
                    debtSnapshot.forEach(docToDelete => {
                        batch.delete(doc(debtsCollectionRef, docToDelete.id));
                    });
                    await batch.commit(); 
                    
                    allApartmentDebts[daire] = []; 
                }
                loadAdminTable(); 
                showMessage("adminTableMessage", "Tüm dairelere ait tüm borçlar başarıyla silindi.", false);
            } catch (error) {
                console.error("Tüm borçlar silinirken hata:", error);
                showMessage("adminTableMessage", "Tüm borçlar silinirken bir sorun oluştu.", true);
            }
        }
    }

    async function downloadAllDebtsCsv() {
        await loadAllApartmentDebtsForBackup(); 

        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "Daire,Ay,Tip,Tutar (TL),Durum\n";

        daireler.forEach(daire => {
            if (allApartmentDebts[daire] && allApartmentDebts[daire].length > 0) {
                allApartmentDebts[daire].forEach(entry => {
                    const status = entry.odendi ? "Ödendi" : "Bekliyor";
                    const ayEscaped = `"${String(entry.ay).replace(/"/g, '""')}"`;
                    const tipEscaped = `"${String(entry.tip).replace(/"/g, '""')}"`;
                    const statusEscaped = `"${String(status).replace(/"/g, '""')}"`;
                    csvContent += `${daire},${ayEscaped},${tipEscaped},${entry.tutar},${statusEscaped}\n`;
                });
            } else {
                csvContent += `${daire},"Borç Yok","-","-","-"\n`;
            }
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        const today = new Date();
        const dd = String(today.getDate()).padStart(2, '0');
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const yyyy = today.getFullYear();
        const filenameDate = `${dd}-${mm}-${yyyy}`;

        link.setAttribute("download", `Ayvalik_Yildiz_Konaklari_Borc_Listesi_${filenameDate}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showMessage("adminTableMessage", "Tüm borçlar Excel dosyası olarak indirildi.");
    }

    // --- Yedekleme ve Geri Yükleme Fonksiyonları ---

    async function backupData() {
        showMessage("backupRestoreMessage", "Yedekleme başlatılıyor...", false);
        try {
            // Tüm veriyi çekelim ki en güncel hali yedeklensin
            await loadAuthDataFromFirebase(); 
            await loadAllApartmentDebtsForBackup(); 

            const backupData = {
                adminCredentials: adminCredentials,
                aidatTutari: aidatTutari,
                passwords: passwords,
                allApartmentDebts: allApartmentDebts 
            };

            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            const now = new Date();
            const filename = `aidat_yedek_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}.json`;

            // Kullanıcının indirmesi için link oluştur
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); 

            showMessage("backupRestoreMessage", `Yedek başarıyla bilgisayarınıza indirildi: ${filename}`, false);

        } catch (error) {
            console.error("Yedekleme hatası:", error);
            showMessage("backupRestoreMessage", `Yedekleme sırasında hata oluştu: ${error.message}`, true);
        }
    }

    async function restoreData(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        showMessage("backupRestoreMessage", "Yedek yükleniyor...", false);

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const backupData = JSON.parse(e.target.result);

                if (!confirm("Yedeklemeden geri yüklemek mevcut tüm verilerin üzerine yazacaktır. Emin misiniz?")) {
                    showMessage("backupRestoreMessage", "Geri yükleme iptal edildi.", false);
                    return;
                }

                const batch = writeBatch(db); 

                // Admin verilerini yükle
                const adminDocRef = doc(db, 'admin', 'credentials');
                batch.set(adminDocRef, backupData.adminCredentials);

                // Ayar verilerini yükle
                const settingsDocRef = doc(db, 'settings', 'aidat');
                batch.set(settingsDocRef, { amount: backupData.aidatTutari });

                // Daire şifrelerini ve borçlarını yükle
                for (const daire of daireler) {
                    const flatDocRef = doc(db, 'apartments', daire);
                    batch.set(flatDocRef, { password: backupData.passwords[daire] || "1234" }, { merge: true });

                    // Mevcut borçları sil
                    const debtsCollectionRef = collection(db, 'apartments', daire, 'debts');
                    const currentDebtsSnapshot = await getDocs(debtsCollectionRef); 
                    currentDebtsSnapshot.forEach(docToDelete => {
                        batch.delete(doc(debtsCollectionRef, docToDelete.id));
                    });

                    // Yedekdeki borçları yeniden ekle (yeni ID'lerle)
                    if (backupData.allApartmentDebts[daire]) {
                        backupData.allApartmentDebts[daire].forEach(debt => {
                            const newDebtRef = doc(debtsCollectionRef); 
                            batch.set(newDebtRef, { 
                                ay: debt.ay,
                                tip: debt.tip,
                                tutar: debt.tutar,
                                odendi: debt.odendi
                            });
                        });
                    }
                }
                
                await batch.commit();

                showMessage("backupRestoreMessage", "Veriler başarıyla yedekten yüklendi! Lütfen sayfayı yenileyin.", false);
                setTimeout(() => { location.reload(); }, 2000); 
            } catch (error) {
                console.error("Geri yükleme hatası:", error);
                showMessage("backupRestoreMessage", `Geri yükleme sırasında hata oluştu: ${error.message}`, true);
            }
        };
        reader.readAsText(file);
    }


    // --- HTML'den doğrudan çağrılması gereken fonksiyonları global yapıyoruz ---
    window.login = login;
    window.logout = logout;
    window.loadUserTable = loadUserTable; 
    window.fillFlatSelects = fillFlatSelects; 
    window.loadAdminTable = loadAdminTable; 
    window.markPaid = markPaid;
    window.ekleBorc = ekleBorc;
    window.silBorc = silBorc;
    window.editDebt = editDebt;
    window.updateAidatTutari = updateAidatTutari;
    window.addAdvanceToAll = addAdvanceToAll;
    window.sifreAyarla = sifreAyarla;
    window.setAdminPassword = setAdminPassword;
    window.deleteAllDebts = deleteAllDebts;
    window.downloadAllDebtsCsv = downloadAllDebtsCsv;
    window.backupData = backupData; 
    window.restoreData = restoreData; 
    window.showMessage = showMessage; 


    // --- Uygulama Başlangıcı ---
    loadAuthDataFromFirebase();
  </script>
</body>
</html>
