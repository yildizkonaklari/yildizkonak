<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Ayvalık Yıldız Konakları - Aidat Takip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #014f86;
      --secondary-color: #468faf;
      --background-color: #f0f4f8;
      --container-bg: #fff8f0;
      --text-color: #333;
      --border-color: #ccc;
      --hover-color: #014f86;
      --danger-color: #dc3545;
      --danger-hover: #c82333;
      --success-color: #28a745;
      --success-hover: #218838;
      --info-color: #17a2b8;
      --info-hover: #138496;
      --warning-color: #ffc107;
      --warning-hover: #e0a800;
      --publish-bg: #e67e22;
      --publish-hover: #d35400;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--background-color);
      color: var(--text-color);
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: var(--container-bg);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1, h2, h3, h4, h5 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    h5 {
        text-align: left;
        margin-top: 15px;
        margin-bottom: 5px;
    }
    input, select, button {
      padding: 12px;
      margin: 8px 0;
      width: 100%;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      font-size: 16px;
    }
    button {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: var(--hover-color);
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .hidden { display: none !important; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid var(--border-color);
      padding: 12px;
      text-align: center;
      word-break: break-word;
    }
    th {
      background-color: #dbe9f4;
      font-weight: bold;
    }
    td:first-child {
        text-align: left;
        padding-left: 10px;
    }
    .totals {
      margin-top: 20px;
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
    }
    .delete-btn { background-color: var(--danger-color); }
    .delete-btn:hover:not(:disabled) { background-color: var(--danger-hover); }
    .edit-btn { background-color: var(--warning-color); color: var(--text-color); }
    .edit-btn:hover:not(:disabled) { background-color: var(--warning-hover); }
    .download-btn, .backup-btn { background-color: var(--success-color); }
    .download-btn:hover:not(:disabled), .backup-btn:hover:not(:disabled) { background-color: var(--success-hover); }
    .upload-btn { background-color: var(--info-color); }
    .upload-btn:hover:not(:disabled) { background-color: var(--info-hover); }
    .info-btn { background-color: var(--info-color); }
    .info-btn:hover:not(:disabled) { background-color: var(--info-hover); }
    .message { text-align: center; color: var(--success-color); margin-top: 10px; font-weight: bold; }
    .error-message { text-align: center; color: var(--danger-color); margin-top: 10px; font-weight: bold; }
    .bank-info { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px dashed var(--border-color); font-size: 0.9em; color: #555; }
    .section-divider { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); }
    .unpaid-debt { color: var(--danger-color); font-weight: bold; }
    .collapsible-header {
      background-color: #dbe9f4;
      color: var(--primary-color);
      cursor: pointer;
      padding: 18px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 18px;
      border-radius: 6px;
      margin-top: 15px;
      transition: background-color 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .collapsible-header:hover { background-color: #c0d8eb; }
    .collapsible-content {
      padding: 0 18px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
      background-color: #f7f9fc;
      border-radius: 6px;
    }
    .collapsible-content.active {
      max-height: 1200px; 
      padding: 18px;
    }
    .collapsible-header:after {
      content: '+';
      font-weight: bold;
      font-size: 24px;
      margin-left: 5px;
    }
    .collapsible-header.active:after { content: '-'; }
    .user-profile-display {
      background: #e9f2fa;
      border: 1px solid #c0d8eb;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 1.1em;
      text-align: center;
    }
    .user-profile-display p {
      margin: 5px 0;
    }
    .user-profile-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .publish-btn {
      background-color: var(--publish-bg);
      color: white;
    }
    .publish-btn:hover {
      background-color: var(--publish-hover);
    }
    .balance-summary-card {
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .balance-summary-card:hover {
        background-color: #f8f9fa;
    }
    .summary-title {
        font-size: 1em;
        color: var(--text-color);
        display: block;
    }
    .summary-amount {
        font-size: 1.8em;
        font-weight: bold;
        color: var(--danger-color);
    }
    .summary-arrow {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-color);
        transition: transform 0.2s ease-out;
    }
    .balance-summary-card.active .summary-arrow {
        transform: rotate(180deg);
    }
    .collapsible-debt-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background-color: #fdfdfd;
        border-radius: 6px;
    }
    .collapsible-debt-details.active {
        max-height: 1500px;
        padding: 15px;
        border: 1px solid #eee;
    }
    .admin-table-container {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
    }
    .profile-info-text {
        background-color: #e9ecef;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #ced4da;
        margin: 8px 0;
        text-align: center;
    }
    .refresh-icon {
        margin-left: auto;
        padding: 0 10px;
        font-size: 24px;
        line-height: 1;
        font-weight: bold;
        color: var(--primary-color);
        cursor: pointer;
        border-radius: 50%;
        transition: transform 0.5s ease, background-color 0.2s;
    }
    .refresh-icon:hover {
        background-color: rgba(0,0,0,0.08);
        transform: rotate(360deg);
    }
    .collapsible-header > span:first-child {
        flex-grow: 1;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 700px;
        border-radius: 10px;
        position: relative;
    }
    .modal-content h4 { text-align: left; }
    .modal-close {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .terms-box {
        height: 200px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #f9f9f9;
        margin-bottom: 10px;
    }
    .terms-label {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
    }
    input[type="checkbox"] {
        width: auto;
    }
    #openTermsModal {
        color: var(--primary-color);
        text-decoration: underline;
        cursor: pointer;
    }
     .month-selector {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #fff;
        padding: 10px;
        border-radius: 8px;
        margin: 15px 0;
        border: 1px solid var(--border-color);
    }
    .month-selector button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--primary-color);
        padding: 0 15px;
    }
    .month-selector span {
        font-size: 1.2em;
        font-weight: bold;
        color: var(--text-color);
    }
    .all-apartments-summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        padding: 10px 0;
    }
    .summary-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        border-left: 5px solid;
    }
    .summary-card.paid { border-color: var(--success-color); }
    .summary-card.unpaid { border-color: var(--danger-color); }
    .summary-card.no-record { border-color: var(--border-color); }
    .summary-card-title {
        font-size: 1em;
        color: #666;
        margin-bottom: 8px;
    }
    .summary-card-value {
        font-size: 2.5em;
        font-weight: bold;
    }
    .summary-card.paid .summary-card-value { color: var(--success-color); }
    .summary-card.unpaid .summary-card-value { color: var(--danger-color); }
    .summary-card.no-record .summary-card-value { color: var(--text-color); }
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        padding: 10px 0;
    }
    .dashboard-card {
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-left: 5px solid var(--primary-color);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .dashboard-card-title {
        font-size: 0.9em;
        color: #555;
        text-align: center;
        margin-bottom: 10px;
    }
    .dashboard-card-value {
        font-size: 1.8em;
        font-weight: bold;
        color: var(--primary-color);
    }
    #applyLateFeeBtn {
        background-color: var(--info-color);
    }
    #applyLateFeeBtn:hover:not(:disabled) {
        background-color: var(--info-hover);
    }
    #applyLateFeeBtn.active {
        background-color: var(--danger-color);
    }
    #applyLateFeeBtn.active:hover:not(:disabled) {
        background-color: var(--danger-hover);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ayvalık Yıldız Konakları</h1>
    <h2>Aidat Takip Sistemi</h2>

    <div id="login">
      <h3>Giriş Yap</h3>
      <input type="text" id="username" placeholder="Kullanıcı Adı (örn: A1)">
      <input type="password" id="password" placeholder="Şifre">
       <label class="terms-label">
        <input type="checkbox" id="loginTerms">
        <span><a href="#" id="openTermsModal">Kullanıcı Aydınlatma Metni ve Gizlilik Sözleşmesini</a> okudum, kabul ediyorum.</span>
      </label>
      <button id="loginButton" disabled>Giriş</button>
      <div id="loginMessage" class="message hidden"></div>
    </div>
    
    <div id="userPanel" class="hidden">
      <h3>Hoş Geldiniz, <span id="userNameDisplay"></span><span id="userFullNameDisplay" style="font-weight: normal;"></span></h3>
      
      <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
        <button id="showDebtBtn" style="flex-grow: 1;">Bakiye</button>
        <button id="showProfileBtn" style="flex-grow: 1;">Profilim</button>
        <button id="showExpensesBtn" style="flex-grow: 1;" class="hidden">Giderler</button>
      </div>

       <div id="profileIncompleteMessage" class="error-message hidden"></div>

      <div id="debtPage">
        <h4>Bakiyeniz</h4>

        <div id="balanceSummary" class="balance-summary-card">
            <div>
                <span class="summary-title">Ödenmemiş Toplam Bakiye</span>
                <span id="userUnpaidTotal" class="summary-amount">Hesaplanıyor...</span>
            </div>
            <span class="summary-arrow">▽</span>
        </div>

        <div id="debtDetails" class="collapsible-debt-details">
            <div class="table-responsive">
              <table id="userTable">
                <tr><th>Açıklama</th><th>Tutar</th><th>Durum</th></tr>
              </table>
            </div>
            <div class="totals" id="userDebtTotals"></div>
        </div>
        
        <div class="bank-info">
          <p><strong>Yıldız Konakları Site Yönetimi</strong></p>
          <p><strong>IBAN:</strong> TR510001000110981102095001</p>
        </div>
      </div>

      <div id="profilePage" class="hidden">
        <h4>Profil Bilgilerim</h4>
        <div class="profile-info-text">
            <strong>Ad Soyad:</strong> <span id="profileNameDisplay">Yükleniyor...</span>
        </div>
        <input type="text" id="phoneInput" placeholder="Telefon (5xx xxx xx xx)">
        <input type="email" id="mailInput" placeholder="E-posta Adresiniz">
        <button id="saveProfileBtn">Bilgileri Kaydet</button>
        <button id="changePasswordBtn" class="info-btn" style="margin-top:10px;">Şifre Değiştir</button>
        <div id="profileMessage" class="message hidden"></div>
      </div>
      
      <div id="expensesPage" class="hidden">
        <h4>Site Giderleri</h4>
        <div id="expenseNotPublishedMessage" class="message hidden"></div>
        <div id="expenseTableContainer">
          <div class="table-responsive">
            <table id="userExpenseTable">
              <tr><th>Tarih</th><th>Harcama Adı</th><th>Tutar</th></tr>
            </table>
          </div>
          <div class="totals" id="userExpenseTotals"></div>
        </div>
      </div>

      <div class="section-divider"></div>
      <button id="logoutBtnUser">Çıkış Yap</button>
      <div id="userMessage" class="message hidden"></div>
    </div>

    <div id="adminPanel" class="hidden">
      <h3>Yönetici Paneli</h3>
      
      <button class="collapsible-header active">
        <span>Gösterge Paneli</span>
        <span id="refreshDashboardBtn" class="refresh-icon" title="Paneli Yenile">↻</span>
      </button>
      <div id="adminDashboard" class="collapsible-content active" style="max-height: 500px;">
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <span class="dashboard-card-title">Toplam Kasa Bakiyesi</span>
                <span id="dashboardTotalBalance" class="dashboard-card-value">...</span>
            </div>
            <div class="dashboard-card">
                <span class="dashboard-card-title">Bu Ayki Gelir</span>
                <span id="dashboardMonthlyIncome" class="dashboard-card-value">...</span>
            </div>
            <div class="dashboard-card">
                <span class="dashboard-card-title">Bu Ayki Gider</span>
                <span id="dashboardMonthlyExpense" class="dashboard-card-value">...</span>
            </div>
            <div class="dashboard-card">
                <span class="dashboard-card-title">Bu Ay Ödemeyen Daire</span>
                <span id="dashboardUnpaidCount" class="dashboard-card-value">...</span>
            </div>
        </div>
      </div>
      
      <div class="section-divider"></div>
      <button class="collapsible-header">
        Aidat-Avans Ekle
      </button>
      <div id="newDebtSection" class="collapsible-content">
        <select id="borcTipi">
          <option value="aidat">Aidat</option>
          <option value="avans">Avans</option>
        </select>
         <div style="display: flex; gap: 10px; margin-top: 10px;">
            <select id="borcAySelect" style="width: 50%;"></select>
            <select id="borcYilSelect" style="width: 50%;"></select>
        </div>
        <input type="number" id="borcTutar" placeholder="Tutar (₺)">
        <select id="borcKime"></select>
        <button id="addDebtBtn">Borç Ekle</button>
        <button id="applyLateFeeBtn" style="margin-top: 10px;">%5 Gecikme Faizi Uygula</button>
        <div id="addDebtMessage" class="message hidden"></div>
      </div>

      <div class="section-divider"></div>
      <button class="collapsible-header">
        Daire Borç Listesi
      </button>
      <div id="debtListSection" class="collapsible-content">
        <select id="flatSelect"></select>
         <div class="month-selector">
            <button id="prevMonthBtn">&lt;</button>
            <span id="currentMonthDisplay"></span>
            <button id="nextMonthBtn">&gt;</button>
        </div>
        
        <div id="allApartmentsSummary" class="hidden">
            <h4 id="summaryTitle"></h4>
            <div class="all-apartments-summary-cards">
                <div class="summary-card paid">
                    <div class="summary-card-title">Ödeyen</div>
                    <div id="paidCount" class="summary-card-value">0</div>
                </div>
                <div class="summary-card unpaid">
                    <div class="summary-card-title">Ödemeyen</div>
                    <div id="unpaidCount" class="summary-card-value">0</div>
                </div>
                <div class="summary-card no-record">
                    <div class="summary-card-title">Kayıt Yok</div>
                    <div id="noRecordCount" class="summary-card-value">0</div>
                </div>
            </div>
        </div>

        <div id="singleApartmentView">
            <div id="userInfoDisplay" class="user-profile-display hidden"></div>
            <div class="admin-table-container">
                <div class="table-responsive">
                  <table id="adminTable">
                    <tr><th>Ay</th><th>Tip</th><th>Tutar</th><th>Durum</th><th>İşlem</th></tr>
                  </table>
                </div>
            </div>
            <div class="totals" id="borcToplam"></div>
        </div>
        
        <div id="adminTableMessage" class="message hidden"></div>
        
        <div class="section-divider"></div>
        <h4>Raporlar ve Toplu İşlemler</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
             <button id="downloadAccountStatementBtn" class="download-btn" style="flex-grow: 1;">Hesap Ekstresi İndir (PDF)</button>
            <button id="downloadMonthlyReportBtn" class="download-btn" style="flex-grow: 1;">Aylık Rapor İndir (PDF)</button>
        </div>
        <div style="margin-top: 15px;">
            <h5>Toplu Profil Güncelleme</h5>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <button id="downloadTemplateBtn" class="info-btn" style="flex-grow: 1;">Şablon İndir (.csv)</button>
                <input type="file" id="profileTemplateInput" accept=".csv" style="display: none;">
                <button id="uploadTemplateBtn" class="upload-btn" style="flex-grow: 1;">Şablon Yükle (.csv)</button>
            </div>
        </div>
      </div>

      <div class="section-divider"></div>
      <button class="collapsible-header">
        Giderler
      </button>
      <div id="expenseSection" class="collapsible-content">
        <h4>Yeni Gider Ekle</h4>
        <input type="date" id="expenseDateInput">
        <input type="text" id="expenseNameInput" placeholder="Harcama Adı">
        <input type="number" id="expenseAmountInput" placeholder="Tutar (₺)">
        <button id="saveExpenseBtn">Kaydet</button>
        <div id="expenseMessage" class="message hidden"></div>
        <h4>Gider Listesi</h4>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <select id="expenseMonthFilter" style="width: 50%;"></select>
          <select id="expenseYearFilter" style="width: 50%;"></select>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="filterExpensesBtn">Filtrele</button>
            <button id="publishButton" class="publish-btn">Giderleri Yayınla</button>
        </div>
        <button id="downloadAllExpensesBtn" class="download-btn" style="margin-top: 10px;">Tüm Giderleri İndir (PDF)</button>
        <div class="table-responsive">
          <table id="adminExpenseTable">
            <tr><th>Tarih</th><th>Harcama Adı</th><th>Tutar</th><th>İşlem</th></tr>
          </table>
        </div>
        <div class="totals" id="adminExpenseTotals"></div>
      </div>

      <div class="section-divider"></div>
      <button id="balanceSectionHeader" class="collapsible-header">
        <span>Bakiye Durumu</span>
        <span id="refreshBalanceBtn" class="refresh-icon" title="Bakiyeyi Yenile">↻</span>
      </button>
      <div id="balanceSection" class="collapsible-content">
        <h4>Genel Bakiye Durumu</h4>
        <div id="balanceDetails" style="text-align: center; font-size: 1.2em; padding: 20px;">
            <p><strong>Toplam Gelir (Ödenen Aidatlar/Avanslar):</strong> <span id="totalIncome">Hesaplanıyor...</span></p>
            <p><strong>Toplam Gider:</strong> <span id="totalExpense">Hesaplanıyor...</span></p>
            <hr style="margin: 15px 0;">
            <p><strong>Kalan Bakiye:</strong> <span id="remainingBalance" style="font-weight: bold; font-size: 1.3em;">Hesaplanıyor...</span></p>
        </div>
        <div id="balanceMessage" class="message hidden"></div>
      </div>
      
      <div class="section-divider"></div>
      <button class="collapsible-header">
        Daire Şifresi Ayarla
      </button>
      <div id="passwordSection" class="collapsible-content">
        <select id="sifreDaire"></select>
        <input type="password" id="yeniSifre" placeholder="Yeni Daire Şifresi">
        <button id="savePasswordBtn">Daire Şifresini Kaydet</button>
        <h5 style="margin-top: 20px;">Yönetici Şifresi Ayarla</h5>
        <input type="password" id="adminYeniSifre" placeholder="Yeni Yönetici Şifresi">
        <button id="saveAdminPasswordBtn">Yönetici Şifresini Kaydet</button>
        <div id="passwordMessage" class="message hidden"></div>
      </div>

      <div class="section-divider"></div>
      <button id="deleteAllDebtsBtn" class="delete-btn">Tüm Dairelerin Tüm Borçlarını Sil</button>
      <button id="logoutBtnAdmin">Çıkış Yap</button>
    </div>
  </div>

  <div id="termsModal" class="modal">
    <div class="modal-content">
      <span id="modalCloseBtn" class="modal-close">&times;</span>
      <h4>Kullanıcı Aydınlatma Metni ve Gizlilik Sözleşmesi</h4>
      <div class="terms-box" style="height: 40vh;">
        <p>6698 sayılı Kişisel Verilerin Korunması Kanunu (“KVKK”) uyarınca, kişisel verileriniz; veri sorumlusu olarak Yıldız Konakları Site Yönetimi tarafından aşağıda açıklanan kapsamda işlenebilecektir.</p>
        <p>Toplanan kişisel verileriniz, site sakinlerimize sunulan hizmetlerin iyileştirilmesi, aidat ve gider takibinin yapılması, site içi iletişimin sağlanması ve yasal yükümlülüklerin yerine getirilmesi amaçlarıyla KVKK’nın 5. ve 6. maddelerinde belirtilen kişisel veri işleme şartları ve amaçları dahilinde işlenecektir.</p>
        <p>İşlenen kişisel verileriniz; yukarıda sayılan amaçların gerçekleştirilmesi doğrultusunda, yetkili kamu kurum ve kuruluşlarına, hukuki uyuşmazlıkların giderilmesi için avukatlara veya adli makamlara aktarılabilecektir.</p>
        <p>Kişisel veri sahibi olarak KVKK’nın 11. maddesi uyarınca sahip olduğunuz hakları kullanmak için bizimle iletişime geçebilirsiniz.</p>
        <p><strong>Gizlilik Sözleşmesi:</strong> Bu platforma kaydolarak, paylaştığınız kişisel verilerin (Ad, Soyad, Telefon, E-posta) yalnızca site yönetimi hizmetleri kapsamında kullanılacağını, üçüncü kişilerle paylaşılmayacağını kabul etmiş olursunuz.</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, updateDoc, getDoc as getDocFromFirestore, query, where, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
          apiKey: "AIzaSyC7hS2P3m2xVfHrl0ONsMrVYv6uY-R-xNU",
          authDomain: "yildizkonaklariaidat.firebaseapp.com",
          projectId: "yildizkonaklariaidat",
          storageBucket: "yildizkonaklariaidat.firebasestorage.app",
          messagingSenderId: "51493869354",
          appId: "1:51493869354:web:556e64fc918fcc813c3053",
          measurementId: "G-4110SM95RV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let loggedInUsername = null;
        let paymentStatusChart = null;
        let adminCredentials = { username: "admin", password: "admin123" };
        const aylar = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        let currentAdminDate = new Date();

        const daireler = [];
        ["A", "B", "C", "D", "E", "F", "G"].forEach(blok => {
          for (let i = 1; i <= 8; i++) daireler.push(`${blok}${i}`);
        });

        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.textContent = message;
            element.classList.remove('hidden');
            element.className = isError ? 'error-message' : 'message';
            setTimeout(() => element.classList.add('hidden'), 4000);
        }
        
        function showPage(pageId) {
            ['debtPage', 'profilePage', 'expensesPage'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
        }

        function fillExpenseFilters() {
          const monthSelect = document.getElementById('expenseMonthFilter');
          const yearSelect = document.getElementById('expenseYearFilter');
          monthSelect.innerHTML = aylar.map((ay) => `<option value="${ay}">${ay}</option>`).join('');
          const currentYear = new Date().getFullYear();
          let yearsHtml = '';
          for(let i = currentYear - 2; i <= currentYear + 1; i++) {
            yearsHtml += `<option value="${i}">${i}</option>`;
          }
          yearSelect.innerHTML = yearsHtml;
          monthSelect.value = aylar[new Date().getMonth()];
          yearSelect.value = currentYear;
        }

        function fillBorcEkleDateFilters() {
          const monthSelect = document.getElementById('borcAySelect');
          const yearSelect = document.getElementById('borcYilSelect');
          monthSelect.innerHTML = aylar.map((ay) => `<option value="${ay}">${ay}</option>`).join('');
          const currentYear = new Date().getFullYear();
          let yearsHtml = '';
          for(let i = currentYear - 2; i <= currentYear + 2; i++) {
            yearsHtml += `<option value="${i}">${i}</option>`;
          }
          yearSelect.innerHTML = yearsHtml;
          monthSelect.value = aylar[new Date().getMonth()];
          yearSelect.value = currentYear;
        }


        function updateAdminDateDisplay() {
            const monthName = aylar[currentAdminDate.getMonth()];
            const year = currentAdminDate.getFullYear();
            document.getElementById('currentMonthDisplay').textContent = `${monthName} ${year}`;
            loadAdminView();
        }


        async function login() {
            const username = document.getElementById("username").value.trim().toUpperCase();
            const password = document.getElementById("password").value;
            const terms = document.getElementById('loginTerms').checked;

            if (!username || !password) {
                return showMessage("loginMessage", "Lütfen tüm alanları doldurun.", true);
            }
             if(!terms) {
                return showMessage('loginMessage', 'Lütfen kullanıcı sözleşmesini onaylayın.', true);
            }

            if (username === adminCredentials.username.toUpperCase() && password === adminCredentials.password) {
                await updateDoc(doc(db, "admin", "credentials"), { lastLogin: new Date() });
                setupAdminPanel();
                return;
            }
            
            try {
                const flatDoc = await getDocFromFirestore(doc(db, "apartments", username));
                if (!flatDoc.exists() || flatDoc.data().password !== password) {
                    return showMessage("loginMessage", "Kullanıcı adı veya şifre hatalı.", true);
                }
                loggedInUsername = username;
                await updateDoc(doc(db, "apartments", loggedInUsername), { lastLogin: new Date() });
                setupUserPanel();
            } catch (error) {
                console.error("Giriş hatası:", error);
                showMessage("loginMessage", "Giriş sırasında bir hata oluştu.", true);
            }
        }

        async function logout() {
          location.reload();
        }
        
        async function checkProfileAndToggleExpensesButton() {
            try {
                const userDocSnap = await getDocFromFirestore(doc(db, 'apartments', loggedInUsername));
                if (userDocSnap.exists()) {
                    const { telefon, mail } = userDocSnap.data();
                    const expensesBtn = document.getElementById('showExpensesBtn');
                    const warningMsg = document.getElementById('profileIncompleteMessage');
                    if (telefon && mail) {
                        expensesBtn.classList.remove('hidden');
                        warningMsg.classList.add('hidden');
                    } else {
                        expensesBtn.classList.add('hidden');
                        warningMsg.textContent = "Giderleri görebilmek için lütfen profil sayfasından telefon ve e-posta bilgilerinizi ekleyin.";
                        warningMsg.classList.remove('hidden');
                    }
                }
            } catch (error) {
                 console.error("Giderler butonu kontrol edilirken hata:", error);
                 showMessage('userMessage', 'Giderler durumu kontrol edilemedi.', true);
            }
        }

        async function loadUserProfile() {
            try {
                const userDocSnap = await getDocFromFirestore(doc(db, 'apartments', loggedInUsername));
                if (userDocSnap.exists()) {
                    const { adi = 'Bilgi Yok', soyadi = '', telefon = '', mail = '' } = userDocSnap.data();
                    document.getElementById('profileNameDisplay').textContent = `${adi} ${soyadi}`;
                    document.getElementById('phoneInput').value = telefon;
                    document.getElementById('mailInput').value = mail;
                }
            } catch (error) {
                console.error("Kullanıcı profili yüklenirken hata:", error);
                showMessage("profileMessage", "Profil yüklenirken bir hata oluştu.", true);
            }
        }
        
        async function saveUserProfile() {
            const telefon = document.getElementById('phoneInput').value.trim();
            const mail = document.getElementById('mailInput').value.trim();

            if (!telefon || !mail) { 
                return showMessage("profileMessage", "Lütfen telefon ve e-posta alanlarını doldurun.", true);
            }
            try {
                await updateDoc(doc(db, 'apartments', loggedInUsername), { telefon, mail });
                showMessage("profileMessage", "Profil bilgileriniz kaydedildi.");
                await checkProfileAndToggleExpensesButton();
            } catch (error) {
                console.error("Profil kaydedilirken hata:", error);
                showMessage("profileMessage", "Bilgiler kaydedilirken bir sorun oluştu.", true);
            }
        }
        
        async function changeUserPassword() {
            const currentPassword = prompt("Mevcut şifrenizi girin:");
            if (currentPassword === null) return;

            try {
                const userDoc = await getDocFromFirestore(doc(db, 'apartments', loggedInUsername));
                if (!userDoc.exists() || userDoc.data().password !== currentPassword) {
                    return showMessage("profileMessage", "Mevcut şifre hatalı.", true);
                }

                const newPassword = prompt("Yeni şifrenizi girin (en az 3 karakter):");
                if (newPassword === null) return;
                if (newPassword.length < 3) {
                    return showMessage("profileMessage", "Yeni şifre en az 3 karakter olmalı.", true);
                }
                
                const newPasswordConfirm = prompt("Yeni şifrenizi tekrar girin:");
                 if (newPassword !== newPasswordConfirm) {
                    return showMessage("profileMessage", "Şifreler eşleşmiyor.", true);
                }

                await updateDoc(doc(db, 'apartments', loggedInUsername), { password: newPassword });
                showMessage("profileMessage", "Şifreniz başarıyla değiştirildi.");

            } catch (error) {
                console.error("Şifre değiştirilirken hata:", error);
                showMessage("profileMessage", "Şifre değiştirilirken bir hata oluştu.", true);
            }
        }
        
        async function loadUserTable(username) {
          const table = document.getElementById("userTable");
          const unpaidTotalSpan = document.getElementById("userUnpaidTotal"); 
          unpaidTotalSpan.textContent = "Hesaplanıyor...";
          
          table.innerHTML = '<tr><th>Açıklama</th><th>Tutar</th><th>Durum</th></tr>';
          let totalPaid = 0;
          let totalUnpaid = 0;

          try {
            const debtSnapshot = await getDocs(collection(db, 'apartments', username, 'debts'));
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonthIndex = today.getMonth();

            if (debtSnapshot.empty) {
                table.innerHTML += '<tr><td colspan="3">Borcunuz bulunmamaktadır.</td></tr>';
                document.getElementById("userDebtTotals").textContent = `Ödenen: 0 TL | Ödenmemiş: 0 TL`;
                unpaidTotalSpan.textContent = `₺0,00`;
                return;
            }
            
            const debts = [];
            debtSnapshot.forEach(doc => debts.push(doc.data()));
            
            const filteredDebts = debts.filter(entry => {
                try {
                    const [debtMonthStr, debtYearStr] = entry.ay.split(' ');
                    if (!debtMonthStr || !debtYearStr) return false;
                    const debtYear = parseInt(debtYearStr, 10);
                    const debtMonthIndex = aylar.indexOf(debtMonthStr);
                    if (debtYear < currentYear) return true;
                    if (debtYear === currentYear && debtMonthIndex <= currentMonthIndex) return true;
                    return false;
                } catch { return false; }
            });

            if (filteredDebts.length === 0) {
                 table.innerHTML += '<tr><td colspan="3">Görüntülenecek borcunuz bulunmamaktadır.</td></tr>';
                document.getElementById("userDebtTotals").textContent = `Ödenen: 0 TL | Ödenmemiş: 0 TL`;
                unpaidTotalSpan.textContent = `₺0,00`;
                return;
            }
            
            filteredDebts.sort((a, b) => {
                const [ayA, yilA] = a.ay.split(' ');
                const [ayB, yilB] = b.ay.split(' ');
                if (yilA !== yilB) return yilA.localeCompare(yilB);
                return aylar.indexOf(ayA) - aylar.indexOf(ayB);
            });

            let tableContent = '';
            filteredDebts.forEach(entry => {
              const statusText = entry.odendi ? "Ödendi" : "Bekliyor";
              const rowClass = entry.odendi ? "" : "unpaid-debt";
              const tipFormatted = entry.tip.charAt(0).toUpperCase() + entry.tip.slice(1);
              
              tableContent += `<tr class="${rowClass}">
                                <td>${entry.ay} - ${tipFormatted}</td>
                                <td>${entry.tutar} TL</td>
                                <td>${statusText}</td>
                               </tr>`;

              if (entry.odendi) totalPaid += Number(entry.tutar);
              else totalUnpaid += Number(entry.tutar);
            });
            
            table.innerHTML += tableContent;
            
            unpaidTotalSpan.textContent = `₺${totalUnpaid.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById("userDebtTotals").textContent = `Ödenen Toplam: ${totalPaid} TL | Ödenmeyen Toplam: ${totalUnpaid} TL`;
          } catch (error) {
            console.error("Kullanıcı borçları yüklenirken hata:", error);
            showMessage("userMessage", "Borç bilgileri yüklenemedi.", true);
            unpaidTotalSpan.textContent = "Hata";
          }
        }

        async function loadUserExpensesTable() {
            const tableContainer = document.getElementById("expenseTableContainer");
            const notPublishedMsg = document.getElementById("expenseNotPublishedMessage");
            
            try {
                const publishedExpensesSnap = await getDocFromFirestore(doc(db, 'settings', 'publishedExpenses'));
                const pubData = publishedExpensesSnap.exists() ? publishedExpensesSnap.data() : { published: false };

                if (!pubData.published || !pubData.month || !pubData.year) {
                    tableContainer.classList.add('hidden');
                    notPublishedMsg.textContent = "Yönetim tarafından yayınlanmış gider bulunmamaktadır.";
                    notPublishedMsg.classList.remove('hidden');
                    return;
                } 
                
                tableContainer.classList.remove('hidden');
                notPublishedMsg.classList.add('hidden');

                const table = document.getElementById("userExpenseTable");
                table.innerHTML = '<tr><th>Tarih</th><th>Harcama Adı</th><th>Tutar</th></tr>';
                let totalExpense = 0;

                const q = query(collection(db, 'expenses'), 
                  where("tarih_ay", "==", pubData.month),
                  where("tarih_yil", "==", Number(pubData.year))
                );
                const expensesSnapshot = await getDocs(q);

                if (expensesSnapshot.empty) {
                    table.innerHTML += `<tr><td colspan="3">${pubData.month} ${pubData.year} için gider kaydı bulunmamaktadır.</td></tr>`;
                } else {
                    let expensesHtml = '';
                    expensesSnapshot.forEach(d => {
                        const expense = d.data();
                        expensesHtml += `<tr><td>${expense.tarih}</td><td>${expense.harcamaAdi}</td><td>${expense.tutar} TL</td></tr>`;
                        totalExpense += Number(expense.tutar);
                    });
                    table.innerHTML += expensesHtml;
                }
                document.getElementById("userExpenseTotals").textContent = `Toplam Gider: ${totalExpense.toFixed(2)} TL`;
            } catch (error) {
                console.error("Kullanıcı giderleri yüklenirken hata:", error);
                showMessage('userMessage', "Gider bilgileri yüklenemedi.", true);
            }
        }

        function fillFlatSelects() {
            const selects = ["flatSelect", "borcKime", "sifreDaire"];
            selects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = "";
                if(id === 'flatSelect' || id === 'borcKime'){
                    select.innerHTML += '<option value="all_apartments">Tüm Daireler</option>';
                }
                daireler.forEach(daire => select.innerHTML += `<option value="${daire}">${daire}</option>`);
            });
        }

        async function loadAdminView() {
            const selectedDaire = document.getElementById("flatSelect").value;
            if (selectedDaire === 'all_apartments') {
                await loadAllApartmentsSummary();
            } else {
                await loadAdminTable();
            }
        }

        async function loadAdminTable() {
          const daire = document.getElementById("flatSelect").value;
          if (!daire) return;

          document.getElementById('allApartmentsSummary').classList.add('hidden');
          document.getElementById('singleApartmentView').classList.remove('hidden');
          document.getElementById('userInfoDisplay').classList.remove('hidden');

          const table = document.getElementById("adminTable");
          const userInfoDisplay = document.getElementById("userInfoDisplay");
          table.innerHTML = '<tr><th>Ay</th><th>Tip</th><th>Tutar</th><th>Durum</th><th>İşlem</th></tr>';
          
          try {
            const flatDocSnap = await getDocFromFirestore(doc(db, 'apartments', daire));
            const userData = flatDocSnap.exists() ? flatDocSnap.data() : {};
            const lastLogin = userData.lastLogin ? new Date(userData.lastLogin.seconds * 1000).toLocaleString('tr-TR') : 'Hiç giriş yapmadı';
            userInfoDisplay.innerHTML = `<p><strong>Daire:</strong> ${daire}</p>
                <p><strong>Adı Soyadı:</strong> ${userData.adi || 'Bilgi Yok'} ${userData.soyadi || ''}</p>
                <p><strong>Telefon:</strong> ${userData.telefon || 'Bilgi Yok'}</p>
                <p><strong>E-posta:</strong> ${userData.mail || 'Bilgi Yok'}</p>
                <p><strong>Son Giriş:</strong> ${lastLogin}</p>
                <div class="user-profile-actions">
                  <button class="edit-btn admin-action-btn" data-action="edit-profile" data-daire="${daire}">Düzenle</button>
                  <button class="delete-btn admin-action-btn" data-action="delete-profile" data-daire="${daire}">Sil</button>
                </div>`;
            userInfoDisplay.classList.remove("hidden");

            const debtsCollectionRef = collection(db, 'apartments', daire, 'debts');
            const monthName = aylar[currentAdminDate.getMonth()];
            const year = currentAdminDate.getFullYear();
            const ayFilter = `${monthName} ${year}`;
            const q = query(debtsCollectionRef, where("ay", "==", ayFilter));

            const debtSnapshot = await getDocs(q);
            if (debtSnapshot.empty) {
                table.innerHTML += `<tr><td colspan="5">Seçili ay için borç bulunmamaktadır.</td></tr>`;
                document.getElementById("borcToplam").textContent = `Toplam: 0 TL | Ödenen: 0 TL | Kalan: 0 TL`;
                return;
            }

            let toplam = 0, odenen = 0;
            let rowsHtml = '';
            debtSnapshot.forEach(doc => {
              const entry = doc.data();
              toplam += Number(entry.tutar);
              if (entry.odendi) odenen += Number(entry.tutar);
              rowsHtml += `<tr>
                <td>${entry.ay}</td><td>${entry.tip}</td><td>${entry.tutar} TL</td>
                <td>${entry.odendi ? "Ödendi" : "Bekliyor"}</td>
                <td>
                  ${entry.odendi ? "-" : `<button class="admin-action-btn" data-action="mark-paid" data-daire="${daire}" data-id="${doc.id}">Ödendi</button>`}
                  <button class="edit-btn admin-action-btn" data-action="edit-debt" data-daire="${daire}" data-id="${doc.id}">Düzenle</button>
                  <button class="delete-btn admin-action-btn" data-action="delete-debt" data-daire="${daire}" data-id="${doc.id}">Sil</button>
                </td></tr>`;
            });
            table.innerHTML += rowsHtml;
            document.getElementById("borcToplam").textContent = `Toplam: ${toplam} TL | Ödenen: ${odenen} TL | Kalan: ${toplam - odenen} TL`;
          } catch (error) {
            console.error("Yönetici tablosu yüklenirken hata:", error);
            showMessage("adminTableMessage", "Borç bilgileri yüklenemedi.", true);
          }
        }

        async function loadAllApartmentsSummary() {
            document.getElementById('singleApartmentView').classList.add('hidden');
            document.getElementById('userInfoDisplay').classList.add('hidden');
            document.getElementById('allApartmentsSummary').classList.remove('hidden');

            const month = aylar[currentAdminDate.getMonth()];
            const year = currentAdminDate.getFullYear();
            const ayFilter = `${month} ${year}`;
            
            document.getElementById('summaryTitle').textContent = `${ayFilter} Ödeme Durumu`;

            let paidCount = 0;
            let unpaidCount = 0;
            let noRecordCount = daireler.length;

            try {
                for (const daire of daireler) {
                    const q = query(collection(db, 'apartments', daire, 'debts'), where("ay", "==", ayFilter));
                    const debtSnapshot = await getDocs(q);
                    if (!debtSnapshot.empty) {
                        noRecordCount--; 
                        let hasUnpaid = false;
                        debtSnapshot.forEach(doc => {
                            if (!doc.data().odendi) {
                                hasUnpaid = true;
                            }
                        });
                        if(hasUnpaid) unpaidCount++;
                        else paidCount++;
                    }
                }
                
                document.getElementById('paidCount').textContent = paidCount;
                document.getElementById('unpaidCount').textContent = unpaidCount;
                document.getElementById('noRecordCount').textContent = noRecordCount;

            } catch (error) {
                console.error("Genel özet yüklenirken hata:", error);
                showMessage("adminTableMessage", "Özet bilgileri yüklenemedi.", true);
            }
        }

        async function editUserProfileAsAdmin(daire) {
            const flatDocRef = doc(db, 'apartments', daire);
            const flatDocSnap = await getDocFromFirestore(flatDocRef);
            const userData = flatDocSnap.exists() ? flatDocSnap.data() : {};

            const newAdi = prompt(`Daire ${daire} için yeni ad:`, userData.adi || '');
            if (newAdi === null) return;
            const newSoyadi = prompt(`Daire ${daire} için yeni soyad:`, userData.soyadi || '');
            if (newSoyadi === null) return;
            const newTelefon = prompt(`Daire ${daire} için yeni telefon:`, userData.telefon || '');
            if (newTelefon === null) return;
            const newMail = prompt(`Daire ${daire} için yeni e-posta:`, userData.mail || '');
            if (newMail === null) return;

            try {
                await updateDoc(flatDocRef, { adi: newAdi, soyadi: newSoyadi, telefon: newTelefon, mail: newMail });
                showMessage("adminTableMessage", "Profil güncellendi.");
                loadAdminTable();
            } catch (e) {
                showMessage("adminTableMessage", "Profil güncellenemedi.", true);
            }
        }

        async function deleteUserProfileAsAdmin(daire) {
            if (confirm(`${daire} profili silinecek, emin misiniz?`)) {
                try {
                    await updateDoc(doc(db, 'apartments', daire), {
                        adi: deleteField(),
                        soyadi: deleteField(),
                        telefon: deleteField(),
                        mail: deleteField(),
                        password: deleteField()
                    });
                    showMessage("adminTableMessage", "Profil silindi.");
                    loadAdminTable();
                } catch (e) {
                    showMessage("adminTableMessage", "Profil silinemedi.", true);
                }
            }
        }

        async function markPaid(daire, debtId) {
            if (confirm("Borç ödendi olarak işaretlenecek, emin misiniz?")) {
                try {
                    await updateDoc(doc(db, 'apartments', daire, 'debts', debtId), { odendi: true });
                    showMessage("adminTableMessage", "Borç ödendi olarak işaretlendi.");
                    loadAdminView();
                } catch (e) {
                    showMessage("adminTableMessage", "İşlem başarısız.", true);
                }
            }
        }

        async function ekleBorc() {
            const daire = document.getElementById("borcKime").value;
            const month = document.getElementById("borcAySelect").value;
            const year = document.getElementById("borcYilSelect").value;
            const ay = `${month} ${year}`;
            const tutar = Number(document.getElementById("borcTutar").value);
            const tip = document.getElementById("borcTipi").value;

            if (!ay || !tutar || tutar <= 0) {
                return showMessage("addDebtMessage", "Lütfen tüm alanları doğru doldurun.", true);
            }

            const apartmentsToAdd = (daire === "all_apartments") ? daireler : [daire];
            const batch = writeBatch(db);
            let successCount = 0;
            try {
                for (const flat of apartmentsToAdd) {
                    const q = query(collection(db, 'apartments', flat, 'debts'), where("ay", "==", ay), where("tip", "==", tip));
                    const existing = await getDocs(q);
                    if (existing.empty) {
                        const newDebtRef = doc(collection(db, 'apartments', flat, 'debts'));
                        batch.set(newDebtRef, { ay, tutar, tip, odendi: false });
                        successCount++;
                    }
                }
                if (successCount > 0) {
                    await batch.commit();
                    showMessage("addDebtMessage", `${successCount} daireye borç eklendi.`);
                    loadAdminView();
                } else {
                    showMessage("addDebtMessage", "Seçili daire(ler) için bu borç zaten mevcut.", true);
                }
            } catch (e) {
                showMessage("addDebtMessage", "Borç eklenemedi.", true);
            }
        }

        async function silBorc(daire, debtId) {
            if (confirm("Bu borç kaydı silinecek, emin misiniz?")) {
                try {
                    await deleteDoc(doc(db, 'apartments', daire, 'debts', debtId));
                    showMessage("adminTableMessage", "Borç silindi.");
                    loadAdminView();
                } catch (e) {
                    showMessage("adminTableMessage", "Borç silinemedi.", true);
                }
            }
        }

        async function editDebt(daire, debtId) {
            const debtDoc = await getDocFromFirestore(doc(db, 'apartments', daire, 'debts', debtId));
            if (!debtDoc.exists()) return showMessage("adminTableMessage", "Borç bulunamadı.", true);
            const current = debtDoc.data();

            const newAy = prompt("Ay:", current.ay);
            if (newAy === null) return;
            const newTutar = prompt("Tutar:", current.tutar);
            if (newTutar === null || isNaN(Number(newTutar)) || Number(newTutar) <= 0) return showMessage("adminTableMessage", "Geçersiz tutar.", true);
            const newTip = prompt("Tip (aidat/avans):", current.tip);
            if (newTip === null || !['aidat', 'avans'].includes(newTip)) return showMessage("adminTableMessage", "Geçersiz tip.", true);

            try {
                await updateDoc(doc(db, 'apartments', daire, 'debts', debtId), { ay: newAy, tutar: Number(newTutar), tip: newTip });
                showMessage("adminTableMessage", "Borç güncellendi.");
                loadAdminView();
            } catch (e) {
                showMessage("adminTableMessage", "Borç güncellenemedi.", true);
            }
        }
        
        async function deleteAllDebts() {
            if (confirm("TÜM BORÇLAR SİLİNECEK! Bu işlem geri alınamaz. Emin misiniz?")) {
                const batch = writeBatch(db);
                for (const daire of daireler) {
                    const debtSnapshot = await getDocs(collection(db, 'apartments', daire, 'debts'));
                    debtSnapshot.forEach(d => batch.delete(d.ref));
                }
                await batch.commit();
                showMessage("adminTableMessage", "Tüm borçlar silindi.");
                loadAdminView();
            }
        }
        
        async function downloadMonthlyReportPdf() {
            const { jsPDF } = window.jspdf;
            const pdfDoc = new jsPDF();
            if (typeof pdfDoc.autoTable !== 'function') {
                return showMessage("adminTableMessage", "PDF tablo eklentisi yüklenemedi.", true);
            }
            
            const month = aylar[currentAdminDate.getMonth()];
            const year = currentAdminDate.getFullYear();
            const ayFilter = `${month} ${year}`;
            showMessage("adminTableMessage", `${ayFilter} için rapor oluşturuluyor...`, false);
            
            const paidData = [];
            const unpaidData = [];

            for(const daire of daireler) {
                const q = query(collection(db, 'apartments', daire, 'debts'), where("ay", "==", ayFilter));
                const debtSnapshot = await getDocs(q);
                if(!debtSnapshot.empty) {
                     debtSnapshot.forEach(d => {
                        const entry = d.data();
                        const row = [daire, entry.tip, `${entry.tutar} TL`];
                        if(entry.odendi) {
                            paidData.push(row);
                        } else {
                            unpaidData.push(row);
                        }
                    });
                }
            }
            
            pdfDoc.setFont('helvetica', 'normal');

            const title = `Aylık Borç Raporu - ${ayFilter}`;
            const pageWidth = pdfDoc.internal.pageSize.getWidth();
            pdfDoc.setFontSize(18);
            pdfDoc.text(title, pageWidth / 2, 20, { align: 'center', maxWidth: pageWidth - 20 });
            
            pdfDoc.setFontSize(12);
            pdfDoc.text(`Tarih: ${new Date().toLocaleDateString('tr-TR')}`, pageWidth / 2, 28, { align: "center" });

            pdfDoc.autoTable({
                head: [
                    [{ content: 'Ödeme Yapanlar', colSpan: 3, styles: { halign: 'center', fontStyle: 'bold' } }],
                    ['Daire', 'Tip', 'Tutar']
                ],
                body: paidData,
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [40, 167, 69] },
                styles: { font: 'helvetica' },
            });
            
            pdfDoc.autoTable({
                head: [
                    [{ content: 'Ödeme Yapmayanlar', colSpan: 3, styles: { halign: 'center', fontStyle: 'bold' } }],
                    ['Daire', 'Tip', 'Tutar']
                ],
                body: unpaidData,
                startY: pdfDoc.autoTable.previous.finalY + 15,
                theme: 'grid',
                headStyles: { fillColor: [220, 53, 69] },
                styles: { font: 'helvetica' },
            });


            pdfDoc.save(`Aylik_Rapor_${month}_${year}.pdf`);
            showMessage("adminTableMessage", "PDF indirildi.");
        }


        async function downloadAccountStatementPdf() {
            const selectedDaire = document.getElementById("flatSelect").value;
            if (selectedDaire === 'all_apartments') {
                return showMessage("adminTableMessage", "Lütfen belirli bir daire seçin.", true);
            }

            const year = currentAdminDate.getFullYear();
            showMessage("adminTableMessage", `${selectedDaire} için ${year} yılı hesap ekstresi oluşturuluyor...`);

            const { jsPDF } = window.jspdf;
            const pdfDoc = new jsPDF();

            const debtData = [];
            let totalBorc = 0;
            let totalOdenen = 0;

            try {
                const debtsCollectionRef = collection(db, 'apartments', selectedDaire, 'debts');
                const debtSnapshot = await getDocs(debtsCollectionRef);

                debtSnapshot.forEach(d => {
                    const entry = d.data();
                    const [debtMonthStr, debtYearStr] = entry.ay.split(' ');
                    if (parseInt(debtYearStr, 10) === year) {
                        debtData.push(entry);
                        totalBorc += Number(entry.tutar);
                        if(entry.odendi) {
                            totalOdenen += Number(entry.tutar);
                        }
                    }
                });

                if(debtData.length === 0) {
                    return showMessage("adminTableMessage", `Seçilen daire için ${year} yılında kayıt bulunamadı.`, true);
                }

                debtData.sort((a, b) => {
                    const [ayA] = a.ay.split(' ');
                    const [ayB] = b.ay.split(' ');
                    return aylar.indexOf(ayA) - aylar.indexOf(ayB);
                });

                const tableBody = debtData.map(entry => {
                    return [
                        entry.ay,
                        entry.tip.charAt(0).toUpperCase() + entry.tip.slice(1),
                        `${Number(entry.tutar).toFixed(2)} TL`,
                        entry.odendi ? 'Ödendi' : 'Ödenmedi'
                    ];
                });

                const flatDocSnap = await getDocFromFirestore(doc(db, 'apartments', selectedDaire));
                const userData = flatDocSnap.exists() ? flatDocSnap.data() : {};
                const malik = `${userData.adi || ''} ${userData.soyadi || ''}`.trim();

                pdfDoc.setFont('helvetica');

                pdfDoc.setFontSize(18);
                pdfDoc.text(`Hesap Ekstresi - ${year}`, 105, 20, { align: "center" });
                pdfDoc.setFontSize(12);
                pdfDoc.text(`Daire: ${selectedDaire}${malik ? ` (${malik})` : ''}`, 14, 30);
                pdfDoc.text(`Tarih: ${new Date().toLocaleDateString('tr-TR')}`, 196, 30, { align: 'right' });


                pdfDoc.autoTable({
                    head: [['Ay', 'Açıklama', 'Tutar', 'Durum']],
                    body: tableBody,
                    startY: 40,
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: 10 },
                    headStyles: { fillColor: [1, 79, 134] },
                    didParseCell: function(data) {
                        if (data.section === 'body' && data.column.index === 3) {
                            if (data.cell.raw === 'Ödenmedi') {
                                data.cell.styles.textColor = [220, 53, 69];
                                data.cell.styles.fontStyle = 'bold';
                            } else if (data.cell.raw === 'Ödendi') {
                                 data.cell.styles.textColor = [40, 167, 69];
                            }
                        }
                    }
                });

                let finalY = pdfDoc.autoTable.previous.finalY;
                pdfDoc.setFontSize(12);
                pdfDoc.text(`Yıllık Toplam Borç: ${totalBorc.toFixed(2)} TL`, 14, finalY + 10);
                pdfDoc.text(`Yıllık Toplam Ödenen: ${totalOdenen.toFixed(2)} TL`, 14, finalY + 17);
                pdfDoc.setFontSize(14);
                pdfDoc.setFont(undefined, 'bold');
                pdfDoc.text(`Kalan Bakiye: ${(totalBorc - totalOdenen).toFixed(2)} TL`, 14, finalY + 25);


                const filename = `Hesap_Ekstresi_${selectedDaire}_${year}.pdf`;
                pdfDoc.save(filename);
                showMessage("adminTableMessage", "Hesap ekstresi PDF olarak indirildi.");


            } catch (error) {
                console.error("Hesap ekstresi oluşturulurken hata:", error);
                showMessage("adminTableMessage", "PDF oluşturulurken bir hata oluştu.", true);
            }
        }

        function downloadProfileTemplate() {
            const headers = "Daire,Ad,Soyad,Telefon,Mail";
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers + "\n";
            daireler.forEach(daire => {
                csvContent += `${daire},,,,\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "profil_sablonu.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage("adminTableMessage", "Profil şablonu indirildi.");
        }

        async function uploadProfileTemplate(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const rows = text.split('\n').slice(1);
                const batch = writeBatch(db);
                let updatedCount = 0;
                for (const row of rows) {
                    if (!row.trim()) continue;
                    const columns = row.split(',');
                    const daireId = columns[0] ? columns[0].trim().toUpperCase() : '';
                    const adi = columns[1] ? columns[1].trim() : '';
                    const soyadi = columns[2] ? columns[2].trim() : '';
                    const telefon = columns[3] ? columns[3].trim() : '';
                    const mail = columns[4] ? columns[4].trim() : '';
                    if (daireler.includes(daireId) && (adi || soyadi || telefon || mail)) {
                        const flatDocRef = doc(db, 'apartments', daireId);
                        const updateData = {};
                        if (adi) updateData.adi = adi;
                        if (soyadi) updateData.soyadi = soyadi;
                        if (telefon) updateData.telefon = telefon;
                        if (mail) updateData.mail = mail;
                        batch.set(flatDocRef, updateData, { merge: true });
                        updatedCount++;
                    }
                }
                if (updatedCount > 0) {
                    try {
                        await batch.commit();
                        showMessage("adminTableMessage", `${updatedCount} daire profili başarıyla güncellendi.`);
                        loadAdminView();
                    } catch (error) {
                        console.error("Profil şablonu yüklenirken hata:", error);
                        showMessage("adminTableMessage", "Profiller güncellenirken bir hata oluştu.", true);
                    }
                } else {
                    showMessage("adminTableMessage", "Dosyada güncellenecek geçerli bir bilgi bulunamadı.", true);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        async function backupData() { /* ... */ }
        async function restoreData(event) { /* ... */ }

        async function saveExpense() {
            const dateInput = document.getElementById("expenseDateInput").value;
            const name = document.getElementById("expenseNameInput").value.trim();
            const amount = Number(document.getElementById("expenseAmountInput").value);
            if (!dateInput || !name || !amount || amount <= 0) {
                return showMessage("expenseMessage", "Lütfen tüm alanları doğru doldurun.", true);
            }
            const date = new Date(dateInput);
            try {
                await addDoc(collection(db, 'expenses'), {
                    tarih: dateInput,
                    harcamaAdi: name,
                    tutar: amount,
                    tarih_ay: aylar[date.getMonth()],
                    tarih_yil: date.getFullYear(),
                    timestamp: new Date()
                });
                showMessage("expenseMessage", "Gider kaydedildi.");
                loadAdminExpensesTable(aylar[date.getMonth()], date.getFullYear());
            } catch (e) {
                showMessage("expenseMessage", "Gider kaydedilemedi.", true);
            }
        }

        async function loadAdminExpensesTable(month, year) {
            const table = document.getElementById("adminExpenseTable");
            const publishButton = document.getElementById("publishButton");
            table.innerHTML = '<tr><th>Tarih</th><th>Harcama Adı</th><th>Tutar</th><th>İşlem</th></tr>';
            let totalExpense = 0;

            const pubSnap = await getDocFromFirestore(doc(db, 'settings', 'publishedExpenses'));
            let publishedExpenseData = pubSnap.exists() ? pubSnap.data() : { published: false };
            const isPublished = publishedExpenseData.published && publishedExpenseData.month === month && publishedExpenseData.year === Number(year);
            publishButton.textContent = isPublished ? 'Yayından Kaldır' : 'Yayınla';

            const q = query(collection(db, 'expenses'), where("tarih_ay", "==", month), where("tarih_yil", "==", Number(year)));
            const expensesSnapshot = await getDocs(q);
            if (expensesSnapshot.empty) {
                table.innerHTML += '<tr><td colspan="4">Gider kaydı yok.</td></tr>';
            } else {
                let rowsHtml = '';
                expensesSnapshot.forEach(d => {
                    const expense = d.data();
                    rowsHtml += `<tr><td>${expense.tarih}</td><td>${expense.harcamaAdi}</td><td>${expense.tutar} TL</td>
                                 <td><button class="delete-btn admin-action-btn" data-action="delete-expense" data-id="${d.id}">Sil</button></td></tr>`;
                    totalExpense += Number(expense.tutar);
                });
                table.innerHTML += rowsHtml;
            }
            document.getElementById("adminExpenseTotals").textContent = `Toplam Gider: ${totalExpense} TL`;
        }
        
        async function deleteExpense(expenseId) {
            if (confirm("Gider silinecek, emin misiniz?")) {
                try {
                    await deleteDoc(doc(db, 'expenses', expenseId));
                    showMessage("expenseMessage", "Gider silindi.");
                    loadAdminExpensesTable(document.getElementById('expenseMonthFilter').value, document.getElementById('expenseYearFilter').value);
                } catch (e) {
                    showMessage("expenseMessage", "Gider silinemedi.", true);
                }
            }
        }

        async function toggleExpensesVisibility() {
            const month = document.getElementById('expenseMonthFilter').value;
            const year = Number(document.getElementById('expenseYearFilter').value);
            const pubRef = doc(db, 'settings', 'publishedExpenses');
            const pubSnap = await getDocFromFirestore(pubRef);
            const pubData = pubSnap.exists() ? pubSnap.data() : { published: false, month: null, year: null };
            const isPublished = pubData.published && pubData.month === month && pubData.year === year;

            try {
                if (isPublished) {
                    await setDoc(pubRef, { published: false, month: null, year: null });
                    showMessage("expenseMessage", "Giderler yayından kaldırıldı.");
                } else {
                    await setDoc(pubRef, { published: true, month, year });
                    showMessage("expenseMessage", "Giderler yayınlandı.");
                }
                loadAdminExpensesTable(month, year);
            } catch (e) {
                showMessage("expenseMessage", "İşlem başarısız.", true);
            }
        }

        async function calculateAndShowBalance() {
            let totalIncome = 0;
            let totalExpenses = 0;

            for (const daire of daireler) {
                const q = query(collection(db, 'apartments', daire, 'debts'), where("odendi", "==", true));
                const paidDebts = await getDocs(q);
                paidDebts.forEach(d => totalIncome += Number(d.data().tutar));
            }

            const allExpenses = await getDocs(collection(db, 'expenses'));
            allExpenses.forEach(d => totalExpenses += Number(d.data().tutar));
            
            const balance = totalIncome - totalExpenses;
            document.getElementById("totalIncome").textContent = `${totalIncome.toFixed(2)} TL`;
            document.getElementById("totalExpense").textContent = `${totalExpenses.toFixed(2)} TL`;
            document.getElementById("remainingBalance").textContent = `${balance.toFixed(2)} TL`;
            document.getElementById("remainingBalance").style.color = balance < 0 ? 'var(--danger-color)' : 'var(--success-color)';
        }
        
        async function updateAdminDashboard() {
            const currentDate = new Date();
            const currentMonth = aylar[currentDate.getMonth()];
            const currentYear = currentDate.getFullYear();
            
            let totalIncomeAll = 0, totalExpenseAll = 0, monthlyIncome = 0, monthlyExpense = 0;
            const unpaidApartments = new Set();
            
            for (const daire of daireler) {
                const debtsSnapshot = await getDocs(collection(db, 'apartments', daire, 'debts'));
                debtsSnapshot.forEach(d => {
                    const debt = d.data();
                    if (debt.odendi) {
                        totalIncomeAll += Number(debt.tutar);
                    }
                    if (debt.ay === `${currentMonth} ${currentYear}`) {
                         if (debt.odendi) {
                            monthlyIncome += Number(debt.tutar);
                         } else {
                            unpaidApartments.add(daire);
                         }
                    }
                });
            }
            
            const expensesSnapshot = await getDocs(collection(db, 'expenses'));
            expensesSnapshot.forEach(d => {
                const expense = d.data();
                totalExpenseAll += Number(expense.tutar);
                if (expense.tarih_ay === currentMonth && expense.tarih_yil === currentYear) {
                    monthlyExpense += Number(expense.tutar);
                }
            });
            
            const totalBalance = totalIncomeAll - totalExpenseAll;

            document.getElementById('dashboardTotalBalance').textContent = `₺${totalBalance.toFixed(2)}`;
            document.getElementById('dashboardMonthlyIncome').textContent = `₺${monthlyIncome.toFixed(2)}`;
            document.getElementById('dashboardMonthlyExpense').textContent = `₺${monthlyExpense.toFixed(2)}`;
            document.getElementById('dashboardUnpaidCount').textContent = unpaidApartments.size;
        }

        async function applyLateFees() {
            if (!confirm("Geçmiş aylara ait ödenmemiş tüm borçlara %5 gecikme faizi uygulanacaktır. Bu işlem geri alınamaz. Emin misiniz?")) {
                return;
            }
            
            showMessage("addDebtMessage", "Gecikme faizleri hesaplanıyor ve uygulanıyor...", false);

            const currentDate = new Date();
            const currentMonthIndex = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            const currentAy = `${aylar[currentMonthIndex]} ${currentYear}`;
            
            const batch = writeBatch(db);
            let feeAppliedCount = 0;

            try {
                for (const daire of daireler) {
                    const debtsRef = collection(db, 'apartments', daire, 'debts');
                    const q = query(debtsRef, where("odendi", "==", false), where("gecikmeFaiziUygulandi", "!=", true));
                    const unpaidDebtsSnap = await getDocs(q);

                    unpaidDebtsSnap.forEach(debtDoc => {
                        const debt = debtDoc.data();
                        const [debtMonthStr, debtYearStr] = debt.ay.split(' ');
                        const debtYear = parseInt(debtYearStr, 10);
                        const debtMonthIndex = aylar.indexOf(debtMonthStr);

                        const isPastDue = debtYear < currentYear || (debtYear === currentYear && debtMonthIndex < currentMonthIndex);

                        if (isPastDue) {
                            const lateFee = Number(debt.tutar) * 0.05;
                            const newFeeRef = doc(collection(db, 'apartments', daire, 'debts'));
                            batch.set(newFeeRef, {
                                ay: currentAy,
                                tutar: parseFloat(lateFee.toFixed(2)),
                                tip: 'gecikme-faizi',
                                odendi: false,
                                aciklama: `${debt.ay} borcu için gecikme bedeli`
                            });
                            
                            batch.update(debtDoc.ref, { gecikmeFaiziUygulandi: true });
                            feeAppliedCount++;
                        }
                    });
                }

                if (feeAppliedCount > 0) {
                    await batch.commit();
                    showMessage("addDebtMessage", `${feeAppliedCount} adet borca gecikme faizi başarıyla uygulandı.`);
                } else {
                    showMessage("addDebtMessage", "Gecikme faizi uygulanacak yeni borç bulunamadı.", true);
                }
                await updateAdminDashboard();
            } catch (error) {
                console.error("Gecikme faizi uygulanırken hata:", error);
                showMessage("addDebtMessage", "İşlem sırasında bir hata oluştu.", true);
            }
        }


        async function downloadAllExpensesPdf() {
            showMessage("expenseMessage", "Tüm giderler için PDF oluşturuluyor...", false);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const expenseData = [];
            let totalExpense = 0;
            try {
                const expensesSnapshot = await getDocs(collection(db, 'expenses'));
                expensesSnapshot.forEach(doc => {
                    const expense = doc.data();
                    expenseData.push([
                        expense.tarih,
                        expense.harcamaAdi,
                        `${Number(expense.tutar).toFixed(2)} TL`
                    ]);
                    totalExpense += Number(expense.tutar);
                });

                expenseData.sort((a, b) => new Date(a[0]) - new Date(b[0]));

                doc.autoTable({
                    head: [['Tarih', 'Harcama Adı', 'Tutar']],
                    body: expenseData,
                    didDrawPage: function (data) {
                        doc.setFontSize(18);
                        doc.text("Ayvalık Yıldız Konakları - Tüm Giderler Listesi", 105, 20, { align: "center" });
                        doc.setFontSize(12);
                        doc.text(`Tarih: ${new Date().toLocaleDateString('tr-TR')}`, 105, 28, { align: "center" });
                    },
                    startY: 35,
                    theme: 'grid',
                    foot: [['', 'Toplam Gider', `${totalExpense.toFixed(2)} TL`]],
                    footStyles: { fontStyle: 'bold', fillColor: [219, 233, 244] }
                });
                
                const filename = `Yildiz_Konaklari_Tum_Giderler_${new Date().toLocaleDateString('tr-TR')}.pdf`;
                doc.save(filename);
                showMessage("expenseMessage", "Tüm giderler PDF dosyası başarıyla indirildi.");

            } catch (error) {
                console.error("Tüm giderler PDF'i oluşturulurken hata:", error);
                showMessage("expenseMessage", "PDF oluşturulurken bir hata oluştu.", true);
            }
        }
        
        async function setupUserPanel() {
            try {
                const flatDocSnap = await getDocFromFirestore(doc(db, 'apartments', loggedInUsername));
                const userData = flatDocSnap.exists() ? flatDocSnap.data() : {};
                
                document.getElementById("login").classList.add("hidden");
                document.getElementById("adminPanel").classList.add("hidden");
                document.getElementById("userPanel").classList.remove("hidden");

                document.getElementById("userNameDisplay").textContent = loggedInUsername;
                document.getElementById("userFullNameDisplay").textContent = `, ${userData.adi || ''} ${userData.soyadi || ''}`;
                
                document.getElementById('balanceSummary').addEventListener('click', function() {
                    this.classList.toggle('active');
                    document.getElementById('debtDetails').classList.toggle('active');
                });

                showPage('debtPage');
                document.getElementById('showDebtBtn').addEventListener('click', () => { showPage('debtPage'); loadUserTable(loggedInUsername); });
                document.getElementById('showProfileBtn').addEventListener('click', () => { showPage('profilePage'); loadUserProfile(); });
                document.getElementById('showExpensesBtn').addEventListener('click', () => { showPage('expensesPage'); loadUserExpensesTable(); });
                
                await checkProfileAndToggleExpensesButton();
                await loadUserTable(loggedInUsername);
            } catch (error) {
                console.error("Kullanıcı paneli kurulurken hata:", error);
                showMessage('userMessage', 'Panel yüklenirken bir hata oluştu. Lütfen tekrar deneyin.', true);
                logout();
            }
        }

        async function setupAdminPanel() {
            try {
                document.getElementById("login").classList.add("hidden");
                document.getElementById("userPanel").classList.add("hidden");
                document.getElementById("adminPanel").classList.remove("hidden");
                fillFlatSelects();
                fillExpenseFilters();
                fillBorcEkleDateFilters();
                updateAdminDateDisplay();
                loadAdminExpensesTable(document.getElementById('expenseMonthFilter').value, document.getElementById('expenseYearFilter').value);
                await updateAdminDashboard();
                await loadAdminView();
            } catch(error) {
                console.error("Admin paneli kurulurken hata:", error);
                showMessage('loginMessage', 'Admin paneli yüklenirken bir hata oluştu.', true);
                logout();
            }
        }
        
        function addEventListeners() {
            document.getElementById('loginButton').addEventListener('click', login);
            document.getElementById('logoutBtnUser').addEventListener('click', logout);
            document.getElementById('logoutBtnAdmin').addEventListener('click', logout);
            document.getElementById('saveProfileBtn').addEventListener('click', saveUserProfile);
            document.getElementById('changePasswordBtn').addEventListener('click', changeUserPassword);
            document.getElementById('addDebtBtn').addEventListener('click', ekleBorc);
            document.getElementById('applyLateFeeBtn').addEventListener('click', applyLateFees);
            document.getElementById('flatSelect').addEventListener('change', loadAdminView);
            document.getElementById('prevMonthBtn').addEventListener('click', () => {
                currentAdminDate.setMonth(currentAdminDate.getMonth() - 1);
                updateAdminDateDisplay();
            });
            document.getElementById('nextMonthBtn').addEventListener('click', () => {
                currentAdminDate.setMonth(currentAdminDate.getMonth() + 1);
                updateAdminDateDisplay();
            });

            document.getElementById('downloadAccountStatementBtn').addEventListener('click', downloadAccountStatementPdf);
            document.getElementById('downloadMonthlyReportBtn').addEventListener('click', downloadMonthlyReportPdf);
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadProfileTemplate);
            document.getElementById('uploadTemplateBtn').addEventListener('click', () => document.getElementById('profileTemplateInput').click());
            document.getElementById('profileTemplateInput').addEventListener('change', uploadProfileTemplate);
            document.getElementById('saveExpenseBtn').addEventListener('click', saveExpense);
            document.getElementById('filterExpensesBtn').addEventListener('click', () => loadAdminExpensesTable(document.getElementById('expenseMonthFilter').value, document.getElementById('expenseYearFilter').value));
            document.getElementById('publishButton').addEventListener('click', toggleExpensesVisibility);
            document.getElementById('downloadAllExpensesBtn').addEventListener('click', downloadAllExpensesPdf);
            document.getElementById('deleteAllDebtsBtn').addEventListener('click', deleteAllDebts);
            document.getElementById('savePasswordBtn').addEventListener('click', sifreAyarla);
            document.getElementById('saveAdminPasswordBtn').addEventListener('click', setAdminPassword);
            
             document.getElementById('loginTerms').addEventListener('change', function() {
                document.getElementById('loginButton').disabled = !this.checked;
            });

            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', (event) => {
                    if (event.target.closest('.refresh-icon')) { return; }
                    const content = header.nextElementSibling;
                    header.classList.toggle('active');
                    content.classList.toggle('active');
                    content.style.maxHeight = content.classList.contains('active') ? content.scrollHeight + "px" : null;
                    if (header.id === 'balanceSectionHeader' && header.classList.contains('active')) {
                        calculateAndShowBalance();
                    }
                });
            });
            
            document.getElementById('refreshBalanceBtn').addEventListener('click', calculateAndShowBalance);
            document.getElementById('refreshDashboardBtn').addEventListener('click', updateAdminDashboard);

            document.getElementById('adminPanel').addEventListener('click', function(event) {
                const target = event.target.closest('.admin-action-btn');
                if (!target) return;
                const action = target.dataset.action;
                const daire = target.dataset.daire;
                const id = target.dataset.id;
                if (action === 'edit-profile') editUserProfileAsAdmin(daire);
                else if (action === 'delete-profile') deleteUserProfileAsAdmin(daire);
                else if (action === 'mark-paid') markPaid(daire, id);
                else if (action === 'edit-debt') editDebt(daire, id);
                else if (action === 'delete-debt') silBorc(daire, id);
                else if (action === 'delete-expense') deleteExpense(id);
            });
            
            const modal = document.getElementById('termsModal');
            document.getElementById('openTermsModal').addEventListener('click', (e) => {
                e.preventDefault();
                modal.style.display = 'block';
            });
            document.getElementById('modalCloseBtn').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        async function sifreAyarla() {
            const daire = document.getElementById("sifreDaire").value;
            const yeniSifre = document.getElementById("yeniSifre").value;
            if (yeniSifre.length < 3) return showMessage("passwordMessage", "Şifre en az 3 karakter olmalı.", true);
            try {
                await setDoc(doc(db, 'apartments', daire), { password: yeniSifre }, { merge: true });
                showMessage("passwordMessage", `${daire} şifresi güncellendi.`);
            } catch (e) {
                showMessage("passwordMessage", "Şifre güncellenemedi.", true);
            }
        }

        async function setAdminPassword() {
            const newPass = document.getElementById("adminYeniSifre").value;
            if (newPass.length < 5) return showMessage("passwordMessage", "Şifre en az 5 karakter olmalı.", true);
            try {
                await setDoc(doc(db, 'admin', 'credentials'), { password: newPass }, { merge: true });
                adminCredentials.password = newPass;
                showMessage("passwordMessage", "Yönetici şifresi güncellendi.");
            } catch (e) {
                showMessage("passwordMessage", "Şifre güncellenemedi.", true);
            }
        }
        
        async function initialize() {
            try {
                const adminDoc = await getDocFromFirestore(doc(db, 'admin', 'credentials'));
                if (adminDoc.exists()) {
                    adminCredentials = adminDoc.data();
                } else {
                    await setDoc(doc(db, 'admin', 'credentials'), adminCredentials);
                }
            } catch (error) {
                console.error("Sistem başlatılırken hata:", error);
                showMessage('loginMessage', 'Sistem başlatılırken bir hata oluştu.', true);
            }
        }

        addEventListeners();
        initialize();
    });
  </script>
</body>
</html>

