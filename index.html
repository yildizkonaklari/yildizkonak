<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Ayvalık Yıldız Konakları - Aidat Takip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #014f86;
      --secondary-color: #468faf;
      --background-color: #f0f4f8;
      --container-bg: #fff8f0;
      --text-color: #333;
      --border-color: #ccc;
      --hover-color: #014f86;
      --danger-color: #dc3545;
      --danger-hover: #c82333;
      --success-color: #28a745;
      --success-hover: #218838;
      --info-color: #17a2b8;
      --info-hover: #138496;
      --warning-color: #ffc107;
      --warning-hover: #e0a800;
      --publish-bg: #e67e22;
      --publish-hover: #d35400;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--background-color);
      color: var(--text-color);
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: var(--container-bg);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1, h2, h3, h4, h5 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    h1 {
        font-size: 2.2rem;
    }
     h2 {
        font-size: 1.5rem;
        margin-top: -10px;
    }
    h5 {
        text-align: left;
        margin-top: 15px;
        margin-bottom: 5px;
    }
    input, select, button {
      padding: 12px;
      margin: 8px 0;
      width: 100%;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      font-size: 16px;
    }
    button {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: var(--hover-color);
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .hidden { display: none !important; }
    .totals {
      margin-top: 20px;
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
    }
    .delete-btn { background-color: var(--danger-color); }
    .delete-btn:hover:not(:disabled) { background-color: var(--danger-hover); }
    .edit-btn { background-color: var(--warning-color); color: var(--text-color); }
    .edit-btn:hover:not(:disabled) { background-color: var(--warning-hover); }
    .download-btn, .backup-btn { background-color: var(--success-color); }
    .download-btn:hover:not(:disabled), .backup-btn:hover:not(:disabled) { background-color: var(--success-hover); }
    .upload-btn { background-color: var(--info-color); }
    .upload-btn:hover:not(:disabled) { background-color: var(--info-hover); }
    .info-btn { background-color: var(--info-color); }
    .info-btn:hover:not(:disabled) { background-color: var(--info-hover); }
    .message { text-align: center; color: var(--success-color); margin-top: 10px; font-weight: bold; }
    .error-message { text-align: center; color: var(--danger-color); margin-top: 10px; font-weight: bold; }
    .bank-info { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px dashed var(--border-color); font-size: 0.9em; color: #555; }
    .section-divider { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); }
    .collapsible-header {
      background-color: #dbe9f4;
      color: var(--primary-color);
      cursor: pointer;
      padding: 18px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 18px;
      border-radius: 6px;
      margin-top: 15px;
      transition: background-color 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .collapsible-header:hover { background-color: #c0d8eb; }
    .collapsible-content {
      padding: 0 18px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
      background-color: #f7f9fc;
      border-radius: 6px;
    }
    .collapsible-content.active {
      max-height: 1500px; 
      padding: 18px;
    }
    .collapsible-header:after {
      content: '+';
      font-weight: bold;
      font-size: 24px;
      margin-left: 5px;
    }
    .collapsible-header.active:after { content: '-'; }
    .user-profile-display {
      background: #e9f2fa;
      border: 1px solid #c0d8eb;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 1.1em;
      text-align: center;
    }
    .user-profile-display p {
      margin: 5px 0;
    }
    
    .publish-btn {
      background-color: var(--publish-bg);
      color: white;
    }
    .publish-btn:hover {
      background-color: var(--publish-hover);
    }
    .balance-summary-card {
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .balance-summary-card:hover {
        background-color: #f8f9fa;
    }
    .summary-title {
        font-size: 1em;
        color: var(--text-color);
        display: block;
    }
    .summary-amount {
        font-size: 1.8em;
        font-weight: bold;
        color: var(--danger-color);
    }
    .summary-arrow {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-color);
        transition: transform 0.2s ease-out;
    }
    .balance-summary-card.active .summary-arrow {
        transform: rotate(180deg);
    }
    .collapsible-debt-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background-color: #fdfdfd;
        border-radius: 6px;
    }
    .collapsible-debt-details.active {
        max-height: 1500px;
        padding: 15px;
        border: 1px solid #eee;
    }
    .profile-info-text {
        background-color: #e9ecef;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #ced4da;
        margin: 8px 0;
        text-align: center;
    }
    .refresh-icon {
        margin-left: auto;
        padding: 0 10px;
        font-size: 24px;
        line-height: 1;
        font-weight: bold;
        color: var(--primary-color);
        cursor: pointer;
        border-radius: 50%;
        transition: transform 0.5s ease, background-color 0.2s;
    }
    .refresh-icon:hover {
        background-color: rgba(0,0,0,0.08);
        transform: rotate(360deg);
    }
    .collapsible-header > span:first-child {
        flex-grow: 1;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 90%;
        max-width: 700px;
        border-radius: 10px;
        position: relative;
    }
    .modal-content h4 { text-align: left; }
    .modal-close {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .terms-box {
        height: 200px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #f9f9f9;
        margin-bottom: 10px;
    }
    .terms-label {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
    }
    input[type="checkbox"] {
        width: auto;
    }
    #openTermsModal {
        color: var(--primary-color);
        text-decoration: underline;
        cursor: pointer;
    }
     .month-selector {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #fff;
        padding: 10px;
        border-radius: 8px;
        margin: 15px 0;
        border: 1px solid var(--border-color);
    }
    .month-selector button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--primary-color);
        padding: 0 15px;
    }
    .month-selector span {
        font-size: 1.2em;
        font-weight: bold;
        color: var(--text-color);
    }
    .all-apartments-summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        padding: 10px 0;
    }
    .summary-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        border-left: 5px solid;
    }
    .summary-card.paid { border-color: var(--success-color); }
    .summary-card.unpaid { border-color: var(--danger-color); }
    .summary-card.no-record { border-color: var(--border-color); }
    .summary-card-title {
        font-size: 1em;
        color: #666;
        margin-bottom: 8px;
    }
    .summary-card-value {
        font-size: 2.5em;
        font-weight: bold;
    }
    .summary-card.paid .summary-card-value { color: var(--success-color); }
    .summary-card.unpaid .summary-card-value { color: var(--danger-color); }
    .summary-card.no-record .summary-card-value { color: var(--text-color); }
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        padding: 10px 0;
    }
    .dashboard-card {
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-left: 5px solid var(--primary-color);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .dashboard-card-title {
        font-size: 0.9em;
        color: #555;
        text-align: center;
        margin-bottom: 10px;
    }
    .dashboard-card-value {
        font-size: 1.8em;
        font-weight: bold;
        color: var(--primary-color);
    }
    .setting-toggle-container {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: #fdfdfd;
    }
    .toggle-label-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .toggle-switch-label {
        font-size: 1.1em;
        font-weight: bold;
        color: var(--primary-color);
    }
    .setting-description {
        font-size: 0.9em;
        color: #555;
        margin: 5px 0;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
    }
    input:checked + .slider {
      background-color: var(--success-color);
    }
    input:focus + .slider {
      box-shadow: 0 0 1px var(--success-color);
    }
    input:checked + .slider:before {
      -webkit-transform: translateX(26px);
      -ms-transform: translateX(26px);
      transform: translateX(26px);
    }
    .slider.round {
      border-radius: 34px;
    }
    .slider.round:before {
      border-radius: 50%;
    }

    .debt-list-container {
        margin-top: 20px;
    }
    .debt-card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.07);
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid;
    }
    .debt-card.paid {
        border-left-color: var(--success-color);
    }
    .debt-card.unpaid {
        border-left-color: var(--danger-color);
    }
    .debt-card-info {
        flex-grow: 1;
    }
    .debt-card-info .description {
        font-weight: bold;
        font-size: 1.1em;
        display: block;
        color: var(--text-color);
    }
    .debt-card-info .type {
        font-size: 0.9em;
        color: #6c757d;
        display: block;
    }
    .debt-card-details {
        text-align: right;
    }
    .debt-card-details .amount {
        font-size: 1.5em;
        font-weight: bold;
        color: var(--primary-color);
        display: block;
    }
    .debt-card-details .status {
        font-weight: bold;
        font-size: 1em;
    }
    .debt-card-details .status-paid {
        color: var(--success-color);
    }
    .debt-card-details .status-unpaid {
        color: var(--danger-color);
    }
    
    .expense-list-container {
        margin-top: 20px;
    }
    .expense-card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.07);
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid var(--info-color);
    }
    .expense-card-info {
        flex-grow: 1;
    }
    .expense-card-info .description {
        font-weight: bold;
        font-size: 1.1em;
        display: block;
        color: var(--text-color);
    }
    .expense-card-info .date {
        font-size: 0.9em;
        color: #6c757d;
        display: block;
    }
    .expense-card-details {
        text-align: right;
    }
    .expense-card-details .amount {
        font-size: 1.5em;
        font-weight: bold;
        color: var(--primary-color);
        display: block;
    }

    /* Registration Modal styles */
    .form-group {
        margin-bottom: 15px;
    }
    .profile-display-view {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }
    .profile-display-view p {
        font-size: 1.1em;
        margin: 10px 0;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 10px;
    }
     .profile-display-view p:last-child {
        border-bottom: none;
    }
    .profile-display-view strong {
        color: var(--primary-color);
    }
    
    /* Apartment List Styles */
    .apartment-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .apartment-list-item:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .apartment-info .daire-no {
        font-size: 1.4em;
        font-weight: bold;
        color: var(--primary-color);
    }
    .apartment-info .owner-name {
        color: #555;
    }
    .apartment-balance .balance-value {
        font-size: 1.2em;
        font-weight: bold;
        color: var(--danger-color);
    }
    .apartment-balance .balance-value.zero {
        color: var(--success-color);
    }
    #apartmentDetailModal .modal-content {
        max-height: 90vh;
        overflow-y: auto;
    }
    #apartmentDetailModal .detail-section {
        margin-bottom: 20px;
    }
     #apartmentDetailModal .detail-section h5 {
        text-align: left;
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 5px;
        margin-bottom: 10px;
     }
     #apartmentDetailModal .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
     }
     #apartmentDetailModal .detail-item strong {
        color: #333;
     }
    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    /* Admin Debt Card Styles */
    .admin-debt-list-container {
        margin-top: 15px;
    }
    .admin-debt-card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.07);
        padding: 15px;
        margin-bottom: 15px;
        border-left: 5px solid;
    }
    .admin-debt-card.paid {
        border-left-color: var(--success-color);
    }
    .admin-debt-card.unpaid {
        border-left-color: var(--warning-color);
    }
    .admin-debt-card-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    .admin-debt-card-info {
        flex-grow: 1;
    }
    .admin-debt-card-info .month {
        font-weight: bold;
        font-size: 1.1em;
        color: var(--text-color);
    }
    .admin-debt-card-info .type {
        font-size: 0.9em;
        color: #6c757d;
    }
    .admin-debt-card-details {
        text-align: right;
    }
    .admin-debt-card-details .amount {
        font-size: 1.4em;
        font-weight: bold;
        color: var(--primary-color);
    }
    .admin-debt-card-details .status {
        font-weight: bold;
        font-size: 1em;
    }
    .admin-debt-card-details .status-paid {
        color: var(--success-color);
    }
    .admin-debt-card-details .status-unpaid {
        color: var(--danger-color);
    }
    .admin-debt-card-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
        width: 100%;
        border-top: 1px solid #eee;
        padding-top: 10px;
    }
    .admin-debt-card-actions button {
        width: auto;
        flex-grow: 1;
        padding: 8px 10px;
        font-size: 0.9em;
    }

    /* Admin Expense Card Styles */
    .admin-expense-card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.07);
        padding: 15px;
        margin-bottom: 15px;
        border-left: 5px solid var(--info-color);
    }
    .admin-expense-card-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    .admin-expense-card-info {
        flex-grow: 1;
    }
    .admin-expense-card-info .description {
        font-weight: bold;
        font-size: 1.1em;
        color: var(--text-color);
    }
    .admin-expense-card-info .date {
        font-size: 0.9em;
        color: #6c757d;
    }
    .admin-expense-card-details {
        text-align: right;
    }
    .admin-expense-card-details .amount {
        font-size: 1.4em;
        font-weight: bold;
        color: var(--primary-color);
    }
    .admin-expense-card-actions {
        display: flex;
        justify-content: flex-end; /* Align button to the right */
        gap: 8px;
        margin-top: 15px;
        width: 100%;
        border-top: 1px solid #eee;
        padding-top: 10px;
    }
    .admin-expense-card-actions button {
        width: auto;
        flex-grow: 0; /* Don't grow */
        padding: 8px 20px;
        font-size: 0.9em;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
        margin-bottom: 15px;
      }
      h2 {
        font-size: 1.2rem;
      }
      body {
        padding: 15px;
      }
      .container {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ayvalık Yıldız Konakları</h1>
    <h2>Aidat Takip Sistemi</h2>

    <div id="login">
      <h3>Giriş Yap</h3>
      <input type="text" id="username" placeholder="Kullanıcı Adı (örn: A1)">
      <input type="password" id="password" placeholder="Şifre">
       <label class="terms-label">
        <input type="checkbox" id="loginTerms">
        <span><a href="#" id="openTermsModal">Kullanıcı Aydınlatma Metni ve Gizlilik Sözleşmesini</a> okudum, kabul ediyorum.</span>
      </label>
      <button id="loginButton" disabled>Giriş</button>
      <div id="loginMessage" class="message hidden"></div>
    </div>
    
    <div id="userPanel" class="hidden">
      <h3>Hoş Geldiniz, <span id="userNameDisplay"></span><span id="userFullNameDisplay" style="font-weight: normal;"></span></h3>
      
      <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
        <button id="showDebtBtn" style="flex-grow: 1;">Bakiye</button>
        <button id="showProfileBtn" style="flex-grow: 1;">Profilim</button>
        <button id="showExpensesBtn" style="flex-grow: 1;" class="hidden">Giderler</button>
      </div>

       <div id="profileIncompleteMessage" class="error-message hidden"></div>

      <div id="debtPage">
        <h4>Bakiyeniz</h4>

        <div id="balanceSummary" class="balance-summary-card">
            <div>
                <span class="summary-title">Ödenmemiş Toplam Bakiye</span>
                <span id="userUnpaidTotal" class="summary-amount">Hesaplanıyor...</span>
            </div>
            <span class="summary-arrow">▽</span>
        </div>

        <div id="debtDetails" class="collapsible-debt-details">
            <div id="userDebtList" class="debt-list-container">
              <!-- Debt cards will be injected here -->
            </div>
            <div class="totals" id="userDebtTotals"></div>
        </div>
        
        <div class="bank-info">
          <p><strong>Yıldız Konakları Site Yönetimi</strong></p>
          <p><strong>IBAN:</strong> TR510001000110981102095001</p>
        </div>
      </div>

      <div id="profilePage" class="hidden">
        <h4>Profil Bilgilerim</h4>
        <div id="profileDisplayView" class="profile-display-view">
             <!-- Static profile info will be shown here -->
        </div>
        <button id="changePasswordBtn" class="info-btn" style="margin-top:10px;">Şifre Değiştir</button>
        <div id="profileMessage" class="message hidden"></div>
      </div>
      
      <div id="expensesPage" class="hidden">
        <h4>Site Giderleri</h4>
        <div id="expenseNotPublishedMessage" class="message hidden"></div>
        <div id="expenseTableContainer">
           <div id="userExpenseList" class="expense-list-container">
            <!-- Expense cards will be injected here -->
          </div>
          <div class="totals" id="userExpenseTotals"></div>
        </div>
      </div>

      <div class="section-divider"></div>
      <button id="logoutBtnUser">Çıkış Yap</button>
      <div id="userMessage" class="message hidden"></div>
    </div>

    <div id="adminPanel" class="hidden">
      <h3>Yönetici Paneli</h3>
      
      <button class="collapsible-header active">
        <span>Gösterge Paneli</span>
        <span id="refreshDashboardBtn" class="refresh-icon" title="Paneli Yenile">↻</span>
      </button>
      <div id="adminDashboard" class="collapsible-content active" style="max-height: 500px;">
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <span class="dashboard-card-title">Toplam Kasa Bakiyesi</span>
                <span id="dashboardTotalBalance" class="dashboard-card-value">...</span>
            </div>
            <div class="dashboard-card">
                <span class="dashboard-card-title">Bu Ayki Gelir</span>
                <span id="dashboardMonthlyIncome" class="dashboard-card-value">...</span>
            </div>
            <div class="dashboard-card">
                <span class="dashboard-card-title">Bu Ayki Gider</span>
                <span id="dashboardMonthlyExpense" class="dashboard-card-value">...</span>
            </div>
            <div class="dashboard-card">
                <span class="dashboard-card-title">Bu Ay Ödemeyen Daire</span>
                <span id="dashboardUnpaidCount" class="dashboard-card-value">...</span>
            </div>
        </div>
      </div>
      
      <div class="section-divider"></div>
      <button class="collapsible-header admin-only">
        Aidat-Avans Ekle
      </button>
      <div id="newDebtSection" class="collapsible-content admin-only">
        <select id="borcTipi">
          <option value="aidat">Aidat</option>
          <option value="avans">Avans</option>
        </select>
         <div style="display: flex; gap: 10px; margin-top: 10px;">
            <select id="borcAySelect" style="width: 50%;"></select>
            <select id="borcYilSelect" style="width: 50%;"></select>
        </div>
        <input type="number" id="borcTutar" placeholder="Tutar (₺)">
        <select id="borcKime"></select>
        <button id="addDebtBtn">Borç Ekle</button>
        <div id="addDebtMessage" class="message hidden"></div>

        <div class="setting-toggle-container">
            <div class="toggle-label-group">
                <label for="lateFeeToggle" class="toggle-switch-label">Gecikme Tazminatı</label>
                <label class="toggle-switch">
                <input type="checkbox" id="lateFeeToggle">
                <span class="slider round"></span>
                </label>
            </div>
            <p class="setting-description">
                Sistem genelinde, vadesi geçen borçlara gecikme tazminatı uygulanmasını istiyorsanız aktif ediniz.
            </p>
            <p class="setting-description">
                <strong>Son Etkinleştirme Tarihi:</strong> <span id="lastLateFeeActivationDate">Hiçbir zaman</span>
            </p>
        </div>
      </div>

      <div class="section-divider"></div>
        <button class="collapsible-header">Daireler</button>
        <div id="apartmentsPage" class="collapsible-content">
            <input type="search" id="apartmentSearchInput" placeholder="Daire no veya isim ile ara...">
            <div id="apartmentListContainer" style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                <!-- Daire listesi buraya gelecek -->
            </div>
        </div>

      <div class="section-divider"></div>
      <button class="collapsible-header admin-only">
        Tahsilat Ekle
      </button>
      <div id="debtListSection" class="collapsible-content admin-only">
        <select id="flatSelect"></select>
         <div class="month-selector">
            <button id="prevMonthBtn">&lt;</button>
            <span id="currentMonthDisplay"></span>
            <button id="nextMonthBtn">&gt;</button>
        </div>
        
        <div id="allApartmentsSummary" class="hidden">
            <h4 id="summaryTitle"></h4>
            <div class="all-apartments-summary-cards">
                <div class="summary-card paid">
                    <div class="summary-card-title">Ödeyen</div>
                    <div id="paidCount" class="summary-card-value">0</div>
                </div>
                <div class="summary-card unpaid">
                    <div class="summary-card-title">Ödemeyen</div>
                    <div id="unpaidCount" class="summary-card-value">0</div>
                </div>
                <div class="summary-card no-record">
                    <div class="summary-card-title">Kayıt Yok</div>
                    <div id="noRecordCount" class="summary-card-value">0</div>
                </div>
            </div>
        </div>

        <div id="singleApartmentView">
            <div id="userInfoDisplay" class="user-profile-display hidden"></div>
            <div id="adminDebtList" class="admin-debt-list-container">
                <!-- Admin debt cards will be injected here -->
            </div>
            <div class="totals" id="borcToplam"></div>
        </div>
        
        <div id="adminTableMessage" class="message hidden"></div>
        
        <div class="section-divider"></div>
        <h4>Raporlar ve Toplu İşlemler</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
             <button id="downloadAccountStatementBtn" class="download-btn" style="flex-grow: 1;">Hesap Ekstresi İndir (PDF)</button>
            <button id="downloadMonthlyReportBtn" class="download-btn" style="flex-grow: 1;">Aylık Rapor İndir (PDF)</button>
        </div>
        <div style="margin-top: 15px;">
            <h5>Toplu Profil Güncelleme</h5>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <button id="downloadTemplateBtn" class="info-btn" style="flex-grow: 1;">Şablon İndir (.csv)</button>
                <input type="file" id="profileTemplateInput" accept=".csv" style="display: none;">
                <button id="uploadTemplateBtn" class="upload-btn" style="flex-grow: 1;">Şablon Yükle (.csv)</button>
                <button id="downloadAllProfilesCsvBtn" class="download-btn" style="flex-grow: 1;">Tüm Profilleri İndir (Excel)</button>
            </div>
        </div>
      </div>

      <div class="section-divider"></div>
      <button class="collapsible-header">
        Giderler
      </button>
      <div id="expenseSection" class="collapsible-content">
        <div class="admin-only">
            <h4>Yeni Gider Ekle</h4>
            <input type="date" id="expenseDateInput">
            <input type="text" id="expenseNameInput" placeholder="Harcama Adı">
            <input type="number" id="expenseAmountInput" placeholder="Tutar (₺)">
            <button id="saveExpenseBtn">Kaydet</button>
            <div id="expenseMessage" class="message hidden"></div>
        </div>
        <h4>Gider Listesi</h4>
        <div class="month-selector">
            <button id="expensePrevMonthBtn">&lt;</button>
            <span id="expenseCurrentMonthDisplay"></span>
            <button id="expenseNextMonthBtn">&gt;</button>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="publishButton" class="publish-btn admin-only">Giderleri Yayınla</button>
            <button id="downloadMonthlyExpensesBtn" class="download-btn">Aylık Gider İndir (PDF)</button>
        </div>
        <div id="adminExpenseListContainer" class="admin-debt-list-container">
            <!-- Admin expense cards will be injected here -->
        </div>
        <div class="totals" id="adminExpenseTotals"></div>
      </div>

      <div class="section-divider"></div>
      <button id="balanceSectionHeader" class="collapsible-header admin-only">
        <span>Bakiye Durumu</span>
        <span id="refreshBalanceBtn" class="refresh-icon" title="Bakiyeyi Yenile">↻</span>
      </button>
      <div id="balanceSection" class="collapsible-content admin-only">
        <h4>Genel Bakiye Durumu</h4>
        <div id="balanceDetails" style="text-align: center; font-size: 1.2em; padding: 20px;">
            <p><strong>Toplam Gelir (Ödenen Aidatlar/Avanslar):</strong> <span id="totalIncome">Hesaplanıyor...</span></p>
            <p><strong>Toplam Gider:</strong> <span id="totalExpense">Hesaplanıyor...</span></p>
            <hr style="margin: 15px 0;">
            <p><strong>Kalan Bakiye:</strong> <span id="remainingBalance" style="font-weight: bold; font-size: 1.3em;">Hesaplanıyor...</span></p>
        </div>
        <div id="balanceMessage" class="message hidden"></div>
      </div>
      
      <div class="section-divider"></div>
      <button class="collapsible-header admin-only">
        Daire Şifresi Ayarla
      </button>
      <div id="passwordSection" class="collapsible-content admin-only">
        <select id="sifreDaire"></select>
        <input type="password" id="yeniSifre" placeholder="Yeni Daire Şifresi">
        <button id="savePasswordBtn">Daire Şifresini Kaydet</button>
        <h5 style="margin-top: 20px;">Yönetici Şifresi Ayarla</h5>
        <input type="password" id="adminYeniSifre" placeholder="Yeni Yönetici Şifresi">
        <button id="saveAdminPasswordBtn">Yönetici Şifresini Kaydet</button>
        <div id="passwordMessage" class="message hidden"></div>
      </div>

      <div class="section-divider"></div>
      <button id="deleteAllDebtsBtn" class="delete-btn admin-only">Tüm Dairelerin Tüm Borçlarını Sil</button>
      <button id="logoutBtnAdmin">Çıkış Yap</button>
    </div>
  </div>

  <div id="termsModal" class="modal">
    <div class="modal-content">
      <span id="modalCloseBtn" class="modal-close">&times;</span>
      <h4>Kullanıcı Aydınlatma Metni ve Gizlilik Sözleşmesi</h4>
      <div class="terms-box" style="height: 40vh;">
        <p>6698 sayılı Kişisel Verilerin Korunması Kanunu (“KVKK”) uyarınca, kişisel verileriniz; veri sorumlusu olarak Yıldız Konakları Site Yönetimi tarafından aşağıda açıklanan kapsamda işlenebilecektir.</p>
        <p>Toplanan kişisel verileriniz, site sakinlerimize sunulan hizmetlerin iyileştirilmesi, aidat ve gider takibinin yapılması, site içi iletişimin sağlanması ve yasal yükümlülüklerin yerine getirilmesi amaçlarıyla KVKK’nın 5. ve 6. maddelerinde belirtilen kişisel veri işleme şartları ve amaçları dahilinde işlenecektir.</p>
        <p>İşlenen kişisel verileriniz; yukarıda sayılan amaçların gerçekleştirilmesi doğrurultusunda, yetkili kamu kurum ve kuruluşlarına, hukuki uyuşmazlıkların giderilmesi için avukatlara veya adli makamlara aktarılabilecektir.</p>
        <p>Kişisel veri sahibi olarak KVKK’nın 11. maddesi uyarınca sahip olduğunuz hakları kullanmak için bizimle iletişime geçebilirsiniz.</p>
        <p><strong>Gizlilik Sözleşmesi:</strong> Bu platforma kaydolarak, paylaştığınız kişisel verilerin (Ad, Soyad, Telefon, E-posta) yalnızca site yönetimi hizmetleri kapsamında kullanılacağını, üçüncü kişilerle paylaşılmayacağını kabul etmiş olursunuz.</p>
      </div>
    </div>
  </div>
  
  <div id="registrationModal" class="modal">
    <div class="modal-content">
        <h4>Site Kaydı Oluştur</h4>
        <p>Değerli Site Sakinimiz <strong id="welcomeUserName"></strong>, Ayvalık Konakları Aidat Takip Sistemine hoş geldiniz. Site kaydınızı oluşturmak için lütfen aşağıdaki formu doldurunuz.</p>
        
        <div class="form-group">
            <input type="tel" id="regTelefon" placeholder="Telefon (5xx xxx xx xx)">
        </div>
         <div class="form-group">
            <input type="tel" id="regTelefon2" placeholder="Telefon 2 (İsteğe Bağlı)">
        </div>
        <div class="form-group">
            <input type="email" id="regMail" placeholder="E-posta Adresiniz">
        </div>
        <div class="form-group">
            <input type="text" id="regAdres" placeholder="İkametgah Adresiniz">
        </div>

        <button id="saveRegistrationBtn">Kaydet</button>
        <div id="registrationMessage" class="message hidden"></div>
    </div>
</div>

<div id="apartmentDetailModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="document.getElementById('apartmentDetailModal').style.display='none'">&times;</span>
        <h3 id="apartmentDetailTitle">Daire Detayları</h3>
        
        <div id="apartmentDetailContent">
            <!-- Details will be populated by JS -->
        </div>

        <div class="modal-actions">
            <button id="editApartmentDetailBtn" class="edit-btn">Düzenle</button>
            <button id="downloadApartmentStatementBtn" class="download-btn">Hesap Ekstresi İndir (PDF)</button>
            <button id="deleteApartmentBtn" class="delete-btn">Sil</button>
        </div>
    </div>
</div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, updateDoc, getDoc as getDocFromFirestore, query, where, writeBatch, deleteField, enableNetwork, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
          apiKey: "AIzaSyC7hS2P3m2xVfHrl0ONsMrVYv6uY-R-xNU",
          authDomain: "yildizkonaklariaidat.firebaseapp.com",
          projectId: "yildizkonaklariaidat",
          storageBucket: "yildizkonaklariaidat.firebasestorage.app",
          messagingSenderId: "51493869354",
          appId: "1:51493869354:web:556e64fc918fcc813c3053",
          measurementId: "G-4110SM95RV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let loggedInUsername = null;
        let adminCredentials = { username: "admin", password: "admin123" };
        let viewerAdminCredentials = { username: "YONETIM", password: "yon2599" };
        let currentAdminRole = null;
        const aylar = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        let currentAdminDate = new Date();
        let currentExpenseDate = new Date();
        let allApartmentsData = [];

        const daireler = [];
        ["A", "B", "C", "D", "E", "F", "G"].forEach(blok => {
          for (let i = 1; i <= 8; i++) daireler.push(`${blok}${i}`);
        });

        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.textContent = message;
            element.classList.remove('hidden');
            element.className = isError ? 'error-message' : 'message';
            setTimeout(() => element.classList.add('hidden'), 4000);
        }

        function generateRandomPassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let password = '';
            for (let i = 0; i < 5; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }
        
        function showPage(pageId) {
            ['debtPage', 'profilePage', 'expensesPage'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
             if (document.getElementById(pageId)) {
                document.getElementById(pageId).classList.remove('hidden');
            }
        }

        function fillBorcEkleDateFilters() {
          const monthSelect = document.getElementById('borcAySelect');
          const yearSelect = document.getElementById('borcYilSelect');
          monthSelect.innerHTML = aylar.map((ay) => `<option value="${ay}">${ay}</option>`).join('');
          const currentYear = new Date().getFullYear();
          let yearsHtml = '';
          for(let i = currentYear - 2; i <= currentYear + 2; i++) {
            yearsHtml += `<option value="${i}">${i}</option>`;
          }
          yearSelect.innerHTML = yearsHtml;
          monthSelect.value = aylar[new Date().getMonth()];
          yearSelect.value = currentYear;
        }

        function updateAdminDateDisplay() {
            const monthName = aylar[currentAdminDate.getMonth()];
            const year = currentAdminDate.getFullYear();
            document.getElementById('currentMonthDisplay').textContent = `${monthName} ${year}`;
            loadAdminView();
        }

        function updateExpenseDateDisplay() {
            const monthName = aylar[currentExpenseDate.getMonth()];
            const year = currentExpenseDate.getFullYear();
            document.getElementById('expenseCurrentMonthDisplay').textContent = `${monthName} ${year}`;
            loadAdminExpensesTable();
        }


        async function login() {
            const username = document.getElementById("username").value.trim().toUpperCase();
            const password = document.getElementById("password").value;
            const terms = document.getElementById('loginTerms').checked;

            if (!username || !password) {
                return showMessage("loginMessage", "Lütfen tüm alanları doldurun.", true);
            }
             if(!terms) {
                return showMessage('loginMessage', 'Lütfen kullanıcı sözleşmesini onaylayın.', true);
            }

            if (username === adminCredentials.username.toUpperCase() && password === adminCredentials.password) {
                currentAdminRole = 'full';
                await updateDoc(doc(db, "admin", "credentials"), { lastLogin: new Date() });
                setupAdminPanel(currentAdminRole);
                return;
            }
            
            if (username === viewerAdminCredentials.username.toUpperCase() && password === viewerAdminCredentials.password) {
                currentAdminRole = 'viewer';
                setupAdminPanel(currentAdminRole);
                return;
            }
            
            try {
                const flatDoc = await getDocFromFirestore(doc(db, "apartments", username));
                if (!flatDoc.exists() || flatDoc.data().password !== password) {
                    return showMessage("loginMessage", "Kullanıcı adı veya şifre hatalı.", true);
                }
                loggedInUsername = username;
                await updateDoc(doc(db, "apartments", loggedInUsername), { lastLogin: new Date() });
                setupUserPanel();
            } catch (error) {
                console.error("Giriş hatası:", error);
                showMessage("loginMessage", "Giriş sırasında bir hata oluştu.", true);
            }
        }

        async function logout() {
          location.reload();
        }
        
        async function checkProfileAndToggleExpensesButton() {
            try {
                const userDocSnap = await getDocFromFirestore(doc(db, 'apartments', loggedInUsername));
                const publishedExpensesSnap = await getDocFromFirestore(doc(db, 'settings', 'publishedExpenses'));

                const expensesBtn = document.getElementById('showExpensesBtn');
                const debtBtn = document.getElementById('showDebtBtn');
                const warningMsg = document.getElementById('profileIncompleteMessage');
                
                const userData = userDocSnap.exists() ? userDocSnap.data() : {};
                const pubData = publishedExpensesSnap.exists() ? publishedExpensesSnap.data() : { published: false };

                if (userData.profileCompleted) {
                    debtBtn.disabled = false;
                    warningMsg.classList.add('hidden');
                    
                    if (pubData.published) {
                        expensesBtn.classList.remove('hidden');
                    } else {
                        expensesBtn.classList.add('hidden');
                    }
                } else {
                    expensesBtn.classList.add('hidden');
                    debtBtn.disabled = true;
                    warningMsg.textContent = "Bakiye ve Giderleri görebilmek için lütfen site kaydınızı tamamlayın.";
                    warningMsg.classList.remove('hidden');
                }
            } catch (error) {
                 console.error("Giderler butonu kontrol edilirken hata:", error);
                 showMessage('userMessage', 'Giderler durumu kontrol edilemedi.', true);
            }
        }

        async function loadUserProfile() {
            try {
                const userDocSnap = await getDocFromFirestore(doc(db, 'apartments', loggedInUsername));
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const displayView = document.getElementById('profileDisplayView');

                    displayView.innerHTML = `
                        <p><strong>Ad Soyad:</strong> ${userData.adi || ''} ${userData.soyadi || ''}</p>
                        <p><strong>Telefon:</strong> ${userData.telefon || 'Belirtilmemiş'}</p>
                        <p><strong>Telefon 2:</strong> ${userData.telefon2 || 'Yok'}</p>
                        <p><strong>E-posta:</strong> ${userData.mail || 'Belirtilmemiş'}</p>
                        <p><strong>Adres:</strong> ${userData.adres || 'Belirtilmemiş'}</p>
                    `;
                }
            } catch (error) {
                console.error("Kullanıcı profili yüklenirken hata:", error);
                showMessage("profileMessage", "Profil yüklenirken bir hata oluştu.", true);
            }
        }
        
        async function saveRegistrationData() {
            const telefon = document.getElementById('regTelefon').value.trim();
            const telefon2 = document.getElementById('regTelefon2').value.trim();
            const mail = document.getElementById('regMail').value.trim();
            const adres = document.getElementById('regAdres').value.trim();

            if (!telefon || !mail || !adres) {
                return showMessage("registrationMessage", "Lütfen zorunlu alanları doldurun.", true);
            }
           
            const registrationData = {
                telefon,
                telefon2,
                mail,
                adres,
                profileCompleted: true
            };
            
            try {
                await updateDoc(doc(db, 'apartments', loggedInUsername), registrationData, { merge: true });
                showMessage("profileMessage", "Site kaydınız başarıyla oluşturuldu!");
                document.getElementById('registrationModal').style.display = 'none';
                await setupUserPanel();
            } catch (error) {
                 console.error("Kayıt kaydedilirken hata:", error);
                showMessage("registrationMessage", "Bilgiler kaydedilirken bir sorun oluştu.", true);
            }

        }
        
        async function changeUserPassword() {
            const currentPassword = prompt("Mevcut şifrenizi girin:");
            if (currentPassword === null) return;

            try {
                const userDoc = await getDocFromFirestore(doc(db, 'apartments', loggedInUsername));
                if (!userDoc.exists() || userDoc.data().password !== currentPassword) {
                    return showMessage("profileMessage", "Mevcut şifre hatalı.", true);
                }

                const newPassword = prompt("Yeni şifrenizi girin (en az 3 karakter):");
                if (newPassword === null) return;
                if (newPassword.length < 3) {
                    return showMessage("profileMessage", "Yeni şifre en az 3 karakter olmalı.", true);
                }
                
                const newPasswordConfirm = prompt("Yeni şifrenizi tekrar girin:");
                 if (newPassword !== newPasswordConfirm) {
                    return showMessage("profileMessage", "Şifreler eşleşmiyor.", true);
                }

                await updateDoc(doc(db, 'apartments', loggedInUsername), { password: newPassword });
                showMessage("profileMessage", "Şifreniz başarıyla değiştirildi.");

            } catch (error) {
                console.error("Şifre değiştirilirken hata:", error);
                showMessage("profileMessage", "Şifre değiştirilirken bir hata oluştu.", true);
            }
        }
        
        async function loadUserTable(username) {
          const listContainer = document.getElementById("userDebtList");
          const unpaidTotalSpan = document.getElementById("userUnpaidTotal"); 
          unpaidTotalSpan.textContent = "Hesaplanıyor...";
          
          listContainer.innerHTML = '';
          let totalPaid = 0;
          let totalUnpaid = 0;

          try {
            const debtSnapshot = await getDocs(collection(db, 'apartments', username, 'debts'));
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonthIndex = today.getMonth();

            if (debtSnapshot.empty) {
                listContainer.innerHTML = '<p style="text-align:center; padding: 20px 0;">Borcunuz bulunmamaktadır.</p>';
                document.getElementById("userDebtTotals").textContent = `Ödenen: 0 TL | Ödenmemiş: 0 TL`;
                unpaidTotalSpan.textContent = `₺0,00`;
                return;
            }
            
            const debts = [];
            debtSnapshot.forEach(doc => debts.push(doc.data()));
            
            const filteredDebts = debts.filter(entry => {
                try {
                    const [debtMonthStr, debtYearStr] = entry.ay.split(' ');
                    if (!debtMonthStr || !debtYearStr) return false;
                    const debtYear = parseInt(debtYearStr, 10);
                    const debtMonthIndex = aylar.indexOf(debtMonthStr);
                    if (debtYear < currentYear) return true;
                    if (debtYear === currentYear && debtMonthIndex <= currentMonthIndex) return true;
                    return false;
                } catch { return false; }
            });

            if (filteredDebts.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; padding: 20px 0;">Görüntülenecek borcunuz bulunmamaktadır.</p>';
                document.getElementById("userDebtTotals").textContent = `Ödenen: 0 TL | Ödenmemiş: 0 TL`;
                unpaidTotalSpan.textContent = `₺0,00`;
                return;
            }
            
            filteredDebts.sort((a, b) => {
                const [ayA, yilA] = a.ay.split(' ');
                const [ayB, yilB] = b.ay.split(' ');
                if (yilB !== yilA) return Number(yilB) - Number(yilA);
                return aylar.indexOf(ayB) - aylar.indexOf(ayA);
            });

            let cardContent = '';
            filteredDebts.forEach(entry => {
              const statusText = entry.odendi ? "Ödendi" : "Bekliyor";
              const statusClass = entry.odendi ? "paid" : "unpaid";
              const tipFormatted = entry.tip.charAt(0).toUpperCase() + entry.tip.slice(1);
              
              const [month, year] = entry.ay.split(' ');

              cardContent += `
              <div class="debt-card ${statusClass}">
                <div class="debt-card-info">
                  <span class="description">${month} ${year}</span>
                  <span class="type">${tipFormatted}</span>
                </div>
                <div class="debt-card-details">
                  <span class="amount">${entry.tutar} TL</span>
                  <span class="status status-${statusClass}">${statusText}</span>
                </div>
              </div>
            `;

              if (entry.odendi) totalPaid += Number(entry.tutar);
              else totalUnpaid += Number(entry.tutar);
            });
            
            listContainer.innerHTML = cardContent;
            
            unpaidTotalSpan.textContent = `₺${totalUnpaid.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById("userDebtTotals").textContent = `Ödenen Toplam: ${totalPaid.toFixed(2)} TL | Ödenmeyen Toplam: ${totalUnpaid.toFixed(2)} TL`;
          } catch (error) {
            console.error("Kullanıcı borçları yüklenirken hata:", error);
            showMessage("userMessage", "Borç bilgileri yüklenemedi.", true);
            unpaidTotalSpan.textContent = "Hata";
          }
        }

        async function loadUserExpensesTable() {
            const listContainer = document.getElementById("userExpenseList");
            const tableContainer = document.getElementById("expenseTableContainer");
            const notPublishedMsg = document.getElementById("expenseNotPublishedMessage");
            
            try {
                const publishedExpensesSnap = await getDocFromFirestore(doc(db, 'settings', 'publishedExpenses'));
                const pubData = publishedExpensesSnap.exists() ? publishedExpensesSnap.data() : { published: false };

                if (!pubData.published || !pubData.month || !pubData.year) {
                    tableContainer.classList.add('hidden');
                    notPublishedMsg.textContent = "Yönetim tarafından yayınlanmış gider bulunmamaktadır.";
                    notPublishedMsg.classList.remove('hidden');
                    return;
                } 
                
                tableContainer.classList.remove('hidden');
                notPublishedMsg.classList.add('hidden');

                listContainer.innerHTML = '';
                let totalExpense = 0;

                const q = query(collection(db, 'expenses'), 
                  where("tarih_ay", "==", pubData.month),
                  where("tarih_yil", "==", Number(pubData.year))
                );
                const expensesSnapshot = await getDocs(q);

                if (expensesSnapshot.empty) {
                    listContainer.innerHTML = `<p style="text-align:center; padding: 20px 0;">${pubData.month} ${pubData.year} için gider kaydı bulunmamaktadır.</p>`;
                } else {
                    let cardsHtml = '';
                    const expenses = [];
                    expensesSnapshot.forEach(d => expenses.push(d.data()));

                    expenses.sort((a, b) => new Date(b.tarih) - new Date(a.tarih));
                    
                    expenses.forEach(expense => {
                        cardsHtml += `
                          <div class="expense-card">
                            <div class="expense-card-info">
                              <span class="description">${expense.harcamaAdi}</span>
                              <span class="date">${new Date(expense.tarih).toLocaleDateString('tr-TR')}</span>
                            </div>
                            <div class="expense-card-details">
                              <span class="amount">${expense.tutar} TL</span>
                            </div>
                          </div>
                        `;
                        totalExpense += Number(expense.tutar);
                    });
                    listContainer.innerHTML = cardsHtml;
                }
                document.getElementById("userExpenseTotals").textContent = `Toplam Gider: ${totalExpense.toFixed(2)} TL`;
            } catch (error) {
                console.error("Kullanıcı giderleri yüklenirken hata:", error);
                showMessage('userMessage', "Gider bilgileri yüklenemedi.", true);
            }
        }

        function fillFlatSelects() {
            const selects = ["flatSelect", "borcKime", "sifreDaire"];
            selects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = "";
                if(id === 'flatSelect' || id === 'borcKime'){
                    select.innerHTML += '<option value="all_apartments">Tüm Daireler</option>';
                }
                daireler.forEach(daire => select.innerHTML += `<option value="${daire}">${daire}</option>`);
            });
        }

        async function loadAdminView() {
            const selectedDaire = document.getElementById("flatSelect").value;
            if (selectedDaire === 'all_apartments') {
                await loadAllApartmentsSummary();
            } else {
                await loadAdminTable();
            }
        }

        async function loadAdminTable() {
            const daire = document.getElementById("flatSelect").value;
            if (!daire) return;

            document.getElementById('allApartmentsSummary').classList.add('hidden');
            document.getElementById('singleApartmentView').classList.remove('hidden');
            document.getElementById('userInfoDisplay').classList.remove('hidden');

            const listContainer = document.getElementById("adminDebtList");
            const userInfoDisplay = document.getElementById("userInfoDisplay");
            listContainer.innerHTML = '';

            try {
                const userData = allApartmentsData.find(d => d.id === daire) || {};
                
                userInfoDisplay.innerHTML = `<p><strong>Daire:</strong> ${daire}</p>
                    <p><strong>Adı Soyadı:</strong> ${userData.adi || 'Bilgi Yok'} ${userData.soyadi || ''}</p>`;
                userInfoDisplay.classList.remove("hidden");

                const debtsCollectionRef = collection(db, 'apartments', daire, 'debts');
                const monthName = aylar[currentAdminDate.getMonth()];
                const year = currentAdminDate.getFullYear();
                const ayFilter = `${monthName} ${year}`;
                const q = query(debtsCollectionRef, where("ay", "==", ayFilter));

                const debtSnapshot = await getDocs(q);
                if (debtSnapshot.empty) {
                    listContainer.innerHTML = `<p style="text-align:center; padding: 20px 0;">Seçili ay için borç bulunmamaktadır.</p>`;
                    document.getElementById("borcToplam").textContent = `Toplam: 0 TL | Ödenen: 0 TL | Kalan: 0 TL`;
                    return;
                }

                let toplam = 0, odenen = 0;
                let cardsHtml = '';
                debtSnapshot.forEach(doc => {
                    const entry = doc.data();
                    toplam += Number(entry.tutar);
                    if (entry.odendi) odenen += Number(entry.tutar);

                    const statusText = entry.odendi ? "Ödendi" : "Bekliyor";
                    const statusClass = entry.odendi ? "paid" : "unpaid";

                    cardsHtml += `
                    <div class="admin-debt-card ${statusClass}">
                        <div class="admin-debt-card-main">
                            <div class="admin-debt-card-info">
                                <span class="month">${entry.ay}</span>
                                <span class="type">${entry.tip}</span>
                            </div>
                            <div class="admin-debt-card-details">
                                <span class="amount">₺${entry.tutar}</span>
                                <span class="status status-${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="admin-debt-card-actions">
                            ${entry.odendi ? '<span style="width:100%; text-align:center;">-</span>' : `<button class="admin-action-btn" data-action="mark-paid" data-daire="${daire}" data-id="${doc.id}">Ödendi</button>`}
                            <button class="edit-btn admin-action-btn" data-action="edit-debt" data-daire="${daire}" data-id="${doc.id}">Düzenle</button>
                            <button class="delete-btn admin-action-btn" data-action="delete-debt" data-daire="${daire}" data-id="${doc.id}">Sil</button>
                        </div>
                    </div>`;
                });
                listContainer.innerHTML = cardsHtml;
                document.getElementById("borcToplam").textContent = `Toplam: ${toplam} TL | Ödenen: ${odenen} TL | Kalan: ${toplam - odenen} TL`;
            } catch (error) {
                console.error("Yönetici borç listesi yüklenirken hata:", error);
                showMessage("adminTableMessage", "Borç bilgileri yüklenemedi.", true);
            }
        }

        async function loadAllApartmentsSummary() {
            document.getElementById('singleApartmentView').classList.add('hidden');
            document.getElementById('userInfoDisplay').classList.add('hidden');
            document.getElementById('allApartmentsSummary').classList.remove('hidden');

            const month = aylar[currentAdminDate.getMonth()];
            const year = currentAdminDate.getFullYear();
            const ayFilter = `${month} ${year}`;
            
            document.getElementById('summaryTitle').textContent = `${ayFilter} Ödeme Durumu`;

            let paidCount = 0;
            let unpaidCount = 0;
            let noRecordCount = daireler.length;

            try {
                for (const daire of daireler) {
                    const q = query(collection(db, 'apartments', daire, 'debts'), where("ay", "==", ayFilter));
                    const debtSnapshot = await getDocs(q);
                    if (!debtSnapshot.empty) {
                        noRecordCount--; 
                        let hasUnpaid = false;
                        debtSnapshot.forEach(doc => {
                            if (!doc.data().odendi) {
                                hasUnpaid = true;
                            }
                        });
                        if(hasUnpaid) unpaidCount++;
                        else paidCount++;
                    }
                }
                
                document.getElementById('paidCount').textContent = paidCount;
                document.getElementById('unpaidCount').textContent = unpaidCount;
                document.getElementById('noRecordCount').textContent = noRecordCount;

            } catch (error) {
                console.error("Genel özet yüklenirken hata:", error);
                showMessage("adminTableMessage", "Özet bilgileri yüklenemedi.", true);
            }
        }
        
        async function markPaid(daire, debtId) {
            if (confirm("Borç ödendi olarak işaretlenecek, emin misiniz?")) {
                try {
                    await updateDoc(doc(db, 'apartments', daire, 'debts', debtId), { odendi: true });
                    showMessage("adminTableMessage", "Borç ödendi olarak işaretlendi.");
                    loadAdminView();
                } catch (e) {
                    showMessage("adminTableMessage", "İşlem başarısız.", true);
                }
            }
        }

        async function ekleBorc() {
            const daire = document.getElementById("borcKime").value;
            const month = document.getElementById("borcAySelect").value;
            const year = document.getElementById("borcYilSelect").value;
            const ay = `${month} ${year}`;
            const tutar = Number(document.getElementById("borcTutar").value);
            const tip = document.getElementById("borcTipi").value;

            if (!ay || !tutar || tutar <= 0) {
                return showMessage("addDebtMessage", "Lütfen tüm alanları doğru doldurun.", true);
            }

            const apartmentsToAdd = (daire === "all_apartments") ? daireler : [daire];
            const batch = writeBatch(db);
            let successCount = 0;
            try {
                for (const flat of apartmentsToAdd) {
                    const q = query(collection(db, 'apartments', flat, 'debts'), where("ay", "==", ay), where("tip", "==", tip));
                    const existing = await getDocs(q);
                    if (existing.empty) {
                        const newDebtRef = doc(collection(db, 'apartments', flat, 'debts'));
                        batch.set(newDebtRef, { ay, tutar, tip, odendi: false });
                        successCount++;
                    }
                }
                if (successCount > 0) {
                    await batch.commit();
                    showMessage("addDebtMessage", `${successCount} daireye borç eklendi.`);
                    loadAdminView();
                } else {
                    showMessage("addDebtMessage", "Seçili daire(ler) için bu borç zaten mevcut.", true);
                }
            } catch (e) {
                showMessage("addDebtMessage", "Borç eklenemedi.", true);
            }
        }

        async function silBorc(daire, debtId) {
            if (confirm("Bu borç kaydı silinecek, emin misiniz?")) {
                try {
                    await deleteDoc(doc(db, 'apartments', daire, 'debts', debtId));
                    showMessage("adminTableMessage", "Borç silindi.");
                    loadAdminView();
                } catch (e) {
                    showMessage("adminTableMessage", "Borç silinemedi.", true);
                }
            }
        }

        async function editDebt(daire, debtId) {
            const debtDoc = await getDocFromFirestore(doc(db, 'apartments', daire, 'debts', debtId));
            if (!debtDoc.exists()) return showMessage("adminTableMessage", "Borç bulunamadı.", true);
            const current = debtDoc.data();

            const newAy = prompt("Ay:", current.ay);
            if (newAy === null) return;
            const newTutar = prompt("Tutar:", current.tutar);
            if (newTutar === null || isNaN(Number(newTutar)) || Number(newTutar) <= 0) return showMessage("adminTableMessage", "Geçersiz tutar.", true);
            const newTip = prompt("Tip (aidat/avans):", current.tip);
            if (newTip === null || !['aidat', 'avans'].includes(newTip)) return showMessage("adminTableMessage", "Geçersiz tip.", true);

            try {
                await updateDoc(doc(db, 'apartments', daire, 'debts', debtId), { ay: newAy, tutar: Number(newTutar), tip: newTip });
                showMessage("adminTableMessage", "Borç güncellendi.");
                loadAdminView();
            } catch (e) {
                showMessage("adminTableMessage", "Borç güncellenemedi.", true);
            }
        }
        
        async function deleteAllDebts() {
            if (confirm("TÜM BORÇLAR SİLİNECEK! Bu işlem geri alınamaz. Emin misiniz?")) {
                const batch = writeBatch(db);
                for (const daire of daireler) {
                    const debtSnapshot = await getDocs(collection(db, 'apartments', daire, 'debts'));
                    debtSnapshot.forEach(d => batch.delete(d.ref));
                }
                await batch.commit();
                showMessage("adminTableMessage", "Tüm borçlar silindi.");
                loadAdminView();
            }
        }
        
        async function downloadMonthlyReportPdf() {
            const { jsPDF } = window.jspdf;
            const pdfDoc = new jsPDF();
            if (typeof pdfDoc.autoTable !== 'function') {
                return showMessage("adminTableMessage", "PDF tablo eklentisi yüklenemedi.", true);
            }
            
            const month = aylar[currentAdminDate.getMonth()];
            const year = currentAdminDate.getFullYear();
            const ayFilter = `${month} ${year}`;
            showMessage("adminTableMessage", `${ayFilter} için rapor oluşturuluyor...`, false);
            
            const paidData = [];
            const unpaidData = [];

            for(const daire of daireler) {
                const q = query(collection(db, 'apartments', daire, 'debts'), where("ay", "==", ayFilter));
                const debtSnapshot = await getDocs(q);
                if(!debtSnapshot.empty) {
                     debtSnapshot.forEach(d => {
                        const entry = d.data();
                        const row = [daire, entry.tip, `${entry.tutar} TL`];
                        if(entry.odendi) {
                            paidData.push(row);
                        } else {
                            unpaidData.push(row);
                        }
                    });
                }
            }
            
            pdfDoc.setFont('helvetica', 'normal');

            const title = `Aylık Borç Raporu - ${ayFilter}`;
            const pageWidth = pdfDoc.internal.pageSize.getWidth();
            pdfDoc.setFontSize(18);
            pdfDoc.text(title, pageWidth / 2, 20, { align: 'center', maxWidth: pageWidth - 20 });
            
            pdfDoc.setFontSize(12);
            pdfDoc.text(`Tarih: ${new Date().toLocaleDateString('tr-TR')}`, pageWidth / 2, 28, { align: "center" });

            pdfDoc.autoTable({
                head: [
                    [{ content: 'Ödeme Yapanlar', colSpan: 3, styles: { halign: 'center', fontStyle: 'bold' } }],
                    ['Daire', 'Tip', 'Tutar']
                ],
                body: paidData,
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [40, 167, 69] },
                styles: { font: 'helvetica' },
            });
            
            pdfDoc.autoTable({
                head: [
                    [{ content: 'Ödeme Yapmayanlar', colSpan: 3, styles: { halign: 'center', fontStyle: 'bold' } }],
                    ['Daire', 'Tip', 'Tutar']
                ],
                body: unpaidData,
                startY: pdfDoc.autoTable.previous.finalY + 15,
                theme: 'grid',
                headStyles: { fillColor: [220, 53, 69] },
                styles: { font: 'helvetica' },
            });


            pdfDoc.save(`Aylik_Rapor_${month}_${year}.pdf`);
            showMessage("adminTableMessage", "PDF indirildi.");
        }
        
        async function downloadApartmentStatementPdf(daireId, timeRange = 'all') {
            const { jsPDF } = window.jspdf;
            const pdfDoc = new jsPDF();
            
            let title = "Hesap Ekstresi";
            let filename = `Hesap_Ekstresi_${daireId}_Tüm_Zamanlar.pdf`;

            if (timeRange === 'year') {
                const year = currentAdminDate.getFullYear();
                title = `Hesap Ekstresi - ${year}`;
                filename = `Hesap_Ekstresi_${daireId}_${year}.pdf`;
                 showMessage("adminTableMessage", `${daireId} için ${year} yılı hesap ekstresi oluşturuluyor...`);
            } else {
                 showMessage("adminTableMessage", `${daireId} için hesap ekstresi oluşturuluyor...`, false);
            }

            const debtData = [];
            let totalBorc = 0;
            let totalOdenen = 0;

            try {
                const debtsCollectionRef = collection(db, 'apartments', daireId, 'debts');
                const debtSnapshot = await getDocs(debtsCollectionRef);

                debtSnapshot.forEach(d => {
                    const entry = d.data();
                    let include = false;
                    if (timeRange === 'all') {
                        include = true;
                    } else if (timeRange === 'year') {
                        const year = currentAdminDate.getFullYear();
                        const [debtMonthStr, debtYearStr] = entry.ay.split(' ');
                        if (parseInt(debtYearStr, 10) === year) {
                            include = true;
                        }
                    }

                    if(include) {
                        debtData.push(entry);
                        totalBorc += Number(entry.tutar);
                        if(entry.odendi) {
                            totalOdenen += Number(entry.tutar);
                        }
                    }
                });

                if(debtData.length === 0) {
                    return showMessage("adminTableMessage", `Seçilen daire için belirtilen dönemde borç kaydı bulunamadı.`, true);
                }

                debtData.sort((a, b) => {
                    const [ayA, yilA] = a.ay.split(' ');
                    const [ayB, yilB] = b.ay.split(' ');
                    if (yilA !== yilB) return Number(yilA) - Number(yilB);
                    return aylar.indexOf(ayA) - aylar.indexOf(ayB);
                });

                const tableBody = debtData.map(entry => {
                    return [
                        entry.ay,
                        entry.tip.charAt(0).toUpperCase() + entry.tip.slice(1),
                        `${Number(entry.tutar).toFixed(2)} TL`,
                        entry.odendi ? 'Ödendi' : 'Ödenmedi'
                    ];
                });

                const flatDocSnap = await getDocFromFirestore(doc(db, 'apartments', daireId));
                const userData = flatDocSnap.exists() ? flatDocSnap.data() : {};
                const malik = `${userData.adi || ''} ${userData.soyadi || ''}`.trim();

                pdfDoc.setFont('helvetica', 'normal');

                pdfDoc.setFontSize(18);
                pdfDoc.text(title, 105, 20, { align: "center" });
                
                const residentInfoBody = [
                    ['Daire No', daireId],
                    ['Tapu Sahibi', malik || 'N/A'],
                    ['Telefon', userData.telefon || 'N/A'],
                    ['E-posta', userData.mail || 'N/A']
                ];
                
                pdfDoc.autoTable({
                    body: residentInfoBody,
                    startY: 30,
                    theme: 'plain',
                    styles: { fontSize: 10, font: 'helvetica' },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 40 },
                        1: { cellWidth: 'auto' },
                    }
                });

                let startY = pdfDoc.autoTable.previous.finalY + 10;

                pdfDoc.autoTable({
                    head: [['Dönem', 'Açıklama', 'Tutar', 'Durum']],
                    body: tableBody,
                    startY: startY,
                    theme: 'grid',
                    styles: { font: 'helvetica', fontSize: 10 },
                    headStyles: { fillColor: [1, 79, 134] },
                    didParseCell: function(data) {
                        if (data.section === 'body' && data.column.index === 3) {
                            if (data.cell.raw === 'Ödenmedi') {
                                data.cell.styles.textColor = [220, 53, 69];
                                data.cell.styles.fontStyle = 'bold';
                            } else if (data.cell.raw === 'Ödendi') {
                                 data.cell.styles.textColor = [40, 167, 69];
                            }
                        }
                    }
                });

                let finalY = pdfDoc.autoTable.previous.finalY;
                pdfDoc.setFontSize(12);
                pdfDoc.text(`Genel Toplam Borç: ${totalBorc.toFixed(2)} TL`, 14, finalY + 10);
                pdfDoc.text(`Genel Toplam Ödenen: ${totalOdenen.toFixed(2)} TL`, 14, finalY + 17);
                pdfDoc.setFontSize(14);
                pdfDoc.setFont(undefined, 'bold');
                pdfDoc.text(`Kalan Bakiye: ${(totalBorc - totalOdenen).toFixed(2)} TL`, 14, finalY + 25);

                pdfDoc.save(filename);
                showMessage("adminTableMessage", "Hesap ekstresi PDF olarak indirildi.");


            } catch (error) {
                console.error("Hesap ekstresi oluşturulurken hata:", error);
                showMessage("adminTableMessage", "PDF oluşturulurken bir hata oluştu.", true);
            }
        }

        function downloadProfileTemplate() {
            const headers = "Daire,Ad,Soyad,Telefon,Mail";
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers + "\n";
            daireler.forEach(daire => {
                csvContent += `${daire},,,,\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "profil_sablonu.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage("adminTableMessage", "Profil şablonu indirildi.");
        }

        async function downloadAllProfilesCsv() {
            showMessage("adminTableMessage", "Tüm profiller indiriliyor...", false);
            const headers = "Daire;Adı Soyadı;Telefon;Mail;Şifre"; // Use semicolon for better Excel compatibility
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers + "\n";

            try {
                const profileData = [];
                for (const daire of daireler) {
                    const flatDocRef = doc(db, 'apartments', daire);
                    const flatDocSnap = await getDocFromFirestore(flatDocRef);
                    const userData = flatDocSnap.exists() ? flatDocSnap.data() : {};
                    
                    const adi = userData.adi || '';
                    const soyadi = userData.soyadi || '';
                    const adSoyad = `${adi} ${soyadi}`.trim();
                    const telefon = userData.telefon || '';
                    const mail = userData.mail || '';
                    const password = userData.password || 'N/A';
                    
                    profileData.push([daire, adSoyad, telefon, mail, password].join(';'));
                }

                csvContent += profileData.join('\n');
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "tum_profil_bilgileri.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("adminTableMessage", "Tüm profiller başarıyla indirildi.");
            } catch (error) {
                console.error("Profiller indirilirken hata:", error);
                showMessage("adminTableMessage", "Profiller indirilirken bir hata oluştu.", true);
            }
        }

        async function uploadProfileTemplate(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const rows = text.split('\n').slice(1);
                const batch = writeBatch(db);
                let updatedCount = 0;
                for (const row of rows) {
                    if (!row.trim()) continue;
                    const columns = row.split(',');
                    const daireId = columns[0] ? columns[0].trim().toUpperCase() : '';
                    const adi = columns[1] ? columns[1].trim() : '';
                    const soyadi = columns[2] ? columns[2].trim() : '';
                    const telefon = columns[3] ? columns[3].trim() : '';
                    const mail = columns[4] ? columns[4].trim() : '';
                    if (daireler.includes(daireId) && (adi || soyadi || telefon || mail)) {
                        const flatDocRef = doc(db, 'apartments', daireId);
                        const updateData = {};
                        if (adi) updateData.adi = adi;
                        if (soyadi) updateData.soyadi = soyadi;
                        if (telefon) updateData.telefon = telefon;
                        if (mail) updateData.mail = mail;
                        batch.set(flatDocRef, updateData, { merge: true });
                        updatedCount++;
                    }
                }
                if (updatedCount > 0) {
                    try {
                        await batch.commit();
                        showMessage("adminTableMessage", `${updatedCount} daire profili başarıyla güncellendi.`);
                        loadAdminView();
                    } catch (error) {
                        console.error("Profil şablonu yüklenirken hata:", error);
                        showMessage("adminTableMessage", "Profiller güncellenirken bir hata oluştu.", true);
                    }
                } else {
                    showMessage("adminTableMessage", "Dosyada güncellenecek geçerli bir bilgi bulunamadı.", true);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        async function backupData() { /* ... */ }
        async function restoreData(event) { /* ... */ }

        async function saveExpense() {
            const dateInput = document.getElementById("expenseDateInput").value;
            const name = document.getElementById("expenseNameInput").value.trim();
            const amount = Number(document.getElementById("expenseAmountInput").value);
            if (!dateInput || !name || !amount || amount <= 0) {
                return showMessage("expenseMessage", "Lütfen tüm alanları doğru doldurun.", true);
            }
            const date = new Date(dateInput);
            try {
                await addDoc(collection(db, 'expenses'), {
                    tarih: dateInput,
                    harcamaAdi: name,
                    tutar: amount,
                    tarih_ay: aylar[date.getMonth()],
                    tarih_yil: date.getFullYear(),
                    timestamp: new Date()
                });
                showMessage("expenseMessage", "Gider kaydedildi.");
                loadAdminExpensesTable();
            } catch (e) {
                showMessage("expenseMessage", "Gider kaydedilemedi.", true);
            }
        }

        async function loadAdminExpensesTable() {
            const month = aylar[currentExpenseDate.getMonth()];
            const year = currentExpenseDate.getFullYear();
            
            const listContainer = document.getElementById("adminExpenseListContainer");
            const publishButton = document.getElementById("publishButton");
            listContainer.innerHTML = '';
            let totalExpense = 0;

            const pubSnap = await getDocFromFirestore(doc(db, 'settings', 'publishedExpenses'));
            let publishedExpenseData = pubSnap.exists() ? pubSnap.data() : { published: false };
            const isPublished = publishedExpenseData.published && publishedExpenseData.month === month && publishedExpenseData.year === Number(year);
            publishButton.textContent = isPublished ? 'Yayından Kaldır' : 'Yayınla';

            const q = query(collection(db, 'expenses'), where("tarih_ay", "==", month), where("tarih_yil", "==", Number(year)));
            const expensesSnapshot = await getDocs(q);

            if (expensesSnapshot.empty) {
                listContainer.innerHTML = '<p style="text-align:center; padding: 20px 0;">Bu dönem için gider kaydı yok.</p>';
            } else {
                let cardsHtml = '';
                const expenses = [];
                expensesSnapshot.forEach(d => expenses.push({id: d.id, ...d.data()}));
                
                // Sort by date, most recent first
                expenses.sort((a, b) => new Date(b.tarih) - new Date(a.tarih));

                expenses.forEach(expense => {
                    const actionsHtml = currentAdminRole === 'full' ? `
                    <div class="admin-expense-card-actions">
                         <button class="delete-btn admin-action-btn" data-action="delete-expense" data-id="${expense.id}">Sil</button>
                    </div>` : '';
                    
                    cardsHtml += `
                    <div class="admin-expense-card">
                        <div class="admin-expense-card-main">
                            <div class="admin-expense-card-info">
                                <span class="description">${expense.harcamaAdi}</span>
                                <span class="date">${new Date(expense.tarih).toLocaleDateString('tr-TR')}</span>
                            </div>
                            <div class="admin-expense-card-details">
                                <span class="amount">₺${expense.tutar}</span>
                            </div>
                        </div>
                        ${actionsHtml}
                    </div>`;
                    totalExpense += Number(expense.tutar);
                });
                listContainer.innerHTML = cardsHtml;
            }
            document.getElementById("adminExpenseTotals").textContent = `Toplam Gider: ${totalExpense.toFixed(2)} TL`;
        }
        
        async function deleteExpense(expenseId) {
            if (confirm("Gider silinecek, emin misiniz?")) {
                try {
                    await deleteDoc(doc(db, 'expenses', expenseId));
                    showMessage("expenseMessage", "Gider silindi.");
                    loadAdminExpensesTable();
                } catch (e) {
                    showMessage("expenseMessage", "Gider silinemedi.", true);
                }
            }
        }

        async function toggleExpensesVisibility() {
            const month = aylar[currentExpenseDate.getMonth()];
            const year = currentExpenseDate.getFullYear();
            const pubRef = doc(db, 'settings', 'publishedExpenses');
            const pubSnap = await getDocFromFirestore(pubRef);
            const pubData = pubSnap.exists() ? pubSnap.data() : { published: false, month: null, year: null };
            const isPublished = pubData.published && pubData.month === month && pubData.year === year;

            try {
                if (isPublished) {
                    await setDoc(pubRef, { published: false, month: null, year: null });
                    showMessage("expenseMessage", "Giderler yayından kaldırıldı.");
                } else {
                    await setDoc(pubRef, { published: true, month, year });
                    showMessage("expenseMessage", "Giderler yayınlandı.");
                }
                loadAdminExpensesTable();
            } catch (e) {
                showMessage("expenseMessage", "İşlem başarısız.", true);
            }
        }

        async function calculateAndShowBalance() {
            let totalIncome = 0;
            let totalExpenses = 0;

            for (const daire of daireler) {
                const q = query(collection(db, 'apartments', daire, 'debts'), where("odendi", "==", true));
                const paidDebts = await getDocs(q);
                paidDebts.forEach(d => totalIncome += Number(d.data().tutar));
            }

            const allExpenses = await getDocs(collection(db, 'expenses'));
            allExpenses.forEach(d => totalExpenses += Number(d.data().tutar));
            
            const balance = totalIncome - totalExpenses;
            document.getElementById("totalIncome").textContent = `${totalIncome.toFixed(2)} TL`;
            document.getElementById("totalExpense").textContent = `${totalExpenses.toFixed(2)} TL`;
            document.getElementById("remainingBalance").textContent = `${balance.toFixed(2)} TL`;
            document.getElementById("remainingBalance").style.color = balance < 0 ? 'var(--danger-color)' : 'var(--success-color)';
        }
        
        async function updateAdminDashboard() {
            const currentDate = new Date();
            const currentMonth = aylar[currentDate.getMonth()];
            const currentYear = currentDate.getFullYear();
            
            let totalIncomeAll = 0, totalExpenseAll = 0, monthlyIncome = 0, monthlyExpense = 0;
            const unpaidApartments = new Set();
            
            for (const daire of daireler) {
                const debtsSnapshot = await getDocs(collection(db, 'apartments', daire, 'debts'));
                debtsSnapshot.forEach(d => {
                    const debt = d.data();
                    if (debt.odendi) {
                        totalIncomeAll += Number(debt.tutar);
                    }
                    if (debt.ay === `${currentMonth} ${currentYear}`) {
                         if (debt.odendi) {
                            monthlyIncome += Number(debt.tutar);
                         } else {
                            unpaidApartments.add(daire);
                         }
                    }
                });
            }
            
            const expensesSnapshot = await getDocs(collection(db, 'expenses'));
            expensesSnapshot.forEach(d => {
                const expense = d.data();
                totalExpenseAll += Number(expense.tutar);
                if (expense.tarih_ay === currentMonth && expense.tarih_yil === currentYear) {
                    monthlyExpense += Number(expense.tutar);
                }
            });
            
            const totalBalance = totalIncomeAll - totalExpenseAll;

            document.getElementById('dashboardTotalBalance').textContent = `₺${totalBalance.toFixed(2)}`;
            document.getElementById('dashboardMonthlyIncome').textContent = `₺${monthlyIncome.toFixed(2)}`;
            document.getElementById('dashboardMonthlyExpense').textContent = `₺${monthlyExpense.toFixed(2)}`;
            document.getElementById('dashboardUnpaidCount').textContent = unpaidApartments.size;
        }

        async function applyLateCompensation() {
            showMessage("addDebtMessage", "Gecikme tazminatları hesaplanıyor ve uygulanıyor...", false);

            const currentDate = new Date();
            const currentMonthIndex = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            const currentAy = `${aylar[currentMonthIndex]} ${currentYear}`;
            
            const batch = writeBatch(db);
            let feeAppliedCount = 0;

            try {
                for (const daire of daireler) {
                    const debtsRef = collection(db, 'apartments', daire, 'debts');
                    const q = query(debtsRef, where("odendi", "==", false));
                    const unpaidDebtsSnap = await getDocs(q);

                    unpaidDebtsSnap.forEach(debtDoc => {
                        const debt = debtDoc.data();
                        
                        if (debt.gecikmeTazminatiUygulandi === true) {
                            return; 
                        }

                        const [debtMonthStr, debtYearStr] = debt.ay.split(' ');
                        const debtYear = parseInt(debtYearStr, 10);
                        const debtMonthIndex = aylar.indexOf(debtMonthStr);

                        const isPastDue = debtYear < currentYear || (debtYear === currentYear && debtMonthIndex < currentMonthIndex);

                        if (isPastDue) {
                            const lateFee = Number(debt.tutar) * 0.05;
                            const newFeeRef = doc(collection(db, 'apartments', daire, 'debts'));
                            batch.set(newFeeRef, {
                                ay: currentAy,
                                tutar: parseFloat(lateFee.toFixed(2)),
                                tip: 'gecikme-tazminati',
                                odendi: false,
                                aciklama: `${debt.ay} borcu için gecikme tazminatı`
                            });
                            
                            batch.update(debtDoc.ref, { gecikmeTazminatiUygulandi: true });
                            feeAppliedCount++;
                        }
                    });
                }

                if (feeAppliedCount > 0) {
                    await batch.commit();
                    showMessage("addDebtMessage", `${feeAppliedCount} adet borca gecikme tazminatı başarıyla uygulandı.`);
                } else {
                    showMessage("addDebtMessage", "Gecikme tazminatı uygulanacak yeni borç bulunamadı.");
                }
                await updateAdminDashboard();
                return true;
            } catch (error) {
                console.error("Gecikme tazminatı uygulanırken hata:", error);
                showMessage("addDebtMessage", "İşlem sırasında bir hata oluştu.", true);
                return false;
            }
        }
        
        async function loadLateFeeSettings() {
            try {
                const settingsDoc = await getDocFromFirestore(doc(db, 'settings', 'lateFee'));
                if (settingsDoc.exists()) {
                    const data = settingsDoc.data();
                    document.getElementById('lateFeeToggle').checked = data.enabled || false;
                    if (data.lastEnabled) {
                        const date = new Date(data.lastEnabled.seconds * 1000);
                        document.getElementById('lastLateFeeActivationDate').textContent = date.toLocaleString('tr-TR');
                    } else {
                         document.getElementById('lastLateFeeActivationDate').textContent = 'Hiçbir zaman';
                    }
                }
            } catch (error) {
                console.error("Gecikme tazminatı ayarları yüklenirken hata:", error);
            }
        }
        
        async function handleLateFeeToggle(event) {
            const isEnabled = event.target.checked;
            const toggle = event.target;

            if (isEnabled) {
                if (confirm("Gecikme tazminatı sistemini etkinleştirmek istediğinizden emin misiniz? Bu işlem, vadesi geçmiş ve ödenmemiş tüm borçlara %5 tazminat uygulayacaktır.")) {
                    const success = await applyLateCompensation();
                    if (success) {
                        await setDoc(doc(db, 'settings', 'lateFee'), { enabled: true, lastEnabled: new Date() }, { merge: true });
                        await loadLateFeeSettings();
                    } else {
                        toggle.checked = false;
                    }
                } else {
                    toggle.checked = false;
                }
            } else {
                if (confirm("Gecikme tazminatı sistemini devre dışı bırakmak istediğinizden emin misiniz?")) {
                    await setDoc(doc(db, 'settings', 'lateFee'), { enabled: false }, { merge: true });
                    showMessage("addDebtMessage", "Gecikme tazminatı sistemi devre dışı bırakıldı.");
                } else {
                    toggle.checked = true;
                }
            }
        }
        
        async function setupUserPanel() {
            try {
                const flatDocSnap = await getDocFromFirestore(doc(db, 'apartments', loggedInUsername));
                const userData = flatDocSnap.exists() ? flatDocSnap.data() : {};
                
                document.getElementById("login").classList.add("hidden");
                document.getElementById("adminPanel").classList.add("hidden");
                document.getElementById("userPanel").classList.remove("hidden");

                document.getElementById("userNameDisplay").textContent = loggedInUsername;
                document.getElementById("userFullNameDisplay").textContent = `, ${userData.adi || ''} ${userData.soyadi || ''}`;
                
                
                // Check if profile is complete
                if (!userData.profileCompleted) {
                    document.getElementById('registrationModal').style.display = 'block';
                    document.getElementById('welcomeUserName').textContent = `${userData.adi || ''} ${userData.soyadi || ''}`;
                    document.getElementById('showDebtBtn').disabled = true;
                    document.getElementById('showExpensesBtn').classList.add('hidden');
                } else {
                    document.getElementById('showDebtBtn').disabled = false;
                    await checkProfileAndToggleExpensesButton();
                    await loadUserTable(loggedInUsername);
                }

                showPage('debtPage'); 
                
            } catch (error) {
                console.error("Kullanıcı paneli kurulurken hata:", error);
                showMessage('userMessage', 'Panel yüklenirken bir hata oluştu. Lütfen tekrar deneyin.', true);
                logout();
            }
        }

        async function setupAdminPanel(role) {
            try {
                document.getElementById("login").classList.add("hidden");
                document.getElementById("userPanel").classList.add("hidden");
                document.getElementById("adminPanel").classList.remove("hidden");

                if(role === 'viewer') {
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                    document.querySelectorAll('.modal-actions .edit-btn, .modal-actions .delete-btn').forEach(el => el.classList.add('hidden'));
                }

                fillFlatSelects();
                fillBorcEkleDateFilters();
                updateAdminDateDisplay();
                updateExpenseDateDisplay();
                await updateAdminDashboard();
                await loadLateFeeSettings();
                await loadApartmentsListPage();
                await loadAdminView();
            } catch(error) {
                console.error("Admin paneli kurulurken hata:", error);
                showMessage('loginMessage', 'Admin paneli yüklenirken bir hata oluştu.', true);
                logout();
            }
        }
        
        function addEventListeners() {
            document.getElementById('loginButton').addEventListener('click', login);
            document.getElementById('logoutBtnUser').addEventListener('click', logout);
            document.getElementById('logoutBtnAdmin').addEventListener('click', logout);
            
            document.getElementById('balanceSummary').addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('debtDetails').classList.toggle('active');
            });
            document.getElementById('showDebtBtn').addEventListener('click', () => { 
                if (!document.getElementById('showDebtBtn').disabled) {
                    showPage('debtPage'); 
                    loadUserTable(loggedInUsername); 
                }
            });
            document.getElementById('showProfileBtn').addEventListener('click', () => { showPage('profilePage'); loadUserProfile(); });
            document.getElementById('showExpensesBtn').addEventListener('click', () => { showPage('expensesPage'); loadUserExpensesTable(); });

            document.getElementById('saveRegistrationBtn').addEventListener('click', saveRegistrationData);
           
            document.getElementById('changePasswordBtn').addEventListener('click', changeUserPassword);
            document.getElementById('addDebtBtn').addEventListener('click', ekleBorc);
            document.getElementById('lateFeeToggle').addEventListener('change', handleLateFeeToggle);
            document.getElementById('flatSelect').addEventListener('change', loadAdminView);
            document.getElementById('prevMonthBtn').addEventListener('click', () => {
                currentAdminDate.setMonth(currentAdminDate.getMonth() - 1);
                updateAdminDateDisplay();
            });
            document.getElementById('nextMonthBtn').addEventListener('click', () => {
                currentAdminDate.setMonth(currentAdminDate.getMonth() + 1);
                updateAdminDateDisplay();
            });

            document.getElementById('expensePrevMonthBtn').addEventListener('click', () => {
                currentExpenseDate.setMonth(currentExpenseDate.getMonth() - 1);
                updateExpenseDateDisplay();
            });
            document.getElementById('expenseNextMonthBtn').addEventListener('click', () => {
                currentExpenseDate.setMonth(currentExpenseDate.getMonth() + 1);
                updateExpenseDateDisplay();
            });

            document.getElementById('downloadAccountStatementBtn').addEventListener('click', (e) => {
                const daireId = document.getElementById('flatSelect').value;
                if (daireId && daireId !== 'all_apartments') {
                    downloadApartmentStatementPdf(daireId, 'year');
                } else {
                    showMessage("adminTableMessage", "Lütfen rapor oluşturmak için bir daire seçin.", true);
                }
            });
            document.getElementById('downloadApartmentStatementBtn').addEventListener('click', async (e) => {
                const daireId = e.target.dataset.daire;
                if (daireId) {
                    await downloadApartmentStatementPdf(daireId, 'all');
                }
            });
            document.getElementById('deleteApartmentBtn').addEventListener('click', (e) => {
                 const daireId = e.target.dataset.daire;
                if (daireId) {
                    deleteApartmentProfile(daireId);
                }
            });
            document.getElementById('editApartmentDetailBtn').addEventListener('click', (e) => {
                const daireId = e.target.dataset.daire;
                if(daireId) {
                    editApartmentDetails(daireId);
                }
            });

            document.getElementById('downloadMonthlyReportBtn').addEventListener('click', downloadMonthlyReportPdf);
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadProfileTemplate);
            document.getElementById('uploadTemplateBtn').addEventListener('click', () => document.getElementById('profileTemplateInput').click());
            document.getElementById('profileTemplateInput').addEventListener('change', uploadProfileTemplate);
            document.getElementById('downloadAllProfilesCsvBtn').addEventListener('click', downloadAllProfilesCsv);
            document.getElementById('saveExpenseBtn').addEventListener('click', saveExpense);
            document.getElementById('publishButton').addEventListener('click', toggleExpensesVisibility);
            document.getElementById('downloadMonthlyExpensesBtn').addEventListener('click', downloadMonthlyExpensesPdf);
            document.getElementById('deleteAllDebtsBtn').addEventListener('click', deleteAllDebts);
            document.getElementById('savePasswordBtn').addEventListener('click', sifreAyarla);
            document.getElementById('saveAdminPasswordBtn').addEventListener('click', setAdminPassword);
            
             document.getElementById('loginTerms').addEventListener('change', function() {
                document.getElementById('loginButton').disabled = !this.checked;
            });

            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', (event) => {
                    if (event.target.closest('.refresh-icon')) { return; }
                    const content = header.nextElementSibling;
                    header.classList.toggle('active');
                    content.classList.toggle('active');
                    content.style.maxHeight = content.classList.contains('active') ? content.scrollHeight + "px" : null;
                    if (header.id === 'balanceSectionHeader' && header.classList.contains('active')) {
                        calculateAndShowBalance();
                    }
                });
            });
            
            document.getElementById('refreshBalanceBtn').addEventListener('click', calculateAndShowBalance);
            document.getElementById('refreshDashboardBtn').addEventListener('click', updateAdminDashboard);

            document.getElementById('adminPanel').addEventListener('click', function(event) {
                const target = event.target.closest('.admin-action-btn');
                if (!target) return;
                const action = target.dataset.action;
                const daire = target.dataset.daire;
                const id = target.dataset.id;
                if (action === 'mark-paid') markPaid(daire, id);
                else if (action === 'edit-debt') editDebt(daire, id);
                else if (action === 'delete-debt') silBorc(daire, id);
                else if (action === 'delete-expense') deleteExpense(id);
            });

             document.getElementById('apartmentSearchInput').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = allApartmentsData.filter(daire => {
                    const ownerName = `${daire.adi || ''} ${daire.soyadi || ''}`.toLowerCase();
                    return daire.id.toLowerCase().includes(searchTerm) || ownerName.includes(searchTerm);
                });
                renderApartmentList(filteredData);
            });
            
            document.getElementById('apartmentListContainer').addEventListener('click', (event) => {
                const listItem = event.target.closest('.apartment-list-item');
                if(listItem) {
                    const daireId = listItem.dataset.daire;
                    openApartmentDetailModal(daireId);
                }
            });
            
            const modal = document.getElementById('termsModal');
            document.getElementById('openTermsModal').addEventListener('click', (e) => {
                e.preventDefault();
                modal.style.display = 'block';
            });
            document.getElementById('modalCloseBtn').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        async function sifreAyarla() {
            const daire = document.getElementById("sifreDaire").value;
            const yeniSifre = document.getElementById("yeniSifre").value;
            if (yeniSifre.length < 3) return showMessage("passwordMessage", "Şifre en az 3 karakter olmalı.", true);
            try {
                await setDoc(doc(db, 'apartments', daire), { password: yeniSifre }, { merge: true });
                showMessage("passwordMessage", `${daire} şifresi güncellendi.`);
            } catch (e) {
                showMessage("passwordMessage", "Şifre güncellenemedi.", true);
            }
        }

        async function setAdminPassword() {
            const newPass = document.getElementById("adminYeniSifre").value;
            if (newPass.length < 5) return showMessage("passwordMessage", "Şifre en az 5 karakter olmalı.", true);
            try {
                await setDoc(doc(db, 'admin', 'credentials'), { password: newPass }, { merge: true });
                adminCredentials.password = newPass;
                showMessage("passwordMessage", "Yönetici şifresi güncellendi.");
            } catch (e) {
                showMessage("passwordMessage", "Şifre güncellenemedi.", true);
            }
        }
        
         async function loadApartmentsListPage() {
            try {
                allApartmentsData = [];
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonthIndex = today.getMonth();

                for(const daireId of daireler) {
                    const flatDoc = await getDocFromFirestore(doc(db, 'apartments', daireId));
                    const flatData = flatDoc.exists() ? flatDoc.data() : {};
                    
                    let unpaidBalance = 0;
                    const debtsSnapshot = await getDocs(query(collection(db, 'apartments', daireId, 'debts'), where('odendi', '==', false)));
                    
                    debtsSnapshot.forEach(debtDoc => {
                        const entry = debtDoc.data();
                        const [debtMonthStr, debtYearStr] = entry.ay.split(' ');
                        if (!debtMonthStr || !debtYearStr) return; 

                        const debtYear = parseInt(debtYearStr, 10);
                        const debtMonthIndex = aylar.indexOf(debtMonthStr);

                        const isDue = debtYear < currentYear || (debtYear === currentYear && debtMonthIndex <= currentMonthIndex);
                        
                        if (isDue) {
                            unpaidBalance += Number(entry.tutar);
                        }
                    });

                    allApartmentsData.push({
                        id: daireId,
                        ...flatData,
                        unpaidBalance: unpaidBalance
                    });
                }
                renderApartmentList(allApartmentsData);
            } catch(error) {
                console.error("Daire listesi yüklenirken hata:", error);
            }
        }
        
        function renderApartmentList(apartments) {
            const container = document.getElementById('apartmentListContainer');
            if (apartments.length === 0) {
                container.innerHTML = `<p style="text-align: center; padding: 20px;">Sonuç bulunamadı.</p>`;
                return;
            }
            container.innerHTML = apartments.map(daire => {
                const ownerName = `${daire.adi || 'Tapu Sahibi'} ${daire.soyadi || 'Bilgisi Yok'}`;
                const balanceClass = daire.unpaidBalance > 0 ? '' : 'zero';
                return `
                    <div class="apartment-list-item" data-daire="${daire.id}">
                        <div class="apartment-info">
                            <span class="daire-no">${daire.id}</span>
                            <span class="owner-name">${ownerName}</span>
                        </div>
                        <div class="apartment-balance">
                            <span class="balance-value ${balanceClass}">₺${daire.unpaidBalance.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function openApartmentDetailModal(daireId) {
            const modal = document.getElementById('apartmentDetailModal');
            const content = document.getElementById('apartmentDetailContent');
            const title = document.getElementById('apartmentDetailTitle');
            
            title.textContent = `${daireId} Daire Detayları`;
            content.innerHTML = `<p>Yükleniyor...</p>`;
            modal.style.display = 'block';

            // Fetch fresh data every time modal opens to ensure it's up to date
            const flatDocSnap = await getDocFromFirestore(doc(db, 'apartments', daireId));
            const data = flatDocSnap.exists() ? flatDocSnap.data() : {};
            data.id = daireId; 

            // Calculate unpaid balance for this specific apartment
            let unpaidBalance = 0;
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonthIndex = today.getMonth();
            const debtsSnapshot = await getDocs(query(collection(db, 'apartments', daireId, 'debts'), where('odendi', '==', false)));
            debtsSnapshot.forEach(debtDoc => {
                const entry = debtDoc.data();
                const [debtMonthStr, debtYearStr] = entry.ay.split(' ');
                if (!debtMonthStr || !debtYearStr) return; 
                const debtYear = parseInt(debtYearStr, 10);
                const debtMonthIndex = aylar.indexOf(debtMonthStr);
                const isDue = debtYear < currentYear || (debtYear === currentYear && debtMonthIndex <= currentMonthIndex);
                if (isDue) {
                    unpaidBalance += Number(entry.tutar);
                }
            });
            data.unpaidBalance = unpaidBalance;

            // Update the global data array as well
            const dataIndex = allApartmentsData.findIndex(d => d.id === daireId);
            if (dataIndex !== -1) {
                allApartmentsData[dataIndex] = data;
            } else {
                allApartmentsData.push(data);
            }

            document.getElementById('editApartmentDetailBtn').dataset.daire = daireId;
            document.getElementById('downloadApartmentStatementBtn').dataset.daire = daireId;
            document.getElementById('deleteApartmentBtn').dataset.daire = daireId;

            if(currentAdminRole === 'viewer'){
                document.getElementById('editApartmentDetailBtn').classList.add('hidden');
                document.getElementById('deleteApartmentBtn').classList.add('hidden');
            }

            const lastLogin = data.lastLogin ? new Date(data.lastLogin.seconds * 1000).toLocaleString('tr-TR') : 'Hiç giriş yapmadı';
            
            content.innerHTML = `
                <div class="detail-section">
                    <h5>Tapu Sahibi Bilgileri</h5>
                    <div class="detail-item"><strong>Adı Soyadı:</strong> <span>${data.adi || ''} ${data.soyadi || ''}</span></div>
                    <div class="detail-item"><strong>Telefon:</strong> <span>${data.telefon || 'N/A'}</span></div>
                    <div class="detail-item"><strong>Telefon 2:</strong> <span>${data.telefon2 || 'N/A'}</span></div>
                    <div class="detail-item"><strong>E-posta:</strong> <span>${data.mail || 'N/A'}</span></div>
                    <div class="detail-item"><strong>Adres:</strong> <span>${data.adres || 'N/A'}</span></div>
                     <div class="detail-item"><strong>Son Giriş:</strong> <span>${lastLogin}</span></div>
                </div>

                 <div class="detail-section">
                    <h5>Bakiye Detayları</h5>
                    <p>Ödenmemiş Toplam Bakiye: <strong>₺${data.unpaidBalance.toFixed(2)}</strong></p>
                    <div id="detailDebtList"></div>
                </div>
            `;
        }

        async function deleteApartmentProfile(daireId) {
            if (confirm(`${daireId} daire profili ve ilgili tüm borçlar kalıcı olarak silinecektir! Bu işlem geri alınamaz. Emin misiniz?`)) {
                try {
                    const batch = writeBatch(db);
                    
                    const debtsSnapshot = await getDocs(collection(db, 'apartments', daireId, 'debts'));
                    debtsSnapshot.forEach(d => batch.delete(d.ref));
                    
                    const flatDocRef = doc(db, 'apartments', daireId);
                    batch.update(flatDocRef, {
                        adi: deleteField(),
                        soyadi: deleteField(),
                        telefon: deleteField(),
                        telefon2: deleteField(),
                        mail: deleteField(),
                        adres: deleteField(),
                        profileCompleted: deleteField()
                    });
                    
                    await batch.commit();
                    
                    showMessage("adminTableMessage", `${daireId} profili başarıyla silindi.`);
                    document.getElementById('apartmentDetailModal').style.display = 'none';
                    await loadApartmentsListPage(); 
                } catch (e) {
                    console.error("Profil silinirken hata:", e);
                    showMessage("adminTableMessage", "Profil silinirken bir hata oluştu.", true);
                }
            }
        }
        
        async function editApartmentDetails(daireId) {
            const flatDocRef = doc(db, 'apartments', daireId);
            const flatDocSnap = await getDocFromFirestore(flatDocRef);
            if (!flatDocSnap.exists()) {
                return alert("Daire bilgileri bulunamadı.");
            }
            const userData = flatDocSnap.data();

            // Owner info
            const newAdi = prompt(`Tapu Sahibi Adı:`, userData.adi || '');
            if (newAdi === null) return;
            const newSoyadi = prompt(`Tapu Sahibi Soyadı:`, userData.soyadi || '');
            if (newSoyadi === null) return;
            const newTelefon = prompt(`Telefon:`, userData.telefon || '');
            if (newTelefon === null) return;
            const newTelefon2 = prompt(`Telefon 2:`, userData.telefon2 || '');
            if (newTelefon2 === null) return;
            const newMail = prompt(`E-posta:`, userData.mail || '');
            if (newMail === null) return;
            const newAdres = prompt(`Adres:`, userData.adres || '');
            if (newAdres === null) return;

            const updateData = {
                adi: newAdi,
                soyadi: newSoyadi,
                telefon: newTelefon,
                telefon2: newTelefon2,
                mail: newMail,
                adres: newAdres
            };

            try {
                await updateDoc(flatDocRef, updateData);
                alert("Profil bilgileri güncellendi.");
                await loadApartmentsListPage(); // Refresh all data
                openApartmentDetailModal(daireId); // Re-open modal with fresh data
            } catch (e) {
                console.error("Profil güncellenirken hata:", e);
                alert("Profil güncellenirken bir hata oluştu.");
            }
        }

        async function downloadMonthlyExpensesPdf() {
            const month = aylar[currentExpenseDate.getMonth()];
            const year = currentExpenseDate.getFullYear();
            showMessage("expenseMessage", `${month} ${year} için gider raporu oluşturuluyor...`, false);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const expenseData = [];
            let totalExpense = 0;
            try {
                const q = query(collection(db, 'expenses'), where("tarih_ay", "==", month), where("tarih_yil", "==", Number(year)));
                const expensesSnapshot = await getDocs(q);

                if (expensesSnapshot.empty) {
                   return showMessage("expenseMessage", "Seçili ay için gider kaydı bulunamadı.", true);
                }

                expensesSnapshot.forEach(docSnap => {
                    const expense = docSnap.data();
                    expenseData.push([
                        new Date(expense.tarih).toLocaleDateString('tr-TR'),
                        expense.harcamaAdi,
                        `${Number(expense.tutar).toFixed(2)} TL`
                    ]);
                    totalExpense += Number(expense.tutar);
                });

                expenseData.sort((a, b) => new Date(b[0].split('.').reverse().join('-')) - new Date(a[0].split('.').reverse().join('-')));

                doc.autoTable({
                    head: [['Tarih', 'Harcama Adı', 'Tutar']],
                    body: expenseData,
                    didDrawPage: function (data) {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(18);
                        doc.text(`Aylık Gider Raporu - ${month} ${year}`, 105, 20, { align: "center" });
                        doc.setFontSize(12);
                        doc.text(`Rapor Tarihi: ${new Date().toLocaleDateString('tr-TR')}`, 105, 28, { align: "center" });
                    },
                    startY: 35,
                    theme: 'grid',
                    styles: { font: 'helvetica' },
                    foot: [['', 'Aylık Toplam Gider', `${totalExpense.toFixed(2)} TL`]],
                    footStyles: { fontStyle: 'bold', fillColor: [219, 233, 244] }
                });
                
                const filename = `Aylik_Gider_Raporu_${month}_${year}.pdf`;
                doc.save(filename);
                showMessage("expenseMessage", "Aylık gider raporu başarıyla indirildi.");

            } catch (error) {
                console.error("Aylık gider PDF'i oluşturulurken hata:", error);
                showMessage("expenseMessage", "PDF oluşturulurken bir hata oluştu.", true);
            }
        }
        
        async function initialize() {
            try {
                // Force enable network to avoid offline errors on initial load
                await enableNetwork(db);

                const adminDoc = await getDocFromFirestore(doc(db, 'admin', 'credentials'));
                if (adminDoc.exists()) {
                    adminCredentials = adminDoc.data();
                } else {
                    await setDoc(doc(db, 'admin', 'credentials'), adminCredentials);
                }

                const batch = writeBatch(db);
                let passwordSetCount = 0;
                for (const daire of daireler) {
                    const flatDocRef = doc(db, 'apartments', daire);
                    const flatDocSnap = await getDocFromFirestore(flatDocRef);
                    if (!flatDocSnap.exists() || !flatDocSnap.data().password) {
                        const newPassword = generateRandomPassword();
                        batch.set(flatDocRef, { password: newPassword }, { merge: true });
                        passwordSetCount++;
                    }
                }
                if (passwordSetCount > 0) {
                    await batch.commit();
                    console.log(`${passwordSetCount} daireye yeni şifre atandı.`);
                }
            } catch (error) {
                console.error("Sistem başlatılırken hata:", error);
                showMessage('loginMessage', 'Sistem başlatılırken bir hata oluştu.', true);
            }
        }

        addEventListeners();
        initialize();
    });
  </script>
</body>
</html>

