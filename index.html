<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Ayvalık Yıldız Konakları - Aidat Takip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary-color: #014f86;
      --secondary-color: #468faf;
      --background-color: #f0f4f8;
      --container-bg: #fff8f0;
      --text-color: #333;
      --border-color: #ccc;
      --hover-color: #014f86;
      --danger-color: #dc3545;
      --danger-hover: #c82333;
      --success-color: #28a745;
      --success-hover: #218838;
      --info-color: #17a2b8;
      --info-hover: #138496;
      --warning-color: #ffc107;
      --warning-hover: #e0a800;
      --publish-bg: #e67e22;
      --publish-hover: #d35400;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--background-color);
      color: var(--text-color);
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: var(--container-bg);
      padding: 5px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1, h2, h3, h4 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 12px;
      margin: 8px 0;
      width: 100%;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      font-size: 16px;
    }
    button {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: var(--hover-color);
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .hidden { display: none !important; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid var(--border-color);
      padding: 12px;
      text-align: center;
    }
    th {
      background-color: #dbe9f4;
      font-weight: bold;
    }
    .totals {
      margin-top: 20px;
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
    }
    .delete-btn { background-color: var(--danger-color); }
    .delete-btn:hover:not(:disabled) { background-color: var(--danger-hover); }
    .edit-btn { background-color: var(--warning-color); color: var(--text-color); }
    .edit-btn:hover:not(:disabled) { background-color: var(--warning-hover); }
    .download-btn, .backup-btn { background-color: var(--success-color); }
    .download-btn:hover:not(:disabled), .backup-btn:hover:not(:disabled) { background-color: var(--success-hover); }
    .upload-btn { background-color: var(--info-color); }
    .upload-btn:hover:not(:disabled) { background-color: var(--info-hover); }
    .message { text-align: center; color: var(--success-color); margin-top: 10px; font-weight: bold; }
    .error-message { text-align: center; color: var(--danger-color); margin-top: 10px; font-weight: bold; }
    .bank-info { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px dashed var(--border-color); font-size: 0.9em; color: #555; }
    .section-divider { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); }
    .unpaid-debt { color: var(--danger-color); font-weight: bold; }
    .collapsible-header {
      background-color: #dbe9f4;
      color: var(--primary-color);
      cursor: pointer;
      padding: 18px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 18px;
      border-radius: 6px;
      margin-top: 15px;
      transition: background-color 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .collapsible-header:hover { background-color: #c0d8eb; }
    .collapsible-content {
      padding: 0 18px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
      background-color: #f7f9fc;
      border-radius: 6px;
    }
    .collapsible-content.active {
      max-height: 1000px; /* Büyük değer, içeriğe göre ayarlanabilir */
      padding: 18px;
    }
    .collapsible-header:after {
      content: '+';
      font-weight: bold;
      font-size: 24px;
      margin-left: 5px;
    }
    .collapsible-header.active:after { content: '-'; }
    .user-profile-display {
      background: #e9f2fa;
      border: 1px solid #c0d8eb;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 1.1em;
      text-align: center;
    }
    .user-profile-display p {
      margin: 5px 0;
    }
    .user-profile-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    .table-responsive {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .publish-btn {
      background-color: var(--publish-bg);
      color: white;
    }
    .publish-btn:hover {
      background-color: var(--publish-hover);
    }
    
    /* --- YENİ EKLENEN/DEĞİŞTİRİLEN KISIM BAŞLANGIÇ --- */
    .balance-summary-card {
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .balance-summary-card:hover {
        background-color: #f8f9fa;
    }
    .summary-title {
        font-size: 1em;
        color: var(--text-color);
        display: block;
    }
    .summary-amount {
        font-size: 1.2em;
        font-weight: bold;
        color: var(--danger-color);
    }
    .summary-arrow {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-color);
        transition: transform 0.2s ease-out;
    }
    .balance-summary-card.active .summary-arrow {
        transform: rotate(180deg);
    }
    .collapsible-debt-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background-color: #fdfdfd;
        border-radius: 6px;
    }
    .collapsible-debt-details.active {
        max-height: 1500px;
        padding: 5px;
        border: 1px solid #eee;
    }
    /* --- YENİ EKLENEN/DEĞİŞTİRİLEN KISIM BİTİŞ --- */

  </style>
</head>
<body>
  <div class="container">
    <h1>Ayvalık Yıldız Konakları</h1>
    <h2>Aidat Takip Sistemi</h2>

    <div id="login">
      <h3>Giriş Yap</h3>
      <input type="text" id="username" placeholder="Kullanıcı Adı (örn: A1)">
      <input type="password" id="password" placeholder="Şifre (örn: 1256)">
      <button id="loginButton" onclick="login()" disabled>Giriş</button>
      <div id="loginMessage" class="message hidden"></div>
    </div>

    <div id="userPanel" class="hidden">
      <h3>Hoş Geldiniz, <span id="userNameDisplay"></span></h3>
      
      <!-- Kullanıcı Menüsü -->
      <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
        <button id="showDebtBtn" style="flex-grow: 1;">Bakiye</button>
        <button id="showProfileBtn" style="flex-grow: 1;">Profilim</button>
        <button id="showExpensesBtn" style="flex-grow: 1;" class="hidden">Giderler</button>
      </div>

      <!-- Profil bilgilerini tamamlaması için uyarı mesajı -->
      <div id="profileIncompleteMessage" class="error-message hidden"></div>

      <!-- Borç Sayfası -->
      <div id="debtPage">
        <h4>Bakiyeniz</h4>

        <!-- YENİ EKLENEN/DEĞİŞTİRİLEN KISIM BAŞLANGIÇ -->
        <div id="balanceSummary" class="balance-summary-card">
            <div>
                <span class="summary-title">Ödenmemiş Toplam Bakiye</span>
                <span id="userUnpaidTotal" class="summary-amount">Hesaplanıyor...</span>
            </div>
            <span class="summary-arrow">▽</span>
        </div>

        <div id="debtDetails" class="collapsible-debt-details">
            <div class="table-responsive">
              <table id="userTable">
                <tr><th>Ay</th><th>Tip</th><th>Tutar</th><th>Durum</th></tr>
              </table>
            </div>
            <div class="totals" id="userDebtTotals"></div>
        </div>
        <!-- YENİ EKLENEN/DEĞİŞTİRİLEN KISIM BİTİŞ -->
        
        <div class="bank-info">
          <p><strong>Yıldız Konakları Site Yönetimi</strong></p>
          <p><strong>IBAN:</strong> TR510001000110981102095001</p>
        </div>
      </div>

      <!-- Profil Sayfası -->
      <div id="profilePage" class="hidden">
        <h4>Profil Bilgilerim</h4>
        <input type="text" id="nameInput" placeholder="Adınız">
        <input type="text" id="surnameInput" placeholder="Soyadınız">
        <input type="text" id="phoneInput" placeholder="Telefon Numaranız">
        <button onclick="saveUserProfile()">Bilgileri Kaydet</button>
        <button onclick="changeUserPassword()">Şifremi Değiştir</button>
        <div id="profileMessage" class="message hidden"></div>
      </div>
      
      <!-- Giderler Sayfası -->
      <div id="expensesPage" class="hidden">
        <h4>Site Giderleri</h4>
        <div id="expenseNotPublishedMessage" class="message hidden"></div>
        <div id="expenseTableContainer">
          <div class="table-responsive">
            <table id="userExpenseTable">
              <tr><th>Tarih</th><th>Harcama Adı</th><th>Tutar</th></tr>
            </table>
          </div>
          <div class="totals" id="userExpenseTotals"></div>
        </div>
      </div>

      <div class="section-divider"></div>
      <button onclick="logout()">Çıkış Yap</button>
      <div id="userPasswordMessage" class="message hidden"></div>
    </div>

    <div id="adminPanel" class="hidden">
      <!-- Admin panel içeriği değişmediği için kısaltılmıştır -->
      <h3>Yönetici Paneli</h3>

      <div class="section-divider"></div>
      <button class="collapsible-header" onclick="toggleSection('aidatSection')">
        Aidat Tutarını Güncelle
      </button>
      <div id="aidatSection" class="collapsible-content">
        <input type="number" id="aidatTutariInput" placeholder="Yeni Aidat Tutarı (₺)">
        <button onclick="updateAidatTutari()">Aidat Tutarını Güncelle ve Tüm Dairelere Ekle</button>
        <div id="aidatMessage" class="message hidden"></div>
      </div>

      <div class="section-divider"></div>
      <button class="collapsible-header" onclick="toggleSection('newDebtSection')">
        Yeni Borç Ekle
      </button>
      <div id="newDebtSection" class="collapsible-content">
        <select id="borcTipi">
          <option value="aidat">Aidat</option>
          <option value="avans">Avans</option>
        </select>
        <input type="text" id="borcAy" placeholder="Ay (örn: Temmuz 2025)">
        <input type="number" id="borcTutar" placeholder="Tutar (₺)">
        <select id="borcKime"></select>
        <button onclick="ekleBorc()">Borç Ekle</button>
        <div id="addDebtMessage" class="message hidden"></div>
      </div>

      <div class="section-divider"></div>
      <button class="collapsible-header" onclick="toggleSection('passwordSection')">
        Daire ve Yönetici Şifre Ayarla
      </button>
      <div id="passwordSection" class="collapsible-content">
        <h5>Daire Şifresi Ayarla</h5>
        <select id="sifreDaire"></select>
        <input type="password" id="yeniSifre" placeholder="Yeni Daire Şifresi">
        <button onclick="sifreAyarla()">Daire Şifresini Kaydet</button>
        <button class="warning-btn" onclick="resetAllPasswords()">Tüm Daire Şifrelerini '1256' Yap</button>
        <div id="passwordMessage" class="message hidden"></div>

        <h5 style="margin-top: 20px;">Yönetici Şifresi Ayarla</h5>
        <input type="password" id="adminYeniSifre" placeholder="Yeni Yönetici Şifresi">
        <button onclick="setAdminPassword()">Yönetici Şifresini Kaydet</button>
        <div id="adminPasswordMessage" class="message hidden"></div>
      </div>

      <div class="section-divider"></div>
      <button class="collapsible-header" onclick="toggleSection('debtListSection')">
        Daire Borç Listesi
      </button>
      <div id="debtListSection" class="collapsible-content">
        <select id="flatSelect" onchange="loadAdminTable()"></select>
        <!-- Daire Sahibi Bilgileri Buraya Gelecek -->
        <div id="userInfoDisplay" class="user-profile-display hidden"></div>

        <button class="download-btn" onclick="downloadAllProfilesPdf()" style="margin-top: 20px;">Tüm Profil Bilgilerini İndir</button>
        <button class="download-btn" onclick="downloadAllDebtsPdf()">Tüm Borçları PDF Olarak İndir</button>
        
        <div class="table-responsive">
          <table id="adminTable">
            <tr><th>Ay</th><th>Tip</th><th>Tutar</th><th>Durum</th><th>İşlem</th></tr>
          </table>
        </div>
        
        <div class="totals" id="borcToplam"></div>
        <div id="adminTableMessage" class="message hidden"></div>
      </div>

      <!-- Giderler Bölümü -->
      <div class="section-divider"></div>
      <button class="collapsible-header" onclick="toggleSection('expenseSection')">
        Giderler
      </button>
      <div id="expenseSection" class="collapsible-content">
        <h4>Yeni Gider Ekle</h4>
        <input type="date" id="expenseDateInput">
        <input type="text" id="expenseNameInput" placeholder="Harcama Adı">
        <input type="number" id="expenseAmountInput" placeholder="Tutar (₺)">
        <button onclick="saveExpense()">Kaydet</button>
        <div id="expenseMessage" class="message hidden"></div>
        
        <h4>Gider Listesi</h4>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <select id="expenseMonthFilter" style="width: 50%;"></select>
          <select id="expenseYearFilter" style="width: 50%;"></select>
        </div>
        <button onclick="loadAdminExpensesTable(document.getElementById('expenseMonthFilter').value, document.getElementById('expenseYearFilter').value)">Filtrele</button>
        <button id="publishButton" onclick="toggleExpensesVisibility()" class="publish-btn">Yayınlanıyor...</button>
        <div class="table-responsive">
          <table id="adminExpenseTable">
            <tr><th>Tarih</th><th>Harcama Adı</th><th>Tutar</th><th>İşlem</th></tr>
          </table>
        </div>
        <div class="totals" id="adminExpenseTotals"></div>
      </div>

      <!-- Bakiye Bölümü -->
      <div class="section-divider"></div>
      <button class="collapsible-header" onclick="toggleSection('balanceSection'); calculateAndShowBalance();">
        Bakiye Durumu
      </button>
      <div id="balanceSection" class="collapsible-content">
        <h4>Genel Bakiye Durumu</h4>
        <div id="balanceDetails" style="text-align: center; font-size: 1.2em; padding: 20px;">
            <p><strong>Toplam Gelir (Ödenen Aidatlar/Avanslar):</strong> <span id="totalIncome">Hesaplanıyor...</span></p>
            <p><strong>Toplam Gider:</strong> <span id="totalExpense">Hesaplanıyor...</span></p>
            <hr style="margin: 15px 0;">
            <p><strong>Kalan Bakiye:</strong> <span id="remainingBalance" style="font-weight: bold; font-size: 1.3em;">Hesaplanıyor...</span></p>
        </div>
        <div id="balanceMessage" class="message hidden"></div>
      </div>

      <div class="section-divider"></div>
      <button class="collapsible-header" onclick="toggleSection('backupSection')">
        Yedekleme ve Geri Yükleme
      </button>
      <div id="backupSection" class="collapsible-content">
        <button class="backup-btn" onclick="backupData()">Verileri Yedekle (Bilgisayara İndir)</button>
        <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="restoreData(event)">
        <button class="upload-btn" onclick="document.getElementById('backupFileInput').click()">Yedekten Yükle (Dosya Seç)</button>
        <div id="backupRestoreMessage" class="message hidden"></div>
      </div>
      
      <div class="section-divider"></div>
      <button class="delete-btn" onclick="deleteAllDebts()">Tüm Dairelerin Tüm Borçlarını Sil</button>
      <button onclick="logout()">Çıkış Yap</button>
    </div>
  </div>

  <script type="module">
    // --- Firebase SDK Importları ve Başlangıç ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"; 
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      doc, 
      setDoc, 
      addDoc, 
      deleteDoc, 
      updateDoc, 
      getDoc, 
      query, 
      where,
      writeBatch,
      deleteField 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; 

    // Firebase yapılandırma bilgileri
    const firebaseConfig = {
      apiKey: "AIzaSyC7hS2P3m2xVfHrl0ONsMrVYv6uY-R-xNU",
      authDomain: "yildizkonaklariaidat.firebaseapp.com",
      projectId: "yildizkonaklariaidat",
      storageBucket: "yildizkonaklariaidat.firebasestorage.app",
      messagingSenderId: "51493869354",
      appId: "1:51493869354:web:556e64fc918fcc813c3053",
      measurementId: "G-4110SM95RV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Fonksiyonları global alana taşıma
    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
    window.doc = doc;
    window.setDoc = setDoc;
    window.addDoc = addDoc;
    window.deleteDoc = deleteDoc;
    window.updateDoc = updateDoc;
    window.getDoc = getDoc;
    window.query = query;
    window.where = where;
    window.writeBatch = writeBatch;
    window.deleteField = deleteField;

    // Global değişkenler
    const defaultAidat = 2000;
    const defaultPassword = "1256";
    let aidatTutari = defaultAidat; 
    let adminCredentials = { username: "admin", password: "admin123" }; 
    let passwords = {}; 
    let allApartmentDebts = {}; 
    let loggedInUsername = null;
    let publishedExpenseData = { published: false, month: null, year: null };
    const aylar = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];

    const daireler = [];
    ["A", "B", "C", "D", "E", "F", "G"].forEach(blok => {
      for (let i = 1; i <= 8; i++) daireler.push(`${blok}${i}`);
    });

    // --- Yardımcı Fonksiyonlar ---
    function showMessage(elementId, message, isError = false) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.classList.remove('hidden');
        element.className = isError ? 'error-message' : 'message';
        setTimeout(() => element.classList.add('hidden'), 3000);
    }
    
    function toggleSection(sectionId) {
      const header = document.querySelector(`[onclick^="toggleSection('${sectionId}')"]`);
      const content = document.getElementById(sectionId);
      header.classList.toggle('active');
      content.classList.toggle('active');
      content.style.maxHeight = content.classList.contains('active') ? content.scrollHeight + "px" : null;
    }
    window.toggleSection = toggleSection;

    function showPage(pageId) {
        ['debtPage', 'profilePage', 'expensesPage'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(pageId).classList.remove('hidden');
    }
    window.showPage = showPage;

    function fillExpenseFilters() {
      const monthSelect = document.getElementById('expenseMonthFilter');
      const yearSelect = document.getElementById('expenseYearFilter');
      monthSelect.innerHTML = aylar.map((ay, index) => `<option value="${ay}">${ay}</option>`).join('');
      const currentYear = new Date().getFullYear();
      let yearsHtml = '';
      for(let i = currentYear - 2; i <= currentYear + 1; i++) {
        yearsHtml += `<option value="${i}">${i}</option>`;
      }
      yearSelect.innerHTML = yearsHtml;
      monthSelect.value = aylar[new Date().getMonth()];
      yearSelect.value = currentYear;
    }

    // --- Veri Yükleme ve Başlangıç ---
    async function loadAuthDataFromFirebase() {
        const loginButton = document.getElementById("loginButton");
        loginButton.disabled = true;
        try {
            const adminDocRef = doc(db, 'admin', 'credentials');
            const adminDocSnap = await getDoc(adminDocRef);
            if (adminDocSnap.exists()) adminCredentials = adminDocSnap.data();
            else await setDoc(adminDocRef, adminCredentials); 

            const settingsDocRef = doc(db, 'settings', 'aidat');
            const settingsDocSnap = await getDoc(settingsDocRef);
            if (settingsDocSnap.exists()) aidatTutari = settingsDocSnap.data().amount || defaultAidat;
            else await setDoc(settingsDocRef, { amount: defaultAidat }); 

            const publishedExpensesRef = doc(db, 'settings', 'publishedExpenses');
            const publishedExpensesSnap = await getDoc(publishedExpensesRef);
            if (publishedExpensesSnap.exists()) publishedExpenseData = publishedExpensesSnap.data();
            else await setDoc(publishedExpensesRef, { published: false, month: null, year: null });

            const batch = writeBatch(db);
            for (const daire of daireler) {
                const flatDocRef = doc(db, 'apartments', daire);
                const flatDocSnap = await getDoc(flatDocRef);
                const currentData = flatDocSnap.data();
                if (!currentData || !currentData.password) {
                    batch.set(flatDocRef, { password: defaultPassword }, { merge: true });
                }
                passwords[daire] = (currentData && currentData.password) ? currentData.password : defaultPassword;
            }
            await batch.commit();
            loginButton.disabled = false; 
            showMessage("loginMessage", "Sistem hazır. Giriş yapabilirsiniz.");
        } catch (error) {
            console.error("Firebase'den veri yüklenirken hata oluştu:", error);
            showMessage("loginMessage", "Sistem başlatılırken bir hata oluştu.", true);
        }
    }

    // --- Giriş/Çıkış Fonksiyonları ---
    async function login() {
      const username = document.getElementById("username").value.trim().toUpperCase();
      const password = document.getElementById("password").value;
      
      if (username === adminCredentials.username.toUpperCase() && password === adminCredentials.password) {
        document.getElementById("login").classList.add("hidden");
        document.getElementById("adminPanel").classList.remove("hidden");
        fillFlatSelects();
        fillExpenseFilters();
        loadAdminExpensesTable(document.getElementById('expenseMonthFilter').value, document.getElementById('expenseYearFilter').value);
        await loadAllApartmentDebtsForBackup(); 
        loadAdminTable();
        return;
      }

      const flatDocRef = doc(db, 'apartments', username);
      const flatDocSnap = await getDoc(flatDocRef);

      if (!flatDocSnap.exists() || flatDocSnap.data().password !== password) {
        showMessage("loginMessage", "Kullanıcı adı veya şifre yanlış.", true);
        return;
      }

      document.getElementById("login").classList.add("hidden");
      document.getElementById("userPanel").classList.remove("hidden");
      document.getElementById("userNameDisplay").textContent = username;
      loggedInUsername = username;
      
      // YENİ EKLENEN/DEĞİŞTİRİLEN KISIM: Bakiye kartı tıklama olayı
      document.getElementById('balanceSummary').addEventListener('click', function() {
          this.classList.toggle('active');
          document.getElementById('debtDetails').classList.toggle('active');
      });

      showPage('debtPage');
      document.getElementById('showDebtBtn').onclick = () => {
          showPage('debtPage');
          loadUserTable(loggedInUsername);
      };
      document.getElementById('showProfileBtn').onclick = () => {
        showPage('profilePage');
        loadUserProfile();
      };

      await checkProfileAndToggleExpensesButton();
      loadUserTable(username); 
    }

    function logout() {
      location.reload(); 
    }
    
    async function changeUserPassword() {
      const newPassword = prompt("Yeni şifrenizi girin:");
      if (!newPassword || newPassword.length < 3) {
          return showMessage("userPasswordMessage", "Şifre en az 3 karakter olmalıdır.", true);
      }
      try {
          await updateDoc(doc(db, 'apartments', loggedInUsername), { password: newPassword });
          passwords[loggedInUsername] = newPassword;
          showMessage("userPasswordMessage", "Şifreniz başarıyla güncellendi.");
      } catch (error) {
          console.error("Şifre güncellenirken hata:", error);
          showMessage("userPasswordMessage", "Şifre güncellenirken bir sorun oluştu.", true);
      }
    }

    // --- Profil Fonksiyonları ---
    async function isProfileComplete() {
        if (!loggedInUsername) return false;
        const userDocSnap = await getDoc(doc(db, 'apartments', loggedInUsername));
        if (userDocSnap.exists()) {
            const { adi, soyadi, telefon } = userDocSnap.data();
            return !!adi && !!soyadi && !!telefon;
        }
        return false;
    }
    
    async function checkProfileAndToggleExpensesButton() {
        const expensesBtn = document.getElementById('showExpensesBtn');
        const warningMsg = document.getElementById('profileIncompleteMessage');
        if (await isProfileComplete()) {
            expensesBtn.classList.remove('hidden');
            warningMsg.classList.add('hidden');
            expensesBtn.onclick = () => {
                showPage('expensesPage');
                loadUserExpensesTable();
            };
        } else {
            expensesBtn.classList.add('hidden');
            warningMsg.textContent = "Giderleri görebilmek için lütfen profil bilgilerinizi (Ad, Soyad, Telefon) tamamlayın.";
            warningMsg.classList.remove('hidden');
        }
    }
    window.checkProfileAndToggleExpensesButton = checkProfileAndToggleExpensesButton;

    async function loadUserProfile() {
        const userDocSnap = await getDoc(doc(db, 'apartments', loggedInUsername));
        if (userDocSnap.exists()) {
            const { adi = '', soyadi = '', telefon = '' } = userDocSnap.data();
            document.getElementById('nameInput').value = adi;
            document.getElementById('surnameInput').value = soyadi;
            document.getElementById('phoneInput').value = telefon;
        }
    }

    async function saveUserProfile() {
        const adi = document.getElementById('nameInput').value.trim();
        const soyadi = document.getElementById('surnameInput').value.trim();
        const telefon = document.getElementById('phoneInput').value.trim();

        if (!adi || !soyadi || !telefon) {
            return showMessage("profileMessage", "Lütfen tüm alanları doldurunuz.", true);
        }

        try {
            await updateDoc(doc(db, 'apartments', loggedInUsername), { adi, soyadi, telefon });
            showMessage("profileMessage", "Profil bilgileriniz kaydedildi.");
            await checkProfileAndToggleExpensesButton();
        } catch (error) {
            console.error("Profil kaydedilirken hata:", error);
            showMessage("profileMessage", "Bilgiler kaydedilirken bir sorun oluştu.", true);
        }
    }

    // --- Kullanıcı Paneli Fonksiyonları ---
    async function loadUserTable(username) {
      const table = document.getElementById("userTable");
      const unpaidTotalSpan = document.getElementById("userUnpaidTotal"); 
      unpaidTotalSpan.textContent = "Hesaplanıyor...";
      
      table.innerHTML = '<tr><th>Ay</th><th>Tip</th><th>Tutar</th><th>Durum</th></tr>';
      let totalPaid = 0;
      let totalUnpaid = 0;

      try {
        const debtSnapshot = await getDocs(collection(db, 'apartments', username, 'debts'));

        if (debtSnapshot.empty) {
            table.innerHTML += '<tr><td colspan="4">Borcunuz bulunmamaktadır.</td></tr>';
            document.getElementById("userDebtTotals").textContent = `Ödenen: 0 TL | Ödenmemiş: 0 TL`;
            unpaidTotalSpan.textContent = `₺0,00`;
            return;
        }
        
        const debts = [];
        debtSnapshot.forEach(doc => debts.push(doc.data()));
        
        // Borçları tarihe göre sıralama (isteğe bağlı, daha iyi görünüm için)
        // Bu kısım ay formatına göre (örn: "Ağustos 2025") basit bir sıralama yapar.
        // Daha karmaşık sıralama gerekirse bu mantık geliştirilebilir.
        debts.sort((a, b) => {
            const [ayA, yilA] = a.ay.split(' ');
            const [ayB, yilB] = b.ay.split(' ');
            if (yilA !== yilB) return yilA.localeCompare(yilB);
            return aylar.indexOf(ayA) - aylar.indexOf(ayB);
        });

        let tableContent = '';
        debts.forEach(entry => {
          const statusText = entry.odendi ? "Ödendi" : "Bekliyor";
          const rowClass = entry.odendi ? "" : "unpaid-debt";
          tableContent += `<tr class="${rowClass}"><td>${entry.ay}</td><td>${entry.tip}</td><td>${entry.tutar} TL</td><td>${statusText}</td></tr>`;

          if (entry.odendi) totalPaid += Number(entry.tutar);
          else totalUnpaid += Number(entry.tutar);
        });
        
        table.innerHTML += tableContent;
        
        // Para birimi formatını (örn: ₺11.804,22) ayarla
        unpaidTotalSpan.textContent = `₺${totalUnpaid.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById("userDebtTotals").textContent = `Ödenen Toplam: ${totalPaid} TL | Ödenmeyen Toplam: ${totalUnpaid} TL`;
      } catch (error) {
        console.error("Kullanıcı borçları yüklenirken hata:", error);
        showMessage("loginMessage", "Borçlar yüklenirken bir sorun oluştu.", true);
        unpaidTotalSpan.textContent = "Hata oluştu";
      }
    }

    async function loadUserExpensesTable() {
        const tableContainer = document.getElementById("expenseTableContainer");
        const notPublishedMsg = document.getElementById("expenseNotPublishedMessage");
        
        const publishedExpensesSnap = await getDoc(doc(db, 'settings', 'publishedExpenses'));
        const pubData = publishedExpensesSnap.exists() ? publishedExpensesSnap.data() : { published: false };

        if (!pubData.published) {
            tableContainer.classList.add('hidden');
            notPublishedMsg.textContent = "Giderler ay sonunda burada gösterilecektir.";
            notPublishedMsg.classList.remove('hidden');
            return;
        } 
        
        tableContainer.classList.remove('hidden');
        notPublishedMsg.classList.add('hidden');

        const table = document.getElementById("userExpenseTable");
        table.innerHTML = '<tr><th>Tarih</th><th>Harcama Adı</th><th>Tutar</th></tr>';
        let totalExpense = 0;

        try {
            const q = query(collection(db, 'expenses'), 
              where("tarih_ay", "==", pubData.month),
              where("tarih_yil", "==", Number(pubData.year))
            );
            const expensesSnapshot = await getDocs(q);

            if (expensesSnapshot.empty) {
                table.innerHTML += '<tr><td colspan="3">Yayınlanmış gider kaydı bulunmamaktadır.</td></tr>';
            } else {
                let expensesHtml = '';
                expensesSnapshot.forEach(doc => {
                    const expense = doc.data();
                    expensesHtml += `<tr><td>${expense.tarih}</td><td>${expense.harcamaAdi}</td><td>${expense.tutar} TL</td></tr>`;
                    totalExpense += Number(expense.tutar);
                });
                table.innerHTML += expensesHtml;
            }
            document.getElementById("userExpenseTotals").textContent = `Toplam Gider: ${totalExpense} TL`;
        } catch (error) {
            console.error("Kullanıcı giderleri yüklenirken hata:", error);
            showMessage("userPasswordMessage", "Gider listesi yüklenirken bir sorun oluştu.", true);
        }
    }

    // --- Yönetici Paneli Fonksiyonları (değişiklik yapılmadı) ---
    // Bu bölümdeki fonksiyonlar önceki versiyon ile aynı olduğu için kısaltılmıştır.
    // Tam kod dosyanın en üstündedir.
    function fillFlatSelects() {
        const selects = ["flatSelect", "borcKime", "sifreDaire"];
        selects.forEach(id => {
            const select = document.getElementById(id);
            select.innerHTML = "";
            if (id === "borcKime") {
                select.innerHTML += `<option value="all_apartments">Tüm Daireler</option>`;
            }
            daireler.forEach(daire => select.innerHTML += `<option value="${daire}">${daire}</option>`);
        });
    }

    async function loadAdminTable() {
      const daire = document.getElementById("flatSelect").value;
      const table = document.getElementById("adminTable");
      const userInfoDisplay = document.getElementById("userInfoDisplay");
      table.innerHTML = '<tr><th>Ay</th><th>Tip</th><th>Tutar</th><th>Durum</th><th>İşlem</th></tr>';
      
      try {
        const flatDocSnap = await getDoc(doc(db, 'apartments', daire));
        const userData = flatDocSnap.exists() ? flatDocSnap.data() : {};
        userInfoDisplay.innerHTML = `<p><strong>Daire:</strong> ${daire}</p>
            <p><strong>Adı Soyadı:</strong> ${userData.adi || 'Bilgi Yok'} ${userData.soyadi || ''}</p>
            <p><strong>Telefon:</strong> ${userData.telefon || 'Bilgi Yok'}</p>
            <div class="user-profile-actions">
              <button class="edit-btn" onclick="editUserProfileAsAdmin('${daire}')">Düzenle</button>
              <button class="delete-btn" onclick="deleteUserProfileAsAdmin('${daire}')">Sil</button>
            </div>`;
        userInfoDisplay.classList.remove("hidden");

        const debtSnapshot = await getDocs(collection(db, 'apartments', daire, 'debts'));
        if (debtSnapshot.empty) {
            table.innerHTML += '<tr><td colspan="5">Bu daire için borç bulunmamaktadır.</td></tr>';
            document.getElementById("borcToplam").textContent = `Toplam: 0 TL | Ödenen: 0 TL | Kalan: 0 TL`;
            return;
        }

        let toplam = 0, odenen = 0;
        let rowsHtml = '';
        debtSnapshot.forEach(doc => {
          const entry = doc.data();
          toplam += Number(entry.tutar);
          if (entry.odendi) odenen += Number(entry.tutar);
          rowsHtml += `<tr>
            <td>${entry.ay}</td><td>${entry.tip}</td><td>${entry.tutar} TL</td>
            <td>${entry.odendi ? "Ödendi" : "Bekliyor"}</td>
            <td>
              ${entry.odendi ? "-" : `<button onclick="markPaid('${daire}', '${doc.id}')">Ödendi</button>`}
              <button class="edit-btn" onclick="editDebt('${daire}', '${doc.id}')">Düzenle</button>
              <button class="delete-btn" onclick="silBorc('${daire}', '${doc.id}')">Sil</button>
            </td></tr>`;
        });
        table.innerHTML += rowsHtml;
        document.getElementById("borcToplam").textContent = `Toplam: ${toplam} TL | Ödenen: ${odenen} TL | Kalan: ${toplam - odenen} TL`;
      } catch (error) {
        console.error("Yönetici borçları yüklenirken hata:", error);
        showMessage("adminTableMessage", "Borçlar yüklenirken bir sorun oluştu.", true);
      }
    }
    
    // Diğer yönetici fonksiyonları...
    window.login = login;
    window.logout = logout;
    window.loadUserTable = loadUserTable; 
    window.fillFlatSelects = fillFlatSelects; 
    window.loadAdminTable = loadAdminTable; 
    window.changeUserPassword = changeUserPassword;
    window.loadUserProfile = loadUserProfile;
    window.saveUserProfile = saveUserProfile;
    window.loadUserExpensesTable = loadUserExpensesTable; 
    
    // Admin fonksiyonlarını globale ekleme (kısaltıldı)
    async function markPaid(daire, debtId) { /* ... */ }
    async function ekleBorc() { /* ... */ }
    async function silBorc(daire, debtId) { /* ... */ }
    async function editDebt(daire, debtId) { /* ... */ }
    async function updateAidatTutari() { /* ... */ }
    async function sifreAyarla() { /* ... */ }
    async function resetAllPasswords() { /* ... */ }
    async function setAdminPassword() { /* ... */ }
    async function deleteAllDebts() { /* ... */ }
    async function downloadAllDebtsPdf() { /* ... */ }
    async function downloadAllProfilesPdf() { /* ... */ }
    async function backupData() { /* ... */ }
    async function restoreData(event) { /* ... */ }
    async function saveExpense() { /* ... */ }
    async function loadAdminExpensesTable(month, year) { /* ... */ }
    async function deleteExpense(expenseId) { /* ... */ }
    async function toggleExpensesVisibility() { /* ... */ }
    async function calculateAndShowBalance() { /* ... */ }
    async function editUserProfileAsAdmin(daire) { /* ... */ }
    async function deleteUserProfileAsAdmin(daire) { /* ... */ }

    window.markPaid = markPaid;
    window.ekleBorc = ekleBorc;
    window.silBorc = silBorc;
    window.editDebt = editDebt;
    window.updateAidatTutari = updateAidatTutari;
    window.sifreAyarla = sifreAyarla;
    window.resetAllPasswords = resetAllPasswords;
    window.setAdminPassword = setAdminPassword;
    window.deleteAllDebts = deleteAllDebts;
    window.downloadAllDebtsPdf = downloadAllDebtsPdf;
    window.downloadAllProfilesPdf = downloadAllProfilesPdf;
    window.backupData = backupData;
    window.restoreData = restoreData;
    window.saveExpense = saveExpense;
    window.loadAdminExpensesTable = loadAdminExpensesTable;
    window.deleteExpense = deleteExpense;
    window.toggleExpensesVisibility = toggleExpensesVisibility;
    window.calculateAndShowBalance = calculateAndShowBalance;
    window.editUserProfileAsAdmin = editUserProfileAsAdmin;
    window.deleteUserProfileAsAdmin = deleteUserProfileAsAdmin;


    // --- Uygulama Başlangıcı ---
    loadAuthDataFromFirebase();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
